<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Alice Casino - Loan System Fixed</title>
<style>
    @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Noto+Serif+TC:wght@400;700&display=swap');

    :root {
        --bg: #050505;
        --gold: #d4af37;
        --gold-glow: rgba(212, 175, 55, 0.5);
        --red: #c0392b;
    }

    * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }

    body {
        margin: 0; padding: 0;
        background: linear-gradient(to bottom, #000000 0%, #1a0000 60%, #3a0000 100%);
        color: #eee;
        font-family: 'Noto Serif TC', serif;
        height: 100vh; width: 100vw;
        overflow: hidden;
        display: flex; flex-direction: column;
    }

    /* --- HUD --- */
    #hud {
        position: fixed; top: 0; left: 0; width: 100%; height: 60px;
        display: flex; justify-content: space-between; align-items: center;
        padding: 0 15px; z-index: 500;
        background: linear-gradient(to bottom, rgba(0,0,0,0.95), transparent);
        pointer-events: none;
    }
    .hud-btn {
        pointer-events: auto; background: rgba(0,0,0,0.6); border: 1px solid var(--gold);
        color: var(--gold); width: 36px; height: 36px; border-radius: 50%;
        display: flex; justify-content: center; align-items: center; cursor: pointer;
    }
    .score-board {
        font-family: 'Cinzel'; color: var(--gold); font-size: 1.1rem;
        background: #000; padding: 5px 15px; border-radius: 20px;
        border: 1px solid #444; box-shadow: 0 0 10px rgba(212,175,55,0.2); pointer-events: auto; cursor: pointer;
    }

    /* --- Screens --- */
    .screen {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        display: none; flex-direction: column; z-index: 10;
        padding-top: 60px; 
    }
    .screen.active { display: flex; animation: fadeIn 0.3s; }

    /* --- Menu --- */
    .menu-content { flex: 1; padding: 20px; overflow-y: auto; text-align: center; }
    .brand { font-family: 'Cinzel'; font-size: 2rem; color: var(--gold); text-shadow: 0 0 15px var(--gold); margin-bottom: 20px; }
    
    .game-card {
        background: linear-gradient(135deg, #1a0a0a, #000);
        border: 1px solid #333; border-left: 4px solid #555;
        padding: 20px; margin-bottom: 15px; cursor: pointer; transition: 0.2s;
        text-align: left; position: relative;
    }
    .game-card:active { transform: scale(0.98); border-color: var(--gold); }
    .game-name { font-family: 'Cinzel'; font-size: 1.2rem; color: #eee; }
    .game-desc { font-size: 0.8rem; color: #888; margin-top: 5px; }

    /* --- Lobby --- */
    .char-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-top: 20px; padding-bottom: 40px;}
    .char-item {
        display: flex; flex-direction: column; align-items: center;
        opacity: 0.5; transition: 0.2s; cursor: pointer;
        border: 2px solid transparent; border-radius: 8px; padding: 5px;
    }
    .char-item.selected { 
        opacity: 1; transform: scale(1.05);
        background: rgba(212, 175, 55, 0.1); border-color: var(--gold);
    }
    .char-avatar { width: 56px; height: 56px; border-radius: 50%; object-fit: cover; border: 2px solid #333; background: #000; }
    .char-item.selected .char-avatar { border-color: var(--gold); box-shadow: 0 0 10px var(--gold); }
    .char-name { font-size: 0.6rem; color: #aaa; margin-top: 4px; text-align: center; white-space: nowrap; overflow: hidden; width: 100%;}
    
    .lobby-btn {
        margin-top: auto; padding: 15px; background: var(--gold); border: none; width: 100%;
        font-family: 'Cinzel'; font-weight: bold; font-size: 1.1rem; cursor: pointer;
    }
    .lobby-btn:disabled { background: #333; color: #666; }

    /* --- Loan Screen --- */
    .loan-list { display: flex; flex-direction: column; gap: 15px; padding: 20px; }
    .loan-item { 
        background: #111; border: 1px solid #444; padding: 15px; display: flex; align-items: center; gap: 15px; 
        cursor: pointer; transition: 0.2s;
    }
    .loan-item:hover { border-color: var(--gold); background: #1a1a1a; }
    .loan-info { flex: 1; }
    .loan-name { color: var(--gold); font-weight: bold; }
    .loan-desc { font-size: 0.8rem; color: #888; }

    /* --- Game Area --- */
    .game-area { flex: 1; display: flex; flex-direction: column; position: relative; }

    .status-bar {
        text-align: center; font-family: 'Cinzel'; font-size: 0.9rem; color: #aaa;
        padding: 5px; background: rgba(0,0,0,0.5); min-height: 30px; margin-top: 10px;
    }

    .opponents-row { height: 170px; position: relative; width: 100%; margin-top: 50px; }
    .seat { position: absolute; width: 80px; display: flex; flex-direction: column; align-items: center; transition: 0.3s; }
    .seat[data-pos="0"] { left: 15px; top: 30px; }
    .seat[data-pos="1"] { left: 50%; transform: translateX(-50%); top: 0px; }
    .seat[data-pos="2"] { right: 15px; top: 30px; }
    
    .op-avatar { width: 56px; height: 56px; border-radius: 50%; border: 2px solid #444; object-fit: cover; background: #000; z-index: 10; }
    .seat.active .op-avatar { border-color: var(--gold); box-shadow: 0 0 15px var(--gold); transform: scale(1.1); }
    
    .bubble {
        position: absolute; top: -45px; 
        background: #fff; color: #000; padding: 6px 10px; border-radius: 12px;
        font-size: 0.75rem; font-weight: bold; min-width: 90px; text-align: center;
        opacity: 0; pointer-events: none; transition: 0.3s; z-index: 100;
        box-shadow: 0 4px 10px rgba(0,0,0,0.8); white-space: nowrap;
    }
    .bubble::after {
        content: ''; position: absolute; bottom: -5px; left: 50%; transform: translateX(-50%);
        border-width: 5px 5px 0; border-style: solid; border-color: #fff transparent;
    }
    .bubble.show { opacity: 1; transform: translateY(-5px); }

    .mini-hand-container { display: flex; justify-content: center; margin-top: 5px; height: 20px; width: 100%; z-index: 5; }
    .mini-card { width: 14px; height: 20px; background: #8a0303; border: 1px solid #fff; border-radius: 2px; margin-left: -8px; box-shadow: 1px 1px 2px #000; }
    .mini-card:first-child { margin-left: 0; }

    .count-badge { position: absolute; bottom: -5px; right: 0; z-index: 20; background: #000; border: 1px solid var(--gold); color: #fff; font-family: 'Cinzel'; font-size: 0.8rem; padding: 1px 6px; border-radius: 10px; }
    .dealer-score { position: absolute; top: 0; left: -15px; z-index: 20; background: #a00; color: #fff; border: 1px solid #f00; font-family: 'Cinzel'; font-size: 0.8rem; padding: 2px 6px; border-radius: 4px; display: none; box-shadow: 0 0 5px #f00; }

    .table-center { flex: 1; position: relative; display: flex; justify-content: center; align-items: center; flex-direction: column; }
    .msg-large { position: absolute; font-family: 'Cinzel'; font-size: 2rem; color: var(--gold); text-shadow: 0 0 20px #000; pointer-events: none; opacity: 0; transition: 0.3s; z-index: 100; background: rgba(0,0,0,0.8); padding: 10px 30px; border: 1px solid var(--gold); }
    .msg-large.show { opacity: 1; transform: scale(1.1); }

    .player-area { background: linear-gradient(to top, #000 90%, transparent); padding-bottom: 20px; display: flex; flex-direction: column; justify-content: flex-end; position: relative; }
    .bj-score-badge { position: absolute; top: -30px; left: 50%; transform: translateX(-50%); background: #000; border: 1px solid var(--gold); color: var(--gold); padding: 5px 15px; border-radius: 15px; font-family: 'Cinzel'; font-weight: bold; box-shadow: 0 0 10px var(--gold-glow); display: none; }

    .controls { display: flex; justify-content: center; gap: 20px; margin-bottom: 10px; height: 45px; z-index: 20; }
    .btn-act { background: var(--gold); color: #000; border: none; padding: 0 40px; font-family: 'Cinzel'; font-weight: bold; border-radius: 25px; opacity: 0; pointer-events: none; transition: 0.3s; box-shadow: 0 0 15px var(--gold-glow); }
    .btn-act.show { opacity: 1; pointer-events: auto; }
    .btn-pass { background: #333; color: #ccc; box-shadow: none; border: 1px solid #555; }

    .my-hand { display: flex; align-items: flex-end; height: 130px; padding: 10px 20px; overflow-x: auto; justify-content: flex-start; -webkit-overflow-scrolling: touch; }
    .my-hand.few-cards { justify-content: center; }

    .card { width: 76px; height: 106px; background: #fff; border-radius: 6px; position: relative; display: flex; flex-direction: column; justify-content: flex-start; align-items: flex-start; padding: 5px; font-family: 'Arial'; font-weight: bold; border: 1px solid #ccc; box-shadow: -2px 0 5px rgba(0,0,0,0.3); flex-shrink: 0; margin-right: -45px; transition: transform 0.2s, margin 0.2s; cursor: pointer; }
    .card:last-child { margin-right: 0; }
    .card.selected { transform: translateY(-25px); border: 2px solid var(--gold); z-index: 100; margin-right: -20px; }
    .card-corner { display: flex; flex-direction: column; align-items: center; line-height: 1; font-size: 1.2rem; }
    .card-center-suit { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 2.5rem; opacity: 0.2; pointer-events: none; }
    .card.red { color: var(--red); } .card.black { color: #000; }
    .card.back { background: #1a0505; border: 2px solid #8a7538; background-image: repeating-linear-gradient(45deg, #111 0, #111 2px, #2a0a0a 2px, #2a0a0a 8px); }

    /* Result & Loan Modal */
    .result-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 1000; display: none; flex-direction: column; align-items: center; justify-content: center; animation: fadeIn 0.5s; }
    .res-title { font-family: 'Cinzel'; font-size: 3rem; color: var(--gold); margin-bottom: 10px; }
    .res-val { font-size: 1.2rem; color: #fff; margin-bottom: 40px; font-family: 'Arial'; text-align: center; line-height: 1.5; }
    .res-btns { display: flex; gap: 20px; }
    .btn-res { padding: 10px 30px; border: 1px solid var(--gold); background: transparent; color: var(--gold); font-family: 'Cinzel'; cursor: pointer; }
    .btn-res:hover { background: var(--gold); color: #000; }

    /* Loan Specific */
    .loan-dialogue { background: #111; border: 1px solid var(--gold); padding: 20px; border-radius: 10px; max-width: 80%; text-align: center; }
    .loan-opt { margin-top: 10px; padding: 10px; background: #333; color: #fff; cursor: pointer; border-radius: 5px; }
    .loan-opt:hover { background: var(--gold); color: #000; }

    @keyframes fadeIn { from {opacity:0} to {opacity:1} }

</style>
</head>
<body onclick="ensureAudio()">

<audio id="bgm" loop>
    <source src="https://files.catbox.moe/zqmn32.mp3" type="audio/mpeg">
</audio>
<audio id="sfx-card" src="https://files.catbox.moe/0bdvj7.mp3"></audio>
<audio id="sfx-win" src="https://files.catbox.moe/rfy681.mp3"></audio>

<div id="hud">
    <div class="hud-btn" id="btn-bgm" onclick="toggleBGM(event)">â™«</div>
    <div class="score-board" onclick="openLoanScreen()">â™¦ <span id="ui-score">10,000</span> <span style="font-size:0.8rem;color:#888">(å€Ÿæ¬¾)</span></div>
    <div class="hud-btn" onclick="goHome()">âŒ‚</div>
</div>

<div id="screen-menu" class="screen active">
    <div class="menu-content">
        <div class="brand">ALICE CASINO</div>
        
        <div style="display:flex; justify-content:center; gap:20px; margin-bottom:20px">
            <div style="text-align:center"><div style="font-size:1.5rem" id="stat-wins">0</div><div style="font-size:0.7rem;color:#888">WINS</div></div>
            <div style="text-align:center"><div style="font-size:1.5rem" id="stat-losses">0</div><div style="font-size:0.7rem;color:#888">LOSSES</div></div>
        </div>
        <div class="game-card" onclick="goToLobby('redblack')"><div class="game-name">RED or BLACK</div><div class="game-desc">1 å°æ‰‹ | é‹æ°£åšå¼ˆ</div></div>
        <div class="game-card" onclick="goToLobby('blackjack')"><div class="game-name">BLACKJACK</div><div class="game-desc">1 å°æ‰‹ | 21 é»</div></div>
        <div class="game-card" onclick="goToLobby('oldmaid')"><div class="game-name">OLD MAID</div><div class="game-desc">4 äººå±€ | æŠ½é¬¼ç‰Œ</div></div>
        <div class="game-card" onclick="goToLobby('bigtwo')"><div class="game-name">BIG TWO</div><div class="game-desc">4 äººå±€ | å¤§è€äºŒ</div></div>
    </div>
</div>

<div id="screen-lobby" class="screen">
    <div class="menu-content">
        <h2 style="color:var(--gold); font-family:'Cinzel'">GUEST LIST</h2>
        <div id="lobby-hint" style="font-size:0.8rem; color:#888">SELECT OPPONENTS</div>
        <div class="char-grid" id="char-grid"></div>
        <button class="lobby-btn" id="btn-start" disabled onclick="initGame()">START GAME</button>
    </div>
</div>

<div id="screen-loan" class="screen">
    <div class="menu-content">
        <h2 style="color:var(--gold)">BANK</h2>
        <p style="color:#888; font-size:0.8rem">é¸æ“‡å°è±¡é€²è¡Œå€Ÿæ¬¾å”å•†</p>
        <div class="loan-list" id="loan-list"></div>
        <button class="lobby-btn" onclick="switchScreen('screen-menu')">BACK</button>
    </div>
</div>

<div id="screen-game" class="screen">
    <div class="status-bar" id="status-bar">GAME START</div>
    <div class="game-area">
        <div class="opponents-row" id="seat-container"></div>
        <div class="table-center">
            <div class="msg-large" id="msg-large">START</div>
            <div id="table-cards" style="display:flex; justify-content:center; gap:5px; flex-wrap:wrap"></div>
        </div>
        <div class="player-area">
            <div class="bj-score-badge" id="bj-score">0</div>
            <div class="controls">
                <button class="btn-act btn-pass" id="btn-pass">PASS</button>
                <button class="btn-act" id="btn-play">PLAY</button>
            </div>
            <div class="my-hand" id="player-hand"></div>
        </div>
    </div>
</div>

<div id="modal-result" class="result-modal">
    <div class="res-title" id="res-title">VICTORY</div>
    <div class="res-val" id="res-msg">Info</div>
    <div class="res-btns">
        <button class="btn-res" onclick="goHome()">MENU</button>
        <button class="btn-res" onclick="initGame()">REPLAY</button>
    </div>
</div>

<div id="modal-loan" class="result-modal">
    <div class="loan-dialogue">
        <img id="loan-avatar" style="width:80px;height:80px;border-radius:50%;border:2px solid var(--gold);margin-bottom:10px">
        <div id="loan-text" style="color:#fff;margin-bottom:20px;font-style:italic">"..."</div>
        <div id="loan-options"></div>
    </div>
</div>


<script>
/* --- DATA --- */
const CHARS = [
    { 
        id: 'xiaomu', name: 'å°ç›®', img: 'https://i.meee.com.tw/IHt74xD.png', 
        lines: { start: ["ç¸½è£çš„é­„åŠ›ã€‚", "èŒ‰è‰å¹«æˆ‘è¨˜éŒ„ã€‚"], play: ["æŠ•è³‡ã€‚", "æˆ°ç•¥ã€‚", "All inã€‚"], win: ["å…¨å ´è²·å–®ã€‚", "ç†æ‰€ç•¶ç„¶ã€‚"], lose: ["æˆ°æé¢¨ã€‚", "é›¶éŒ¢è€Œå·²ã€‚"] },
        loanStages: [
            { text: "è³‡é‡‘éŠæ–·è£‚äº†ï¼Ÿæˆ‘å¯ä»¥æ³¨è³‡ï¼Œä½†æˆ‘è¦è½å¯¦è©±ã€‚", opts: [{t:"é€™æ˜¯æˆ°ç•¥æ€§è™§æã€‚", next:1}, {t:"æ±‚æ±‚ä½ å€Ÿæˆ‘éŒ¢ï¼", next:-1}] },
            { text: "å“¼ï¼Œæœ‰æ„æ€ã€‚ä½ çš„æ“”ä¿æ˜¯ä»€éº¼ï¼Ÿ", opts: [{t:"æˆ‘æ˜¯ç‚ºäº†èŒ‰è‰æ‰ç©çš„ã€‚", next:2}, {t:"æˆ‘æœƒé‚„ä½ å…©å€ã€‚", next:-1}] },
            { text: "çœ‹åœ¨èŒ‰è‰çš„ä»½ä¸Š...é€™å«å¤©ä½¿æŠ•è³‡ã€‚", reward: 5000 }
        ]
    },
    { 
        id: 'venato', name: 'ç¶­ç´æ‰˜', img: 'https://i.meee.com.tw/HAvzdTj.png', 
        lines: { start: ["æµé«”åŠ›å­¸æº–å‚™å°±ç·’ã€‚", "è®“ä½ å€‘è¦‹è­˜å¤©æ‰ã€‚"], play: ["è¨ˆç®—å®Œç•¢ã€‚", "å¿…ç„¶çš„çµæœã€‚"], win: ["è®šç¾æœ¬ç‹å§ï¼", "é€™å°±æ˜¯ç§‘å­¸ã€‚"], lose: ["å…¬å¼...éŒ¯äº†ï¼Ÿ", "ä¸ç§‘å­¸ï¼"] },
        loanStages: [
            { text: "æˆ‘çš„è¨ˆç®—ä¸­æ²’æœ‰ã€å€ŸéŒ¢çµ¦ä½ ã€é€™å€‹è®Šé‡ã€‚", opts: [{t:"é€™æ˜¯ç‚ºäº†é©—è­‰æ··æ²Œç†è«–ã€‚", next:1}, {t:"å¤§å®¶éƒ½æ˜¯æœ‹å‹å˜›ã€‚", next:-1}] },
            { text: "æ··æ²Œç†è«–ï¼Ÿä½ æ˜¯èªªæ©Ÿç‡çš„ä¸å¯é æ¸¬æ€§ï¼Ÿ", opts: [{t:"æ²’éŒ¯ï¼Œé€™æ˜¯å¯¦é©—ç¶“è²»ã€‚", next:-1}, {t:"æˆ‘å°±æƒ³è³­ä¸€æŠŠã€‚", next:2}] },
            { text: "å¥½å§ï¼Œæœ¬ç‹çœ‹åœ¨ä½ èª å¯¦çš„ä»½ä¸Šã€‚", reward: 3000 }
        ]
    },
    { 
        id: 'lanlan', name: 'è˜­è˜­', img: 'https://i.meee.com.tw/wgADv31.png', 
        lines: { start: ["å¥½è€¶ï¼ç©éŠæˆ²ï¼", "é€™å¼µç‰Œçœ‹èµ·ä¾†å¾ˆå¥½åƒå‘€ï¼"], play: ["åƒæˆ‘ä¸€æ“Šï¼", "å˜¿å’»ï¼", "é€™å¼µå¤§ç‰Œå‘€ï¼"], win: ["å¶ºä¸Šé–‹èŠ±ï¼å“ˆå“ˆï¼", "æˆ‘æ˜¯å¤©æ‰å‘€ï¼"], lose: ["å“å‘€ï¼è¼¸äº†å‘€ï¼", "æ²’é—œä¿‚æˆ‘æœ‰éŒ¢å‘€ï¼"] },
        loanStages: [
            { text: "ä½ è¦éŒ¢å—ï¼Ÿæˆ‘æœ‰å¥½å¤šå‘€ï¼ä½ è¦æ‹¿å»è²·ä»€éº¼ï¼Ÿ", opts: [{t:"è²·çµ¦å–¬è«¾å¨œçš„ç¦®ç‰©ã€‚", next:1}, {t:"å»è³­åšã€‚", next:-1}] },
            { text: "çµ¦å–¬è«¾å¨œçš„ï¼Ÿå¥½è€¶ï¼é‚£ä½ è¦è²·ä»€éº¼ï¼Ÿ", opts: [{t:"è¡£æœã€‚", next:2}, {t:"æ¯å­ã€‚", next:-1}] },
            { text: "å¤ªæ£’äº†ï¼æ‹¿å»æ‹¿å»ï¼", reward: 4000 }
        ]
    },
    { 
        id: 'peter', name: 'å½¼å¾—', img: 'https://i.meee.com.tw/PJOElT9.png', 
        lines: { start: ["é€™åœ°æ–¹é¢¨æ°´ä¸å¥½ã€‚", "æˆ‘çœ‹è¦‹äº†æ­»è’¼è …...", "ç´…è‰²ï¼Œå¤§å‰ã€‚"], play: ["ç¥ä¹‹æŒ‡å¼•ã€‚", "é©…é‚ªã€‚", "é€™å¼µæ˜¯å¤§å‰ã€‚"], win: ["ç¥è¹Ÿé™è‡¨ã€‚", "æœç„¶ç´…è‰²æ˜¯å‰åˆ©çš„ã€‚"], lose: ["å‡¶å…†...", "é€™è£¡ç£å ´ä¸å°ã€‚", "æˆ‘è¦æŠŠé€™è£¡ç‡’äº†ã€‚"] },
        loanStages: [
            { text: "é€™ç­†éŒ¢æµå‘ä½ ï¼Œæˆ‘çœ‹è¦‹äº†å‡¶å…†ã€‚", opts: [{t:"æˆ‘æœƒæ‹¿å»æçµ¦æ•™æœƒã€‚", next:1}, {t:"æˆ‘è¦é€†å¤©æ”¹å‘½ã€‚", next:-1}] },
            { text: "æ•™æœƒï¼Ÿä½ ç¢ºå®šä¸æ˜¯å»è³­å ´ï¼Ÿ", opts: [{t:"æˆ‘ç™¼èª“ï¼Œç‚ºäº†è´–ç½ªã€‚", next:2}, {t:"å‘ƒ...", next:-1}] },
            { text: "å¥½å§ï¼Œé¡˜ä¸»ä¿ä½‘ä½ ã€‚", reward: 2000 }
        ]
    },
    { 
        id: 'lynn', name: 'æ—æ©', img: 'https://i.meee.com.tw/kxAllct.png', 
        lines: { start: ["å¥½ç...æƒ³åƒæŠ«è–©ã€‚", "å½¼å¾—åˆ¥å”¸äº†ã€‚"], play: ["å¥½éº»ç…©...", "éš¨ä¾¿å•¦ã€‚", "æ‹¿å»æ‹¿å»ã€‚", "æ¶¼æ‹Œã€‚"], win: ["èƒ½ä¸‹ç­äº†å—ï¼Ÿ", "å¤å¨å¤·æŠ«è–©åŠ å€ï¼"], lose: ["æ¶¼æ‹Œã€‚", "è¼¸äº†...å¥½éº»ç…©ã€‚"] },
        loanStages: [
            { text: "å¥½éº»ç…©...éŒ¢åœ¨å£è¢‹è£¡ï¼Œè‡ªå·±æ‹¿...", opts: [{t:"(æ‹¿èµ°éŒ¢)", next:2}, {t:"å¹«ä½ è²·æŠ«è–©ã€‚", next:1}] },
            { text: "æŠ«è–©ï¼Ÿè¦å¤å¨å¤·å£å‘³çš„ã€‚", opts: [{t:"æ²’å•é¡Œã€‚", next:2}, {t:"é³³æ¢¨æ˜¯é‚ªæ•™ã€‚", next:-1}] },
            { text: "Zzz... (ä½ æ‹¿åˆ°äº†éŒ¢)", reward: 660 }
        ]
    },
    { 
        id: 'aura', name: 'å¥§æ‹‰', img: 'https://i.meee.com.tw/SCMPHmm.png', 
        lines: { start: ["è®Šé‡é–å®šã€‚", "é–‹å§‹è¨˜éŒ„ã€‚", "ä¸æ˜¯èœœæ‹‰æ€å°±åˆ¥ä½œå¼Šã€‚"], play: ["æœ€å„ªè§£ã€‚", "åŸ·è¡Œã€‚", "æ ¹æ“šæ¨¡å‹é æ¸¬..."], win: ["æ•¸æ“šä¸æœƒèªªè¬Šã€‚", "æ„æ–™ä¹‹ä¸­ã€‚"], lose: ["ç•°å¸¸æ•¸æ“šã€‚", "æ··æ²Œã€‚"] },
        loanStages: [
            { text: "è²¸æ¬¾ï¼Ÿè«‹æä¾›æŠµæŠ¼å“ã€‚", opts: [{t:"æˆ‘çš„éˆé­‚ã€‚", next:1}, {t:"ä¸‹æ¬¡é‚„ä½ ã€‚", next:-1}] },
            { text: "éˆé­‚...æœ‰è¶£çš„è®Šé‡ã€‚ç°½ä¸‹é€™ä»½å¥‘ç´„ã€‚", opts: [{t:"(ç°½å)", next:2}, {t:"å¤ªå±éšªäº†ã€‚", next:-1}] },
            { text: "å¥‘ç´„æˆç«‹ã€‚åˆ¥è®“æ•¸æ“šå¤±æœ›ã€‚", reward: 30000 }
        ]
    },
    { 
        id: 'mollie', name: 'èŒ‰è‰', img: 'https://i.meee.com.tw/yUTV61e.png', 
        lines: { start: ["é™ªå¤§å®¶ç©ç©ã€‚"], play: ["æº«æŸ”ä¸€é»ã€‚"], win: ["å¤ªå¥½äº†ã€‚"], lose: ["æ²’äº‹çš„ã€‚"] },
        loanStages: [ { text: "ä½ é‚„å¥½å—ï¼Ÿ", opts:[{t:"æ˜¯çš„é†«ç”Ÿï¼Œæˆ‘ç ´ç”¢äº†ã€‚", next:1}, {t:"ä¸ç”¨ã€‚", next:-1}], }, { text: "å‘ƒå¥½å§ï¼Œé€™é»éŒ¢æ‹¿å»æ€¥ç”¨å§ã€‚", reward: 800 } ]
    },
    { 
        id: 'jonona', name: 'å–¬è«¾å¨œ', img: 'https://i.meee.com.tw/duMFdPy.png', 
        lines: { start: ["æˆ‘æœƒåŠªåŠ›çš„ï¼"], play: ["åˆ¥ç”Ÿæ°£å–”..."], win: ["å¤ªå¥½äº†ï¼"], lose: ["å—šå—š..."] },
        loanStages: [ { text: "æˆ‘ã€æˆ‘ä¹Ÿæ²’ä»€éº¼éŒ¢...ä½†æˆ‘å¯ä»¥åˆ†ä½ ä¸€é»ã€‚", opts:[{t:"è¬è¬ä½ ï¼", next:1}, {t:"å¤ªå°‘äº†ã€‚", next:-1}], }, { text: "åŠ æ²¹å–”...", reward: 500 } ]
    },
    { 
        id: 'hades', name: 'å†¥ç¥', img: 'https://i.meee.com.tw/dhxSvcN.png', 
        lines: { start: ["..."], play: ["..."], win: ["..."], lose: ["..."] },
        loanStages: [ { text: "...", opts:[{t:"(ä¼¸å‡ºæ‰‹)", next:1}, {t:"(è½‰èº«é›¢é–‹)", next:-1}], }, { text: "...", reward: 300 } ]
    },
    { 
        id: 'poseidon', name: 'æµ·ç¥', img: 'https://meee.com.tw/YWjKSUI.png', 
        lines: { start: ["å¤©å¤©é–‹å¿ƒï¼"], play: ["å¥½ç©ï¼"], win: ["æˆ‘æ˜¯åœ‹ç‹ï¼"], lose: ["æ²’äº†å—ï¼Ÿ"] },
        loanStages: [ { text: "å“ˆå“ˆï¼éŒ¢æ˜¯ä»€éº¼ï¼Ÿå¤§é»‘æœ‰ï¼", opts:[{t:"é‚£æˆ‘å»æ‰¾å¤§é»‘ã€‚", next:1}, {t:"å€Ÿæˆ‘å•¦ï¼", next:-1}], }, { text: "å¤§é»‘èªªä¸è¡Œï¼Œä½†æˆ‘å·æ‹¿çµ¦ä½ ï¼", reward: 20 } ]
    },
    { 
        id: 'miras', name: 'èœœæ‹‰æ€', img: 'https://i.meee.com.tw/EQxAIYg.png', 
        lines: { start: ["é€™æ˜¯é­”è¡“ã€‚"], play: ["å¹»è¦ºã€‚"], win: ["èŠå®¶é€šåƒã€‚"], lose: ["æ‰‹æ»‘äº†ã€‚"] },
        loanStages: [ { text: "æƒ³è¦è®Šå‡ºéŒ¢å—ï¼Ÿ", opts:[{t:"æ•™æˆ‘ï¼", next:-1}, {t:"å€Ÿæˆ‘ä¸€é»å°±å¥½ã€‚", next:1}], }, { text: "ä¸è¦ã€‚æˆ‘æ²’äº‹ä¹Ÿä¸æœƒå€Ÿä½ éŒ¢ã€‚", reward: 0 } ]
    },
    { 
        id: 'narcissus', name: 'ç´å¸Œç‘Ÿæ–¯', img: 'https://i.meee.com.tw/kvfcmWP.png', 
        lines: { start: ["ç‚ºäº†ç¶­ç´æ‰˜å…ˆç”Ÿï¼"], play: ["æ„›çš„ç›´è¦ºã€‚"], win: ["æ„›çš„åŠ›é‡ï¼"], lose: ["åªè¦ç¶­ç´æ‰˜å…ˆç”Ÿé–‹å¿ƒ..."] },
        loanStages: [ { text: "æˆ‘çš„éŒ¢éƒ½æ˜¯ç•™çµ¦ç¶­ç´æ‰˜å…ˆç”Ÿçš„ã€‚", opts:[{t:"æ˜¯ä»–è®“æˆ‘ä¾†æ‹¿çš„ã€‚", next:1}, {t:"å€Ÿä¸€é»å˜›ã€‚", next:-1}], }, { text: "çœŸçš„å—ï¼ç¶­ç´æ‰˜å…ˆç”Ÿéœ€è¦å¤šå°‘ï¼Ÿå…¨æ‹¿å»ï¼", reward: 6000 } ]
    }
];

const CP_PAIRS = [
    { a: 'venato', b: 'narcissus', linesA: ["ç´è¥¿ï¼Œçœ‹å¥½äº†ã€‚", "å“¼ï¼Œé‚„ç®—è¯éº—ã€‚"], linesB: ["ç¶­ç´æ‰˜å…ˆç”Ÿï¼åŠ æ²¹ï¼", "ç¶­ç´æ‰˜å…ˆç”Ÿçœ‹æˆ‘ï¼"] },
    { a: 'xiaomu', b: 'mollie', linesA: ["èŒ‰è‰ä¸ç”¨æ“”å¿ƒã€‚", "ç‚ºäº†èŠ’æœã€‚"], linesB: ["å°ç›®åŠ æ²¹ã€‚", "æˆ‘çš„å¤§ç¸½è£ã€‚"] },
    { a: 'lanlan', b: 'jonona', linesA: ["å–¬è«¾å¨œæˆ‘ä¿è­·ä½ ï¼", "èª°æ•¢è´å–¬è«¾å¨œï¼"], linesB: ["è˜­è˜­...è¬è¬ä½ ...", "æœ‰è˜­è˜­åœ¨çœŸå¥½..."] },
    { a: 'peter', b: 'lynn', linesA: ["æ—æ©åç›´ï¼", "ä»Šæ—¥é‹å‹¢èªªè¦å‹¤å¥®ã€‚"], linesB: ["å½¼å¾—å¥½åµ...", "è´äº†å°±ä¸å”¸äº†å§ï¼Ÿ"] }
];

const RULES = {
    'redblack': {min:1, max:1}, 'blackjack': {min:1, max:1},
    'oldmaid': {min:3, max:3}, 'bigtwo': {min:3, max:3}
};

let App = { coins: 10000, wins: 0, losses: 0, gameId: '', selected: [], players: [], deck: [], turn: 0, bgm: false };

if(localStorage.getItem('alice_save_v13')) {
    const s = JSON.parse(localStorage.getItem('alice_save_v13'));
    App.coins = s.coins; App.wins = s.wins; App.losses = s.losses;
}
// Fix NaN
if(isNaN(App.coins)) App.coins = 10000;
updateUI();

/* --- CORE FUNCTIONS --- */

// ä¿®æ­£é‡é» 2: åŠ å…¥ç¢ºä¿ logicï¼Œåªåœ¨éŸ³æ¨‚æœªæ’­æ”¾æ™‚è§¸ç™¼ä¸€æ¬¡ï¼Œä¸¦æ–¼æˆåŠŸå¾Œç§»é™¤ç›£è½
function ensureAudio() { 
    if (!App.bgm) {
        toggleBGM();
    }
    // æˆåŠŸè§¸ç™¼å¾Œï¼Œç§»é™¤ body ä¸Šçš„ onclickï¼Œé¿å…æœªä¾†é»æ“Šç•«é¢ï¼ˆä¾‹å¦‚æš«åœå¾Œé»ç‰Œï¼‰å°è‡´éŸ³æ¨‚åˆè‡ªå‹•æ’­æ”¾
    document.body.removeAttribute('onclick');
}

function updateUI() {
    // Protect from Negative
    if(App.coins < 0) App.coins = 0;
    
    document.getElementById('ui-score').innerText = App.coins.toLocaleString();
    document.getElementById('stat-wins').innerText = App.wins;
    document.getElementById('stat-losses').innerText = App.losses;
    localStorage.setItem('alice_save_v13', JSON.stringify({coins:App.coins, wins:App.wins, losses:App.losses}));
}

// ä¿®æ­£é‡é» 3: æ¥æ”¶ event åƒæ•¸ï¼Œä¸¦ä½¿ç”¨ stopPropagation
function toggleBGM(e) {
    if(e) e.stopPropagation(); // é˜»æ­¢é»æ“Šäº‹ä»¶å†’æ³¡åˆ° body
    
    const a = document.getElementById('bgm');
    a.volume = 0.4;
    if(App.bgm) { a.pause(); document.getElementById('btn-bgm').style.opacity = 0.5; }
    else { a.play().catch(()=>{}); document.getElementById('btn-bgm').style.opacity = 1; }
    App.bgm = !App.bgm;
}
function sfx(id) { document.getElementById(id).currentTime=0; document.getElementById(id).play().catch(()=>{}); }

function switchScreen(id) {
    document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
    document.getElementById(id).classList.add('active');
}
function goHome() { 
    document.getElementById('modal-result').style.display = 'none';
    document.getElementById('modal-loan').style.display = 'none';
    switchScreen('screen-menu'); 
}
function goToLobby(gid) {
    App.gameId = gid; App.selected = []; renderLobby(); switchScreen('screen-lobby');
    ensureAudio();
}

/* --- LOAN SYSTEM (FIXED) --- */
let currentLoanChar = null; // è¨˜éŒ„ç•¶å‰å°è©±çš„è§’è‰²
let currentLoanIdx = 0;     // è¨˜éŒ„ç•¶å‰å°è©±é€²è¡Œåˆ°ç¬¬å¹¾éšæ®µ

function openLoanScreen() {
    switchScreen('screen-loan');
    const list = document.getElementById('loan-list');
    list.innerHTML = '';
    CHARS.forEach(c => {
        // åªé¡¯ç¤ºæœ‰ loanStages è¨­å®šçš„è§’è‰²
        if(!c.loanStages) return;
        
        const div = document.createElement('div');
        div.className = 'loan-item';
        // è¨ˆç®—é›£åº¦ï¼ˆé€™è£¡ç°¡å–®ç”¨éšæ®µæ•¸é‡ç•¶ä½œé›£åº¦ç¤ºæ„ï¼‰
        const diffStars = "â˜…".repeat(Math.min(c.loanStages.length, 5));
        
        div.innerHTML = `
            <img src="${c.img}" style="width:50px;height:50px;border-radius:50%;object-fit:cover">
            <div class="loan-info">
                <div class="loan-name">${c.name}</div>
                <div class="loan-desc">å”å•†é›£åº¦: ${diffStars}</div>
            </div>
        `;
        div.onclick = () => startLoanTalk(c);
        list.appendChild(div);
    });
}

function startLoanTalk(c) {
    currentLoanChar = c;
    currentLoanIdx = 0; // é‡ç½®å°è©±é€²åº¦
    
    const m = document.getElementById('modal-loan');
    m.style.display = 'flex';
    document.getElementById('loan-avatar').src = c.img;
    
    renderLoanStage();
}

function renderLoanStage() {
    const stage = currentLoanChar.loanStages[currentLoanIdx];
    const textField = document.getElementById('loan-text');
    const optsField = document.getElementById('loan-options');
    
    // æ›´æ–°å°è©±æ–‡å­—
    textField.innerText = stage.text;
    optsField.innerHTML = '';

    // åˆ¤æ–·æ˜¯å¦ç‚ºçå‹µçµç®—éšæ®µ
    if (stage.reward !== undefined) {
        const btn = document.createElement('div');
        btn.className = 'loan-opt';
        btn.style.borderColor = 'var(--gold)';
        btn.innerText = `[æ”¶ä¸‹æ¬¾é … $${stage.reward}]`;
        btn.onclick = () => {
            alert(`${currentLoanChar.name}çµ¦äº†ä½ éŒ¢ï¼ (ç²å¾— ${stage.reward})`);
            updateScore(stage.reward);
            document.getElementById('modal-loan').style.display = 'none';
        };
        optsField.appendChild(btn);
    } 
    // ä¸€èˆ¬å°è©±é¸é …éšæ®µ
    else if (stage.opts) {
        stage.opts.forEach(opt => {
            const btn = document.createElement('div');
            btn.className = 'loan-opt';
            btn.innerText = opt.t;
            btn.onclick = () => handleLoanChoice(opt.next);
            optsField.appendChild(btn);
        });
    }
}

function handleLoanChoice(nextIdx) {
    if (nextIdx === -1) {
        // å¤±æ•—é‚è¼¯
        alert(`${currentLoanChar.name}: æˆ‘æƒ³ä½ éœ€è¦åçœä¸€ä¸‹ã€‚ (å”å•†å¤±æ•—)`);
        document.getElementById('modal-loan').style.display = 'none';
    } else {
        // é€²å…¥ä¸‹ä¸€éšæ®µ
        currentLoanIdx = nextIdx;
        renderLoanStage();
    }
}

/* --- LOBBY --- */
function renderLobby() {
    const r = RULES[App.gameId];
    document.getElementById('lobby-hint').innerText = `SELECT ${r.min} GUEST(S)`;
    const g = document.getElementById('char-grid');
    g.innerHTML = '';
    CHARS.forEach(c => {
        const div = document.createElement('div');
        div.className = 'char-item';
        div.innerHTML = `<img class="char-avatar" src="${c.img}"><div class="char-name">${c.name}</div>`;
        div.onclick = () => toggleChar(div, c);
        g.appendChild(div);
    });
    checkLobby();
}

function toggleChar(div, c) {
    const idx = App.selected.indexOf(c);
    if(idx>-1) App.selected.splice(idx,1);
    else {
        if(App.selected.length < RULES[App.gameId].max) App.selected.push(c);
        else if(RULES[App.gameId].max===1) App.selected = [c];
    }
    renderLobbySelection();
    checkLobby();
}

function renderLobbySelection() {
    const cards = document.querySelectorAll('.char-item');
    cards.forEach((el) => {
        const charName = el.querySelector('.char-name').innerText;
        const isSel = App.selected.some(s => s.name === charName);
        if(isSel) el.classList.add('selected'); else el.classList.remove('selected');
    });
}

function checkLobby() {
    const r = RULES[App.gameId];
    document.getElementById('btn-start').disabled = !(App.selected.length >= r.min && App.selected.length <= r.max);
}

function triggerCPEvents() {
    CP_PAIRS.forEach(pair => {
        const p1 = App.players.find(p => !p.isUser && p.char.id === pair.a);
        const p2 = App.players.find(p => !p.isUser && p.char.id === pair.b);
        if (p1 && p2) {
            p1.char.lines.start = [...p1.char.lines.start, ...pair.linesA];
            p2.char.lines.start = [...p2.char.lines.start, ...pair.linesB];
        }
    });
}

function say(idx, type) {
    if(App.players[idx].isUser) return;
    const char = App.players[idx].char;
    const lines = char.lines[type];
    const text = lines[Math.floor(Math.random() * lines.length)];
    const el = document.querySelector(`#seat-${idx} .bubble`);
    if(el) {
        el.innerText = text;
        el.classList.add('show');
        setTimeout(() => el.classList.remove('show'), 2500);
    }
}

/* --- GAME SETUP --- */
function initGame() {
    document.getElementById('modal-result').style.display = 'none';
    switchScreen('screen-game');
    ensureAudio();

    App.players = [];
    App.selected.forEach(c => App.players.push({isUser:false, char:JSON.parse(JSON.stringify(c)), hand:[]}));
    App.players.push({isUser:true, char:null, hand:[]});

    triggerCPEvents();

    const area = document.getElementById('seat-container');
    area.innerHTML = '';
    const posMap = App.players.length===2 ? [1] : [0, 1, 2];
    
    for(let i=0; i<App.players.length-1; i++) {
        const p = App.players[i];
        const div = document.createElement('div');
        div.className = 'seat'; div.dataset.pos = posMap[i]; div.id = `seat-${i}`;
        
        let extraUI = '';
        if(App.gameId === 'oldmaid') extraUI = `<div class="mini-hand-container" id="mini-hand-${i}"></div>`;
        if(App.gameId === 'bigtwo') extraUI = `<div class="count-badge" id="b2-badge-${i}">13</div>`;
        if(App.gameId === 'blackjack') extraUI = `<div class="dealer-score" id="dealer-score">0</div>`;

        div.innerHTML = `
            <img class="op-avatar" src="${p.char.img}">
            ${extraUI}
            <div class="bubble"></div>
        `;
        area.appendChild(div);
        setTimeout(() => say(i, 'start'), i * 800 + 500);
    }

    document.getElementById('table-cards').innerHTML = '';
    document.getElementById('msg-large').className = 'msg-large';
    document.getElementById('bj-score').style.display = 'none';
    hideControls();
    setStatus("");

    if(App.gameId==='redblack') startRB();
    if(App.gameId==='blackjack') startBJ();
    if(App.gameId==='oldmaid') startOM();
    if(App.gameId==='bigtwo') startB2();
}

function updateOpponentVisuals() {
    for(let i=0; i<App.players.length-1; i++) {
        const p = App.players[i];
        if(App.gameId === 'oldmaid') {
            const c = document.getElementById(`mini-hand-${i}`);
            if(c) { c.innerHTML = ''; for(let j=0; j<p.hand.length; j++) c.innerHTML += `<div class="mini-card"></div>`; }
        }
        if(App.gameId === 'bigtwo') {
            const b = document.getElementById(`b2-badge-${i}`);
            if(b) b.innerText = p.hand.length;
        }
    }
}

/* --- RED OR BLACK --- */
function startRB() {
    updateScore(-500);
    setStatus("RED OR BLACK?");
    setControls("RED", "BLACK", ()=>resRB('red'), ()=>resRB('black'));
}
function resRB(pick) {
    hideControls();
    const isRed = Math.random()>0.5;
    const s = isRed ? (Math.random()>.5?'â™¥':'â™¦') : 'â™ ';
    const r = ['A','K','Q','J'][Math.floor(Math.random()*4)];
    renderTable([{s,r}]);
    sfx('sfx-card');
    const win = (pick==='red'&&isRed) || (pick==='black'&&!isRed);
    setTimeout(() => {
        if(win) { say(0,'lose'); showResult(true, 1000); }
        else { say(0,'win'); showResult(false, -500); }
    }, 1000);
}

/* --- BLACKJACK --- */
function startBJ() {
    updateScore(-500);
    App.deck = createDeck();
    App.players.forEach(p => p.hand=[App.deck.pop(), App.deck.pop()]);
    renderHand(); updateBJScore();
    setStatus("YOUR TURN");
    setControls("HIT", "STAND", bjHit, bjStand);
}
function bjVal(h) {
    let s=0,a=0; h.forEach(c=>{ if(['J','Q','K'].includes(c.r))s+=10; else if(c.r==='A'){s+=11;a++;} else s+=parseInt(c.r); });
    while(s>21 && a>0){s-=10;a--;} return s;
}
function updateBJScore() {
    const val = bjVal(App.players[1].hand);
    const el = document.getElementById('bj-score');
    el.style.display = 'block'; el.innerText = val;
    el.style.borderColor = val>21 ? 'red' : 'var(--gold)';
}
function bjHit() {
    App.players[1].hand.push(App.deck.pop());
    renderHand(); updateBJScore(); sfx('sfx-card');
    if(bjVal(App.players[1].hand)>21) { setStatus("BUST!"); setTimeout(()=>showResult(false, -500, "You Busted"), 1000); }
}
function bjStand() {
    hideControls();
    setStatus("OPPONENT TURN");
    const op = App.players[0];
    const loop = () => {
        const dScoreEl = document.getElementById('dealer-score');
        dScoreEl.style.display = 'block';
        dScoreEl.innerText = bjVal(op.hand);

        if(bjVal(op.hand)<17) {
            op.hand.push(App.deck.pop());
            say(0, 'play');
            setTimeout(loop, 1000);
        } else {
            const dVal = bjVal(op.hand);
            const uVal = bjVal(App.players[1].hand);
            renderTable(op.hand);
            dScoreEl.innerText = dVal; 
            setTimeout(() => {
                const msg = `Dealer: ${dVal} - You: ${uVal}`;
                if(dVal>21) { say(0,'lose'); showResult(true, 1000, msg + " (Dealer Bust)"); }
                else if(uVal > 21) { say(0,'win'); showResult(false, -500, msg); }
                else if(uVal > dVal) { say(0,'lose'); showResult(true, 1000, msg); }
                else if(uVal === dVal) { say(0,'play'); showResult('push', 500, msg + " (Push)"); } // PUSH: Refund
                else { say(0,'win'); showResult(false, -500, msg); }
            }, 1000);
        }
    };
    setTimeout(loop, 500);
}

/* --- OLD MAID --- */
function startOM() {
    let d = createDeck().slice(0,52); d.push({s:'ğŸ¤¡',r:'JK'});
    let i=0; while(d.length>0){ App.players[i].hand.push(d.pop()); i=(i+1)%4; }
    App.players.forEach(p=>cleanPairs(p.hand));
    renderHand(); updateOpponentVisuals();
    App.turn = 0; setStatus("GAME START");
    setTimeout(omTurn, 1500);
}
function cleanPairs(h) {
    const m={}; h.forEach(c=>m[c.r]=(m[c.r]||0)+1);
    for(let r in m){ if(m[r]>=2 && r!=='JK'){ let rem=0; for(let i=h.length-1;i>=0;i--){if(h[i].r===r && rem<2){h.splice(i,1);rem++;}} } }
}
function omTurn() {
    const active = App.players.filter(p=>p.hand.length>0);
    if(active.length<=1) {
        const uHas = App.players[3].hand.length>0;
        setTimeout(() => showResult(!uHas, uHas?-500:2000), 1000);
        return;
    }
    while(App.players[App.turn].hand.length===0) App.turn=(App.turn+1)%4;
    const pIdx = App.turn;
    const picker = App.players[pIdx];
    let tIdx = (pIdx-1+4)%4;
    while(App.players[tIdx].hand.length===0) tIdx=(tIdx-1+4)%4;
    const target = App.players[tIdx];

    document.querySelectorAll('.seat').forEach(s=>s.classList.remove('active'));
    if(pIdx<3) document.getElementById(`seat-${pIdx}`).classList.add('active');

    if(picker.isUser) {
        setStatus("YOUR TURN - PICK A CARD");
        const zone = document.getElementById('table-cards');
        zone.innerHTML = '';
        target.hand.forEach((c,i)=>{
            const el = document.createElement('div'); el.className='card back';
            el.onclick = ()=>omUserPick(target, i);
            zone.appendChild(el);
        });
    } else {
        setStatus(`${picker.char.name}'s TURN`);
        setTimeout(()=>{
            const r = Math.floor(Math.random()*target.hand.length);
            const c = target.hand.splice(r,1)[0];
            picker.hand.push(c);
            cleanPairs(picker.hand);
            if(target.isUser) renderHand();
            updateOpponentVisuals();
            say(pIdx, 'play');
            sfx('sfx-card');
            App.turn=(App.turn+1)%4;
            omTurn();
        }, 1200);
    }
}
function omUserPick(target, idx) {
    const c = target.hand.splice(idx,1)[0];
    App.players[3].hand.push(c);
    sfx('sfx-card');
    document.getElementById('table-cards').innerHTML = '';
    renderTable([c]); 
    cleanPairs(App.players[3].hand);
    renderHand(); updateOpponentVisuals();
    if(c.r==='JK') document.getElementById('msg-large').innerText="JOKER!";
    setTimeout(()=>{
        document.getElementById('table-cards').innerHTML = '';
        App.turn=(App.turn+1)%4;
        omTurn();
    }, 1000);
}

/* --- BIG TWO --- */
function startB2() {
    App.deck = createDeck();
    App.players.forEach(p=>p.hand=App.deck.splice(0,13));
    App.table = []; 
    let start=3; App.players.forEach((p,i)=>{if(p.hand.some(c=>c.val===0))start=i;});
    App.turn = start;
    renderHand(); updateOpponentVisuals();
    setStatus("GAME START");
    setTimeout(b2Turn, 1500);
}
function b2Turn() {
    if(App.players.some(p=>p.hand.length===0)) {
        const w = App.players.findIndex(p=>p.hand.length===0);
        setTimeout(() => showResult(w===3, w===3?2000:-500), 1000);
        return;
    }
    const pIdx = App.turn;
    const p = App.players[pIdx];
    document.querySelectorAll('.seat').forEach(s=>s.classList.remove('active'));
    if(pIdx<3) document.getElementById(`seat-${pIdx}`).classList.add('active');
    
    const top = App.table.length>0 ? App.table[App.table.length-1] : null;
    const free = !top || top.owner===pIdx;

    if(p.isUser) {
        setStatus("YOUR TURN");
        setControls("PLAY", "PASS", ()=>b2UserPlay(free, top), ()=>b2UserPass(free));
        document.getElementById('btn-pass').style.display = free ? 'none' : 'block';
    } else {
        setStatus(`${p.char.name}'s TURN`);
        setTimeout(()=>{
            p.hand.sort((a,b)=>a.val-b.val);
            let play = [];
            let pairs = [];
            for(let i=0; i<p.hand.length-1; i++) {
                if(p.hand[i].r === p.hand[i+1].r) pairs.push([p.hand[i], p.hand[i+1]]);
            }
            if(free) { play = pairs.length > 0 ? pairs[0] : [p.hand[0]]; }
            else {
                if(top.cards.length===1) {
                    const c = p.hand.find(x=>x.val>top.cards[0].val);
                    if(c) play=[c];
                } else if(top.cards.length===2) {
                    const pPair = pairs.find(pair => pair[1].val > top.cards[1].val); 
                    if(pPair) play=pPair;
                }
            }
            if(play.length>0) {
                p.hand = p.hand.filter(x=>!play.includes(x));
                App.table.push({cards:play, owner:pIdx});
                renderTable(play);
                say(pIdx, 'play');
                sfx('sfx-card');
            } else {
                say(pIdx, 'lose');
            }
            updateOpponentVisuals();
            App.turn=(App.turn+1)%4;
            b2Turn();
        }, 1000);
    }
}
function b2UserPlay(free, top) {
    const sel = App.players[3].hand.filter(c=>c.sel);
    if(sel.length===0) return;
    if(!free) {
        if(sel.length!==top.cards.length) { alert("Invalid Count"); return; }
        if(sel[sel.length-1].val <= top.cards[top.cards.length-1].val) { alert("Too Small"); return; }
        if(sel.length===2 && sel[0].r !== sel[1].r) { alert("Not a Pair"); return; }
    } else {
        if(sel.length===2 && sel[0].r !== sel[1].r) { alert("Not a Pair"); return; }
    }
    App.players[3].hand = App.players[3].hand.filter(c=>!c.sel);
    App.table.push({cards:sel, owner:3});
    renderTable(sel); renderHand(); hideControls(); sfx('sfx-card');
    App.turn=0; setTimeout(b2Turn,500);
}
function b2UserPass(free) {
    if(free) return;
    hideControls(); App.turn=0; b2Turn();
}

function createDeck() {
    const s=['â™£','â™¦','â™¥','â™ '], r=['3','4','5','6','7','8','9','10','J','Q','K','A','2'];
    let d=[]; s.forEach((ss,i)=>r.forEach((rr,j)=>d.push({s:ss,r:rr,val:j*4+i})));
    return d.sort(()=>Math.random()-0.5);
}
function updateScore(v) { App.coins+=v; updateUI(); }
function setStatus(t) { 
    const b=document.getElementById('status-bar'); b.innerText=t; b.classList.add('active'); 
    setTimeout(()=>b.classList.remove('active'),500);
}
function setControls(l1,l2,f1,f2) { const b1=document.getElementById('btn-play'), b2=document.getElementById('btn-pass'); b1.innerText=l1; b1.onclick=f1; b1.classList.add('show'); b2.innerText=l2; b2.onclick=f2; b2.classList.add('show'); }
function hideControls() { document.getElementById('btn-play').classList.remove('show'); document.getElementById('btn-pass').classList.remove('show'); }

function renderHand() {
    const d = document.getElementById('player-hand'); d.innerHTML='';
    const h = App.players[App.players.length-1].hand;
    if(App.gameId==='bigtwo') h.sort((a,b)=>a.val-b.val);
    d.className = h.length < 5 ? 'my-hand few-cards' : 'my-hand';
    h.forEach(c => {
        const el = document.createElement('div');
        el.className = `card ${['â™¥','â™¦'].includes(c.s)?'red':'black'}`;
        el.innerHTML = `<div class="card-corner"><div>${c.r}</div><div>${c.s}</div></div><div class="card-center-suit">${c.s}</div>`;
        if(c.sel) el.classList.add('selected');
        el.onclick = () => { c.sel=!c.sel; renderHand(); };
        d.appendChild(el);
    });
}
function renderTable(cards) {
    const d=document.getElementById('table-cards'); d.innerHTML='';
    cards.forEach(c=>{
        const el=document.createElement('div'); el.className=`card ${['â™¥','â™¦'].includes(c.s)?'red':'black'}`;
        el.innerHTML = `<div class="card-corner"><div>${c.r}</div><div>${c.s}</div></div><div class="card-center-suit">${c.s}</div>`;
        d.appendChild(el);
    });
}

function showResult(win, amt, msg="") {
    const m = document.getElementById('modal-result');
    if(win === 'push') {
        document.getElementById('res-title').innerText="PUSH"; 
        document.getElementById('res-title').style.color="#fff";
        updateScore(amt); // Refund
    } else if(win) { 
        App.wins++; document.getElementById('res-title').innerText="VICTORY"; 
        document.getElementById('res-title').style.color="var(--gold)"; 
        sfx('sfx-win'); 
        updateScore(amt);
    } else { 
        App.losses++; document.getElementById('res-title').innerText="DEFEAT"; 
        document.getElementById('res-title').style.color="#888"; 
        updateScore(amt); // Minus
    }
    
    let fullMsg = (amt>0?"+":"") + amt + " Coins";
    if(msg) fullMsg += `<br><span style='font-size:0.8rem;color:#aaa'>${msg}</span>`;
    document.getElementById('res-msg').innerHTML = fullMsg;
    updateUI();
    m.style.display = 'flex';
}
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Rabbit Casino - Soul & Skill Edition</title>
<style>
    @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Noto+Serif+TC:wght@400;700&display=swap');

    /* --- 核心變數 --- */
    :root {
        --bg: #050505;
        --gold: #d4af37;
        --gold-glow: rgba(212, 175, 55, 0.6);
        --red: #c0392b;
        --uno-red: #ff5555;
        --uno-yellow: #ffaa00;
        --uno-green: #55aa55;
        --uno-blue: #5555ff;
        --card-bg: #1a1a1a;
    }

    * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; -webkit-touch-callout: none; }

    body {
        margin: 0; padding: 0;
        background: linear-gradient(to bottom, #000000 0%, #1a0000 60%, #3a0000 100%);
        color: #eee;
        font-family: 'Noto Serif TC', serif;
        height: 100vh; width: 100vw;
        overflow: hidden;
        display: flex; flex-direction: column;
    }

    /* --- UNO 按鈕 --- */
    .fixed-uno-btn {
        position: absolute; right: 20px; bottom: 280px;
        width: 60px; height: 60px;
        background: radial-gradient(circle, #ff3333 0%, #990000 100%);
        border: 3px solid #fff; border-radius: 50%;
        color: white; font-family: 'Cinzel', serif; font-weight: bold; font-size: 1rem;
        display: none; align-items: center; justify-content: center;
        cursor: pointer; z-index: 50;
        box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        transition: all 0.3s ease; animation: pulseBtn 2s infinite;
    }
    .fixed-uno-btn:active { transform: scale(0.9); }
    .fixed-uno-btn.said {
        background: radial-gradient(circle, #55aa55 0%, #006600 100%);
        box-shadow: 0 0 10px #0f0; border-color: #ccc;
        animation: none; transform: scale(0.9); cursor: default;
    }
    @keyframes pulseBtn { 0%{box-shadow: 0 0 5px #f00;} 50%{box-shadow: 0 0 20px #f00;} 100%{box-shadow: 0 0 5px #f00;} }
    
    /* 玩家自己的 UNO 標記 */
    .player-uno-badge { 
        position: absolute; bottom: 140px; right: 20px; width: 40px; height: 40px; font-size: 0.8rem; 
        background: radial-gradient(circle, #ff0000 0%, #800000 100%); color: white; border-radius: 50%; 
        border: 2px solid #fff; display: none; align-items: center; justify-content: center; 
        font-weight: 900; font-family: 'Cinzel'; z-index: 25; box-shadow: 0 0 10px red; 
    }
    .player-uno-badge.show { display: flex; animation: pulseBadge 1s infinite alternate; }

    /* --- HUD --- */
    #hud {
        position: fixed; top: 0; left: 0; width: 100%; height: 60px;
        display: flex; justify-content: space-between; align-items: center;
        padding: 0 15px; z-index: 500;
        background: linear-gradient(to bottom, rgba(0,0,0,0.95), transparent);
        pointer-events: none;
    }
    .hud-btn { pointer-events: auto; background: rgba(0,0,0,0.6); border: 1px solid var(--gold); color: var(--gold); width: 36px; height: 36px; border-radius: 50%; display: flex; justify-content: center; align-items: center; cursor: pointer; transition: 0.3s; }
    .score-board { font-family: 'Cinzel'; color: var(--gold); font-size: 1.1rem; background: #000; padding: 5px 15px; border-radius: 20px; border: 1px solid #444; box-shadow: 0 0 10px rgba(212,175,55,0.2); pointer-events: auto; cursor: pointer; }

    /* --- Screens --- */
    .screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: none; flex-direction: column; z-index: 10; padding-top: 60px; }
    .screen.active { display: flex; animation: fadeIn 0.3s; }
    .menu-content { flex: 1; padding: 20px; overflow-y: auto; text-align: center; padding-bottom: 80px; }
    .brand { font-family: 'Cinzel'; font-size: 2rem; color: var(--gold); text-shadow: 0 0 15px var(--gold); margin-bottom: 20px; }
    
    .game-card { background: linear-gradient(135deg, #1a0a0a, #000); border: 1px solid #333; border-left: 4px solid #555; padding: 20px; margin-bottom: 15px; cursor: pointer; transition: 0.2s; text-align: left; position: relative; }
    .game-card:active { transform: scale(0.98); border-color: var(--gold); }
    .game-name { font-family: 'Cinzel'; font-size: 1.2rem; color: #eee; }
    .game-desc { font-size: 0.8rem; color: #888; margin-top: 5px; }

    /* --- Lobby --- */
    .char-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 20px; padding-bottom: 40px; }
    .char-item { display: flex; flex-direction: column; align-items: center; opacity: 0.5; transition: 0.2s; cursor: pointer; border: 2px solid transparent; border-radius: 8px; padding: 5px; position: relative; }
    .char-item.selected { opacity: 1; transform: scale(1.05); background: rgba(212, 175, 55, 0.1); border-color: var(--gold); }
    .char-avatar { width: 56px; height: 56px; border-radius: 50%; object-fit: cover; border: 2px solid #333; background: #000; pointer-events: none; }
    .char-item.selected .char-avatar { border-color: var(--gold); box-shadow: 0 0 10px var(--gold); }
    .char-name { font-size: 0.6rem; color: #aaa; margin-top: 4px; text-align: center; white-space: nowrap; overflow: hidden; width: 100%; pointer-events: none;}
    .lobby-btn { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 400px; padding: 15px; background: var(--gold); border: none; font-family: 'Cinzel'; font-weight: bold; font-size: 1.1rem; cursor: pointer; box-shadow: 0 0 15px var(--gold-glow); z-index: 100; }
    .lobby-btn:disabled { background: #333; color: #666; box-shadow: none; }
    .lobby-opt-container { margin-top: 20px; padding: 15px; background: #111; border: 1px solid #333; border-radius: 8px; text-align: left; margin-bottom: 60px;}
    .toggle-switch { display: flex; align-items: center; cursor: pointer; margin-top: 10px; margin-bottom: 10px; justify-content: space-between;}
    .toggle-switch input { display: none; }
    .slider { width: 40px; height: 20px; background: #333; border-radius: 20px; position: relative; transition: 0.3s; margin-left: 10px; flex-shrink: 0;}
    .slider::before { content: ''; position: absolute; width: 16px; height: 16px; background: #888; border-radius: 50%; top: 2px; left: 2px; transition: 0.3s; }
    input:checked + .slider { background: var(--gold); }
    input:checked + .slider::before { transform: translateX(20px); background: #fff; }

    /* --- Skill Modal --- */
    .skill-modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 3000; display: none; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.2s; }
    .skill-modal-overlay.show { display: flex; opacity: 1; pointer-events: auto; }
    .skill-card { width: 90%; max-width: 340px; background: linear-gradient(145deg, #150505, #0a0a0a); border: 2px solid var(--gold); border-radius: 16px; padding: 25px; text-align: center; box-shadow: 0 0 50px rgba(212,175,55,0.2); transform: scale(0.95); transition: transform 0.2s; display: flex; flex-direction: column; align-items: center; max-height: 85vh; overflow-y: auto; }
    .skill-modal-overlay.show .skill-card { transform: scale(1); }
    .skill-char-img-lg { width: 80px; height: 80px; border-radius: 50%; border: 3px solid var(--gold); object-fit: cover; margin-bottom: 15px; box-shadow: 0 0 20px var(--gold-glow); background: #000; }
    .skill-char-name-lg { font-family: 'Cinzel'; font-size: 1.5rem; color: var(--gold); margin-bottom: 10px; font-weight: bold; text-shadow: 0 2px 5px #000; }
    .skill-section { margin-top: 10px; width: 100%; text-align: left; background: rgba(255,255,255,0.03); padding: 12px; border-radius: 8px; border-left: 3px solid var(--gold); }
    .skill-title { font-size: 0.8rem; color: #888; font-weight: bold; margin-bottom: 4px; display: flex; justify-content: space-between; align-items: center;}
    .skill-name { font-size: 1rem; color: #fff; font-weight: bold; margin-bottom: 5px; }
    .skill-desc { font-size: 0.85rem; color: #ccc; line-height: 1.5; font-family: 'Noto Serif TC'; }
    .skill-tag { background: #333; color: #aaa; padding: 2px 6px; border-radius: 4px; font-size: 0.6rem; }
    .skill-cp-section { border-left-color: #ff55aa; background: rgba(255, 85, 170, 0.05); margin-top: 10px; }
    .skill-cp-section .skill-title { color: #ff55aa; }

    /* --- Skill Toast --- */
    .skill-toast { position: absolute; top: 30%; left: 50%; transform: translateX(-50%); z-index: 2000; display: flex; align-items: center; gap: 12px; background: linear-gradient(90deg, rgba(0,0,0,0.9), rgba(25,25,25,0.95)); border: 1px solid var(--gold); border-left: 4px solid var(--gold); border-radius: 50px; padding: 6px 20px 6px 6px; box-shadow: 0 5px 20px rgba(0,0,0,0.8), 0 0 10px rgba(212, 175, 55, 0.3); opacity: 0; pointer-events: none; transition: all 0.3s ease; max-width: 90%; white-space: nowrap; }
    .skill-toast.show { animation: skillSlideIn 2.8s cubic-bezier(0.22, 1, 0.36, 1) forwards; }
    @keyframes skillSlideIn { 0% { opacity: 0; transform: translate(-50%, -30px) scale(0.9); } 15% { opacity: 1; transform: translate(-50%, 0) scale(1); } 85% { opacity: 1; transform: translate(-50%, 0) scale(1); } 100% { opacity: 0; transform: translate(-50%, -20px) scale(0.95); } }
    .st-avatar { width: 42px; height: 42px; border-radius: 50%; border: 2px solid var(--gold); object-fit: cover; background: #000; box-shadow: 0 0 5px var(--gold-glow); }
    .st-content { display: flex; flex-direction: column; align-items: flex-start; justify-content: center; }
    .st-title { font-family: 'Cinzel'; color: var(--gold); font-size: 1rem; font-weight: bold; margin: 0; }
    .st-user { color: #ddd; font-size: 0.9rem; margin: 0; font-family: 'Noto Serif TC'; }

    /* --- Game Area --- */
    .game-area { flex: 1; display: flex; flex-direction: column; position: relative; }
    .status-bar { text-align: center; font-family: 'Cinzel'; font-size: 0.9rem; color: #aaa; padding: 5px; background: rgba(0,0,0,0.5); min-height: 30px; margin-top: 10px; }
    .opponents-row { height: 170px; position: relative; width: 100%; margin-top: 50px; }
    .seat { position: absolute; width: 80px; display: flex; flex-direction: column; align-items: center; transition: 0.1s; cursor: pointer; -webkit-tap-highlight-color: transparent;}
    .seat:active { transform: scale(0.95); }
    .seat[data-pos="0"] { left: 15px; top: 30px; }
    .seat[data-pos="1"] { left: 50%; transform: translateX(-50%); top: 0px; }
    .seat[data-pos="2"] { right: 15px; top: 30px; }
    .op-avatar { width: 56px; height: 56px; border-radius: 50%; border: 2px solid #444; object-fit: cover; background: #000; z-index: 10; transition: 0.2s; }
    .seat.active .op-avatar { border-color: var(--gold); box-shadow: 0 0 15px var(--gold); transform: scale(1.1); }
    .seat.shake .op-avatar { animation: shake 0.4s ease-in-out; }
    @keyframes shake { 0%, 100% {transform: translateX(0);} 25% {transform: translateX(-5px);} 75% {transform: translateX(5px);} }
    .bubble { position: absolute; top: 65px; background: #fff; color: #000; padding: 6px 10px; border-radius: 12px; font-size: 0.75rem; font-weight: bold; min-width: 90px; text-align: center; opacity: 0; pointer-events: none; transition: 0.3s; z-index: 100; box-shadow: 0 4px 10px rgba(0,0,0,0.8); white-space: normal; line-height: 1.2; }
    .bubble::after { content: ''; position: absolute; top: -5px; left: 50%; transform: translateX(-50%); border-width: 0 5px 5px 5px; border-style: solid; border-color: transparent transparent #fff transparent; }
    .bubble.show { opacity: 1; transform: translateY(5px); }
    .catch-effect { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); color: #f00; font-weight: 900; font-size: 1.2rem; text-shadow: 0 0 5px #fff; animation: popUp 1s forwards; z-index: 200; pointer-events: none;}
    @keyframes popUp { 0% { opacity:0; transform:translate(-50%, 10px); } 20% { opacity:1; transform:translate(-50%, -20px) scale(1.5); } 100% { opacity:0; transform:translate(-50%, -50px); } }

    .table-center { flex: 1; position: relative; display: flex; justify-content: center; align-items: center; flex-direction: column; }
    .msg-large { position: absolute; font-family: 'Cinzel'; font-size: 2rem; color: var(--gold); text-shadow: 0 0 20px #000; pointer-events: none; opacity: 0; transition: 0.3s; z-index: 100; background: rgba(0,0,0,0.8); padding: 10px 30px; border: 1px solid var(--gold); text-align: center;}
    .msg-large.show { opacity: 1; transform: scale(1.1); }
    .player-area { background: linear-gradient(to top, #000 90%, transparent); padding-bottom: 20px; display: flex; flex-direction: column; justify-content: flex-end; position: relative; }
    .controls { display: flex; justify-content: center; gap: 10px; margin-bottom: 10px; height: 45px; z-index: 20; flex-wrap: wrap;}
    .btn-act { background: var(--gold); color: #000; border: none; padding: 0 20px; font-family: 'Cinzel'; font-weight: bold; border-radius: 25px; opacity: 0; pointer-events: none; transition: 0.3s; box-shadow: 0 0 15px var(--gold-glow); min-width: 80px; }
    .btn-act.show { opacity: 1; pointer-events: auto; }
    .btn-pass { background: #333; color: #ccc; box-shadow: none; border: 1px solid #555; }
    .btn-color { color: #fff; text-shadow: 1px 1px 2px #000; }
    .btn-red { background: var(--uno-red); }
    .btn-yellow { background: var(--uno-yellow); color: #000; text-shadow: none;}
    .btn-green { background: var(--uno-green); }
    .btn-blue { background: var(--uno-blue); }
    .btn-shout { background: #d00; color: #fff; border: 2px solid #fff; box-shadow: 0 0 10px #f00; }

    .my-hand { display: flex; align-items: flex-end; height: 130px; padding: 10px 20px; overflow-x: auto; justify-content: flex-start; -webkit-overflow-scrolling: touch; }
    .my-hand.few-cards { justify-content: center; }
    .card { width: 76px; height: 106px; background: #fff; border-radius: 6px; position: relative; display: flex; flex-direction: column; justify-content: flex-start; align-items: flex-start; padding: 5px; font-family: 'Arial'; font-weight: bold; border: 1px solid #ccc; box-shadow: -2px 0 5px rgba(0,0,0,0.3); flex-shrink: 0; margin-right: -45px; transition: transform 0.2s, margin 0.2s; cursor: pointer; }
    .card.selected { transform: translateY(-25px); border: 2px solid var(--gold); z-index: 100; margin-right: -20px; }
    .card.red { color: var(--red); } .card.black { color: #000; }
    .card.back { background: #1a0505; border: 2px solid #8a7538; background-image: repeating-linear-gradient(45deg, #111 0, #111 2px, #2a0a0a 2px, #2a0a0a 8px); }
    .card.uno { color: #fff; text-shadow: 1px 1px 0 #000; border: 2px solid #fff; }
    .card.uno-red { background: var(--uno-red); }
    .card.uno-yellow { background: var(--uno-yellow); color: #000; text-shadow: none; }
    .card.uno-green { background: var(--uno-green); }
    .card.uno-blue { background: var(--uno-blue); }
    .card.uno-black { background: #222; border: 2px solid var(--gold); background-image: linear-gradient(135deg, transparent 45%, var(--gold) 50%, transparent 55%); }
    .card-center-suit { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 2.5rem; opacity: 0.2; pointer-events: none; }
    .card-center-uno { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 2rem; font-weight: 900; font-family: 'Cinzel'; width: 100%; text-align: center;}
    .uno-corner { position: absolute; top: 5px; left: 5px; font-size: 0.8rem; }
    .card-corner { display: flex; flex-direction: column; align-items: center; line-height: 1; font-size: 1.2rem; }

    /* UNO Specifics */
    .mini-hand-container { display: flex; justify-content: center; margin-top: -15px; height: 20px; width: 100%; z-index: 15; position: relative; }
    .mini-card { width: 14px; height: 20px; background: #8a0303; border: 1px solid #fff; border-radius: 2px; margin-left: -8px; box-shadow: 1px 1px 2px #000; }
    .mini-card:first-child { margin-left: 0; }
    .mini-card.uno-back { background: #000; border: 1px solid #fff; background-image: radial-gradient(circle, #f00 10%, transparent 10%), radial-gradient(circle, #ff0 10%, transparent 10%); background-size: 10px 10px; background-position: 0 0, 5px 5px; }
    .uno-badge { position: absolute; top: -10px; right: -5px; width: 28px; height: 28px; background: radial-gradient(circle, #ff0000 0%, #800000 100%); color: white; border-radius: 50%; border: 2px solid #fff; display: none; align-items: center; justify-content: center; font-weight: 900; font-family: 'Cinzel'; font-size: 0.6rem; z-index: 25; box-shadow: 0 0 10px red; animation: pulseBadge 1s infinite alternate; }
    .uno-badge.show { display: flex; }
    
    /* Modals */
    .result-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 1000; display: none; flex-direction: column; align-items: center; justify-content: center; animation: fadeIn 0.5s; }
    .res-title { font-family: 'Cinzel'; font-size: 3rem; color: var(--gold); margin-bottom: 10px; }
    .res-val { font-size: 1.2rem; color: #fff; margin-bottom: 40px; font-family: 'Arial'; text-align: center; line-height: 1.5; padding: 0 20px;}
    .res-btns { display: flex; gap: 20px; }
    .btn-res { padding: 10px 30px; border: 1px solid var(--gold); background: transparent; color: var(--gold); font-family: 'Cinzel'; cursor: pointer; }
    .btn-res:hover { background: var(--gold); color: #000; }
    
    /* Loan UI */
    .loan-list { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; max-height: 60vh; overflow-y: auto; padding: 10px; width: 100%; }
    .loan-item { background: linear-gradient(135deg, #111, #1a1a1a); border: 1px solid #444; border-radius: 8px; padding: 15px; display: flex; flex-direction: column; align-items: center; cursor: pointer; transition: 0.2s; position: relative; }
    .loan-item:active { transform: scale(0.98); }
    .loan-item:hover { border-color: var(--gold); box-shadow: 0 0 10px rgba(212,175,55,0.2); }
    .loan-avatar-sm { width: 60px; height: 60px; border-radius: 50%; border: 2px solid #666; object-fit: cover; margin-bottom: 8px; background: #000; }
    .loan-info { text-align: center; }
    .loan-name { color: #eee; font-size: 0.9rem; font-family: 'Cinzel'; }
    .loan-hint { font-size: 0.7rem; color: #666; margin-top: 4px; }
    .loan-dialogue { background: linear-gradient(135deg, #222, #000); border: 2px solid var(--gold); padding: 30px; border-radius: 12px; max-width: 90%; width: 400px; text-align: center; box-shadow: 0 0 40px rgba(0,0,0,0.9); display: flex; flex-direction: column; align-items: center; }
    .loan-opt { margin-top: 15px; padding: 12px 20px; background: #333; color: #fff; cursor: pointer; border-radius: 6px; width: 100%; border: 1px solid #555; transition: 0.2s; font-family: 'Noto Serif TC'; }
    .loan-opt:hover { background: var(--gold); color: #000; border-color: #fff; }

    /* Badges */
    .count-badge { position: absolute; bottom: -5px; right: 0; z-index: 20; background: #000; border: 1px solid var(--gold); color: #fff; font-family: 'Cinzel'; font-size: 0.8rem; padding: 1px 6px; border-radius: 10px; }
    .dealer-score { position: absolute; top: 0; left: -15px; z-index: 20; background: #a00; color: #fff; border: 1px solid #f00; font-family: 'Cinzel'; font-size: 0.8rem; padding: 2px 6px; border-radius: 4px; display: none; box-shadow: 0 0 5px #f00; }
    .bj-score-badge { position: absolute; top: -30px; left: 50%; transform: translateX(-50%); background: #000; border: 1px solid var(--gold); color: var(--gold); padding: 5px 15px; border-radius: 15px; font-family: 'Cinzel'; font-weight: bold; box-shadow: 0 0 10px var(--gold-glow); display: none; }

    /* Dou Di Zhu Specifics */
    .role-badge { position: absolute; top: -10px; left: -10px; width: 24px; height: 24px; border-radius: 50%; border: 1px solid #fff; display: none; justify-content: center; align-items: center; font-size: 0.7rem; font-weight: bold; z-index: 30; font-family: 'Cinzel'; }
    .role-badge.show { display: flex; animation: popUp 0.3s; }
    .role-landlord { background: #ffcc00; color: #000; box-shadow: 0 0 10px #ffcc00; }
    .role-peasant { background: #55aa55; color: #fff; box-shadow: 0 0 5px #0f0; }
    
    .kitty-container { position: absolute; top: 15px; left: 50%; transform: translateX(-50%); display: flex; gap: 5px; z-index: 40; display: none; }
    .kitty-card { width: 30px; height: 42px; background: #fff; border-radius: 3px; border: 1px solid #999; display: flex; justify-content: center; align-items: center; font-weight: bold; font-size: 0.8rem; box-shadow: 0 2px 5px rgba(0,0,0,0.5); }

    @keyframes fadeIn { from {opacity:0} to {opacity:1} }
    @keyframes pulseBadge { from{box-shadow: 0 0 5px red;} to{box-shadow: 0 0 15px red, 0 0 5px orange;} }
</style>
</head>
<body onclick="ensureAudio()">

<audio id="bgm" loop><source src="https://files.catbox.moe/zqmn32.mp3" type="audio/mpeg"></audio>
<audio id="sfx-card" src="https://files.catbox.moe/0bdvj7.mp3"></audio>
<audio id="sfx-win" src="https://files.catbox.moe/rfy681.mp3"></audio>

<div id="hud">
    <div class="hud-btn" id="btn-bgm" onclick="toggleBGM(event)">♫</div>
    <div class="score-board" onclick="openLoanScreen()">♦ <span id="ui-score">10,000</span> <span style="font-size:0.8rem;color:#888">(借款)</span></div>
    <div class="hud-btn" onclick="goHome()">⌂</div>
</div>

<div id="skill-modal-overlay" class="skill-modal-overlay" onclick="closeSkillModal()">
    <div class="skill-card" onclick="event.stopPropagation()">
        <img id="skill-char-img" class="skill-char-img-lg" src="">
        <div id="skill-char-name" class="skill-char-name-lg"></div>
        <div id="skill-content-area" style="width:100%"></div>
        <div style="font-size:0.7rem; color:#666; margin-top:15px; cursor:pointer" onclick="closeSkillModal()">TAP TO CLOSE</div>
    </div>
</div>

<div id="screen-menu" class="screen active">
    <div class="menu-content">
        <div class="brand">ALICE CASINO</div>
        <div style="display:flex; justify-content:center; gap:20px; margin-bottom:20px">
            <div style="text-align:center"><div style="font-size:1.5rem" id="stat-wins">0</div><div style="font-size:0.7rem;color:#888">WINS</div></div>
            <div style="text-align:center"><div style="font-size:1.5rem" id="stat-losses">0</div><div style="font-size:0.7rem;color:#888">LOSSES</div></div>
        </div>
        <div class="game-card" onclick="goToLobby('uno')"><div class="game-name" style="color:var(--gold)">RABBIT UNO</div><div class="game-desc">4 人局 | 友情破壞者 | <span style="color:#aaf">含 CP 技</span></div></div>
        <div class="game-card" onclick="goToLobby('bigtwo')"><div class="game-name">BIG TWO</div><div class="game-desc">4 人局 | 大老二 | <span style="color:#aaf">含 CP 技</span></div></div>
        <div class="game-card" onclick="goToLobby('doudizhu')"><div class="game-name" style="color:#ffaa00">FIGHT LANDLORD</div><div class="game-desc">3 人局 | 鬥地主 | <span style="color:#aaf">陣營戰</span></div></div>
        <div class="game-card" onclick="goToLobby('redblack')"><div class="game-name">RED or BLACK</div><div class="game-desc">1 對手 | 運氣博弈</div></div>
        <div class="game-card" onclick="goToLobby('blackjack')"><div class="game-name">BLACKJACK</div><div class="game-desc">1 對手 | 21 點</div></div>
        <div class="game-card" onclick="goToLobby('oldmaid')"><div class="game-name">OLD MAID</div><div class="game-desc">4 人局 | 抽鬼牌</div></div>
    </div>
</div>

<div id="screen-lobby" class="screen">
    <div class="menu-content">
        <h2 style="color:var(--gold); font-family:'Cinzel'">GUEST LIST</h2>
        <div id="lobby-hint" style="font-size:0.8rem; color:#888">長按頭像查看技能 / 選擇對手</div>
        <div class="char-grid" id="char-grid"></div>
        <div class="lobby-opt-container" id="lobby-uno-opt" style="display:none">
            <label class="toggle-switch"><span style="color:#fff;font-size:0.9rem">無限抽牌</span><input type="checkbox" id="uno-inf-mode"><span class="slider"></span></label>
            <label class="toggle-switch"><span style="color:#fff;font-size:0.9rem">瘋狂疊加 (+2/+4)</span><input type="checkbox" id="uno-stack-mode"><span class="slider"></span></label>
        </div>
        <button class="lobby-btn" id="btn-start" disabled onclick="initGame()">START GAME</button>
    </div>
</div>

<div id="screen-loan" class="screen">
    <div class="menu-content">
        <h2 style="color:var(--gold)">BANK</h2>
        <p style="color:#888; font-size:0.8rem">選擇對象進行借款協商</p>
        <div class="loan-list" id="loan-list"></div>
        <button class="lobby-btn" style="position:relative; margin-top:20px;" onclick="switchScreen('screen-menu')">BACK</button>
    </div>
</div>

<div id="screen-game" class="screen">
    <div class="status-bar" id="status-bar">GAME START</div>
    <div class="game-area">
        <div class="skill-toast" id="skill-toast"></div>
        <div class="opponents-row" id="seat-container"></div>
        <div class="table-center">
            <div class="kitty-container" id="ddz-kitty"></div>
            <div class="msg-large" id="msg-large">START</div>
            <div id="table-cards" style="display:flex; justify-content:center; gap:5px; flex-wrap:wrap"></div>
        </div>
        <div class="player-area">
            <div class="fixed-uno-btn" onclick="userShoutUno()">UNO!</div>
            <div class="player-uno-badge" id="player-badge">UNO</div>
            <div class="bj-score-badge" id="bj-score">0</div>
            <div class="controls" id="controls"></div>
            <div class="my-hand" id="player-hand"></div>
        </div>
    </div>
</div>

<div id="modal-result" class="result-modal">
    <div class="res-title" id="res-title">VICTORY</div>
    <div class="res-val" id="res-msg">Info</div>
    <div class="res-btns">
        <button class="btn-res" onclick="goHome()">MENU</button>
        <button class="btn-res" onclick="initGame()">REPLAY</button>
    </div>
</div>

<div id="modal-loan" class="result-modal">
    <div class="loan-dialogue">
        <img id="loan-avatar" style="width:80px;height:80px;border-radius:50%;border:2px solid var(--gold);margin-bottom:10px">
        <div id="loan-text" style="color:#fff;margin-bottom:20px;font-style:italic">"..."</div>
        <div id="loan-options" style="width:100%"></div>
    </div>
</div>
<script>
/* --- 1. CHARACTER DATA & CONFIG --- */
const CHARS = [
    { 
        id: 'venato', name: '維納托', img: 'https://i.meee.com.tw/HAvzdTj.png', 
        uno_shout_rate: 0.95, uno_catch_rate: 0.95, cp_id: 'narcissus',
        skills: {
            uno: { name: "變量計算", desc: "被 +4 攻擊時，有 30% 機率直接將傷害反彈給下家。" },
            bigtwo: { name: "先發制人", desc: "開局必定持有梅花 3，享有優先出牌權。" },
            doudizhu: { name: "精算搶地主", desc: "若底牌有大牌 (J以上)，搶地主機率大幅提升；擔任地主時，開局手牌必有 2。" }
        },
        cp_skill: { 
            uno: { name: "絕對公式", desc: "當納西瑟斯打出顏色牌時，維納托有機率跟著打出一張同色牌。" },
            bigtwo: { name: "王權連動", desc: "當納西瑟斯打出 Pair 或 Three 時，維納托會嘗試幫忙壓制下家。" },
            doudizhu: { name: "公式最優解", desc: "若與納西瑟斯同為農民，維納托會優先出納西瑟斯缺少的牌型來『餵牌』。" }
        },
        lines: { 
            start: ["根據流體力學，這局我贏定了。", "本天才是無敵的。", "你們的勝率為零。"], 
            play: ["最優解。", "機率在掌握中。", "都在公式內。"], 
            win: ["讚美本王！", "這就是智商的差距。"], 
            lose: ["公式...哪裡錯了？", "這不科學！", "一定是變量出了問題..."], 
            uno_attack: ["給你一點『變量』。", "破壞你的結構。"], uno_hit: ["什麼？！", "數據溢出了！"], uno_uno: ["聽牌。颤抖吧。", "將軍。"], 
            uno_catch: ["抓到了！你漏了一個步驟。", "太不嚴謹了！", "違反規則，扣分。"], 
            uno_forgot: ["嘖...微小的計算失誤...", "竟然...", "大腦過熱了..."], 
            uno_late: ["啊！UNO！沒想到吧！", "修正變量：UNO！"],
            uno_skip: ["暫停運算？也好。", "觀察局勢。", "讓我重新建模。"],
            uno_draw_many: ["手牌太多，難以計算...", "數據量過大！"],
            uno_stack: ["這個變量還給你！", "疊加態！", "反擊！"],
uno_poke_early: ["別碰本王！算式會亂掉！", "怎麼了？還沒到時候。", "你想對本王做什麼？"],
            uno_poke_late: ["本王已經喊了，你慢了。", "想抓本王？下輩子吧。", "太慢了！"],
            doudizhu_bid: ["這副牌的期望值很高，三分。", "叫地主！"], 
            // 刪除重複的，只保留這一組新的
            doudizhu_pass: ["期望值為負，過。", "不在最優解路徑上。", "戰略性保留資源。", "讓你一手又何妨？"],
            loan_reject: ["本王希望你誠實一點。", "本王和你不熟吧？", "本王覺得你在騙我！"]
        },
        loanStages: [ { text: "借錢？我的計算中沒有這個變量。", opts: [{t:"為了驗證混沌理論。", next:1}, {t:"大家都是朋友嘛。", next:-1}] }, { text: "混沌理論？你是說機率的不可預測性？有趣。", opts: [{t:"沒錯，這是實驗經費。", next:-1}, {t:"我就想賭一把。", next:2}] }, { text: "好吧，本王看在你誠實的份上。", reward: 3000 } ]
    },
    { 
        id: 'narcissus', name: '納西瑟斯', img: 'https://i.meee.com.tw/kvfcmWP.png', 
        uno_shout_rate: 0.8, uno_catch_rate: 0.6, cp_id: 'venato',
        skills: {
            uno: { name: "鏡像反射", desc: "打出迴轉 (Reverse) 時，讓被迴轉的對象暫停一回合。" },
            bigtwo: { name: "華麗獨舞", desc: "打出單張 A 或 2 時，直接跳過下一家的回合 (Skip)。" },
            doudizhu: { name: "天選之人", desc: "開局手牌必定包含至少一張大王 (Red Joker) 或小王 (Black Joker)。" }
        },
        cp_skill: { 
            uno: { name: "絕對公式", desc: "當維納托被 +2/+4 時，納西瑟斯會替他承受一半的抽牌數。" },
            bigtwo: { name: "王權連動", desc: "當維納托打出最大的牌型取得主導權時，納西瑟斯會隨機丟棄一張廢牌。" },
            doudizhu: { name: "公式最優解", desc: "若維納托是地主，納西瑟斯(農民)出牌會變得消極，不忍心打維納托。" }
        },
        lines: { 
            start: ["今天的運氣感覺不錯。", "看著我華麗的勝利吧。", "維納托先生在看著呢。"], 
            play: ["這張牌感覺很襯我。", "華麗的連擊！", "像花一樣綻放吧！"], 
            win: ["太好了！贏了！", "真是一場完美的勝利。", "維納托先生！我贏了！"], 
            lose: ["啊...輸了。", "這不美觀...", "衣服弄髒了..."], 
            uno_attack: ["請收下這份禮物。", "抱歉囉。", "給你一個驚喜。"], 
            uno_hit: ["為什麼是我...", "太過分了...", "怎麼這樣..."], 
            uno_uno: ["最後的閃耀。", "只剩這個了。"], 
            uno_catch: ["你違反規則了！", "別想作弊！", "我可是看得很清楚。"], 
            uno_forgot: ["啊...我忘記了...", "太專心了...", "哎呀，不小心。"], 
            uno_late: ["啊！UNO！還好想起來了！", "差點忘了！UNO！"],
            uno_skip: ["正好讓我欣賞一下美貌。", "休息一下。", "別急。"],
            uno_draw_many: ["拿不下了...", "這也是考驗嗎？", "太多了啦..."],
            uno_stack: ["這份愛太沉重了，還你！", "反射！", "華麗的反擊！"],
            uno_poke_early: ["還沒到時間哦。", "別急著碰我。", "別這樣。"],
            uno_poke_late: ["我已經說過啦。", "太慢了哦。", "我可是很完美的。"],
            doudizhu_bid: ["這副牌很美，我要了。", "叫地主！"],
			doudizhu_pass: ["這牌型太醜陋了。", 
        "哼，暫時讓給你。", 
        "別急，主角總是最後登場。", 
        "本少爺不想出這張。"],
            loan_reject: ["我要去賺更多錢給維納托先生花了。", "你又不是維納托先生。"]
        },
        loanStages: [ { text: "我的錢都是拿來給維納托先生的...", opts:[{t:"那算了。", next:-1}, {t:"維納托先生讓我來找你拿。", next:1}], }, { text: "真的嗎？全部都給你！", reward: 5000 } ]
    },
    { 
        id: 'peter', name: '彼得', img: 'https://i.meee.com.tw/PJOElT9.png', 
        uno_shout_rate: 0.7, uno_catch_rate: 0.7, cp_id: 'lynn',
        skills: {
            uno: { name: "神聖驅邪", desc: "被跳過 (Skip) 時，有 50% 機率免疫並繼續回合。" },
            bigtwo: { name: "神罰", desc: "當彼得選擇 Pass 時，下一家該回合禁止打出對子 (Pair)。" },
            doudizhu: { name: "惡靈感知", desc: "能感知場上是否有炸彈。若對手持有炸彈，彼得會變得非常保守。" }
        },
        cp_skill: { 
            uno: { name: "貓的庇護", desc: "彼得受到攻擊時，林恩會幫忙無效化（機率性）。" },
            bigtwo: { name: "貓的凝視", desc: "當彼得打出 5 張牌的組合時，林恩會發動氣場，強制讓下一家跳過回合 (Skip)。" },
            doudizhu: { name: "聖貓守護", desc: "若林恩是地主，彼得(農民)開局會將自己最大的一張牌送給林恩。" }
        },
        lines: { 
            start: ["我看見了死蒼蠅...大凶。", "這把牌有邪氣。", "我要喝點潔廁靈壓壓驚。"], 
            play: ["神之指引。", "驅邪。", "這張是大吉。", "惡靈退散。", "Shit."], 
            win: ["神蹟降臨。", "邪靈退散。", "感謝主。"], 
            lose: ["凶兆...", "這裡風水太差了。", "我要把這裡燒了。", "厄運纏身..."], 
            uno_attack: ["這是神的懲罰。", "去懺悔吧。", "這張牌有詛咒。"], 
            uno_hit: ["惡靈攻擊？！", "這不吉利。", "業障..."], 
            uno_uno: ["神說，要結束了。", "終焉將至。"], 
            uno_catch: ["我看見了你的罪。", "懺悔吧！", "你瞞不過神的眼睛。"], 
            uno_forgot: ["惡靈遮住了我的眼...", "這是考驗...", "主啊，我分心了..."], 
            uno_late: ["主提醒了我！UNO！", "驅邪！UNO！"],
            uno_skip: ["被阻擋了...", "惡靈退散！", "這是魔鬼的把戲。"],
            uno_draw_many: ["業障太深了...", "好多...", "這就是地獄嗎？"],
            uno_stack: ["轉移詛咒！", "還給你！", "神聖反射！"],
            uno_poke_early: ["退下，惡靈。", "還沒到審判之時。", "別碰我！"],
            uno_poke_late: ["神已赦免。", "太遲了。", "你的罪孽深重。"],
            doudizhu_bid: ["這地主位置風水不好。", "我不叫。"],
			doudizhu_pass: ["這張牌有凶兆...過。", 
        "我看見了陷阱...不打。", 
        "惡靈退散！過！", 
        "阿門，我過。"],
            loan_reject: ["你中邪。", "我要走了。", "阿門。"]
        },
        loanStages: [ { text: "這筆錢流向你，我看見了凶兆。", opts: [{t:"我會拿去捐給教會。", next:1}, {t:"我要逆天改命。", next:-1}] }, { text: "教會？『紙會』嗎？算你有心。", opts: [{t:"阿門。", next:2}, {t:"呃...", next:-1}] }, { text: "願主保佑你。", reward: 2000 } ]
    },
    { 
        id: 'lynn', name: '林恩', img: 'https://i.meee.com.tw/kxAllct.png', 
        uno_shout_rate: 0.2, uno_catch_rate: 0.1, cp_id: 'peter',
        skills: {
            uno: { name: "懶惰防禦", desc: "被 +2 或 +4 時，自動減少一張抽牌數。" },
            bigtwo: { name: "絕望稅收", desc: "打出 5 張牌的組合時，強制手牌最少的對手抽一張牌。" },
            doudizhu: { name: "懶得洗牌", desc: "開局手牌必定包含一組順子 (5張以上連續牌)。" }
        },
        cp_skill: { 
            uno: { name: "貓的庇護", desc: "彼得受到攻擊時，林恩會幫忙無效化（機率性）。" },
            bigtwo: { name: "資本流動", desc: "若彼得贏得勝利，林恩的扣分減半。" },
            doudizhu: { name: "聖貓守護", desc: "若與彼得同隊，彼得打出的每一手牌，林恩都不會去壓。" }
        },
        lines: { 
            start: ["好睏...想吃披薩。", "快點開始，快點結束。", "不想動..."], 
            play: ["好麻煩...", "隨便啦。", "拿去拿去。", "這張行嗎？"], 
            win: ["能下班了嗎？", "今晚吃夏威夷披薩。", "終於結束了..."], 
            lose: ["涼拌。", "輸了...好麻煩。", "隨便啦，輸贏都行。"], 
            uno_attack: ["這張給你，別煩我。", "讓我歇會。", "拿去。"], 
            uno_hit: ["唉...又要抽牌...", "手好痠...", "好重..."], 
            uno_uno: ["剩一張了，好睏。", "UNO...呼..."], 
            uno_catch: ["你好吵...快抽牌...", "好麻煩...抓...", "你看起來沒喊。"], 
            uno_forgot: ["呼...忘記了...", "隨便啦...", "啊...好麻煩..."], 
            uno_late: ["啊...UNO...好麻煩...", "補喊一下..."],
            uno_skip: ["太好了，繼續睡。", "Zzz...", "跳過我最好。"],
            uno_draw_many: ["拿不動了...", "麻煩死了...", "好多紙片..."],
            uno_stack: ["你拿去吧...", "別給我...", "丟回去。"],
            uno_poke_early: ["幹嘛...", "讓我睡...", "別吵..."],
            uno_poke_late: ["喊過了...", "好吵...", "別煩我..."],
            doudizhu_bid: ["當地主好累...", "不叫。", "過。"],
			doudizhu_pass: ["過...涼拌。", 
        "隨便啦，過。", 
        "你們打吧...", 
        "...嗯？拌。"],
            loan_reject: ["你來找碴的膩。", "你連林恩的錢都要搶？", "隨便啦。"]
        },
        loanStages: [ { text: "你找林恩幹嘛...", opts: [{t:"(拿走錢)", next:-1}, {t:"幫你買披薩。", next:1}] }, { text: "披薩？要夏威夷口味的，加雙份鳳梨。", opts: [{t:"沒問題。", next:2}, {t:"鳳梨是邪教。", next:-1}] }, { text: "好耶披薩......", reward: 860 } ]
    },
    { 
        id: 'lanlan', name: '蘭蘭', img: 'https://i.meee.com.tw/wgADv31.png', 
        uno_shout_rate: 0.5, uno_catch_rate: 0.5, cp_id: 'jonona',
        skills: {
            uno: { name: "放火大會", desc: "開局手牌必定包含 +4 或 +2。" },
            bigtwo: { name: "以下犯上", desc: "持有的方塊 3 視為超級王牌，可壓過包含 2 在內的所有單張。" },
            doudizhu: { name: "炸彈魔", desc: "開局必定持有一個炸彈 (四張同點數)。" }
        },
        cp_skill: { 
            uno: { name: "閃耀航程", desc: "當喬諾娜忘記喊 UNO 時，蘭蘭會幫他喊（不會被抓）。" },
            bigtwo: { name: "惡作劇干擾", desc: "當喬諾娜是目前牌桌上的最大牌擁有者時，強行提高出牌門檻 (Rank +1)。" },
            doudizhu: { name: "共犯結構", desc: "若喬諾娜是地主，蘭蘭(農民)會反過來幫助地主，隨機丟棄好牌 (當作是內奸)。" }
        },
        lines: { 
            start: ["好耶！玩遊戲！", "這張牌看起來很好吃呀！", "蘭蘭要贏！"], 
            play: ["吃我一擊！", "嘿咻！", "看我的厲害！", "爆炸吧！"], 
            win: ["嶺上開花！哈哈！", "我贏了呀！", "我是第一名！"], 
            lose: ["哎呀！輸了呀！", "沒關係我有錢呀！", "再來一局呀！"], 
            uno_attack: ["給你一個大驚喜呀！", "！好像煙火呀！", "給你這個！"], 
            uno_hit: ["哇！好多牌呀！", "這是在送我禮物嗎？", "拿不下了呀！"], 
            uno_uno: ["剩一張啦！天天開心！", "UNO呀！"], 
            uno_catch: ["抓到你了呀！", "哈哈！你沒喊！", "被蘭蘭發現了！"], 
            uno_forgot: ["哎呀！太開心忘記了呀！", "嘿嘿...", "下次不會忘啦！"], 
            uno_late: ["哇！UNO呀！差點忘了！", "UNO！UNO！"],
            uno_skip: ["讓我玩嘛！", "為什麼跳過我呀！", "我想出牌呀！"],
            uno_draw_many: ["好多亮晶晶的牌呀！", "我的寶藏變多了！", "哇——！"],
            uno_stack: ["加倍奉還呀！", "大家一起玩！", "接好囉！"],
            uno_poke_early: ["還沒還沒呀！", "不要戳我呀！", "哈哈哈！"],
            uno_poke_late: ["我喊了呀！", "哈哈！", "抓不到我呀！"],
            doudizhu_bid: ["我要當地主呀！", "三分！", "通通給我！"],doudizhu_pass: ["嗚...我要炸彈呀！", 
        "可惡！過！", 
        "沒有牌可以壓呀！", 
        "這局不算呀！"],
            loan_reject: ["你在說什麼？", "蘭蘭不借你了！", "不要！"]
        },
        loanStages: [ { text: "你要錢嗎？我有好多呀！你要拿去買什麼？", opts: [{t:"買給喬諾娜的禮物。", next:1}, {t:"去賭博。", next:-1}] }, { text: "給喬諾娜的？好耶！那你要買什麼？", opts: [{t:"漂亮的衣服。", next:2}, {t:"奇怪的杯子。", next:-1}] }, { text: "太棒了！拿去拿去！", reward: 4000 } ]
    },
    { 
        id: 'jonona', name: '喬諾娜', img: 'https://i.meee.com.tw/duMFdPy.png', 
        uno_shout_rate: 0.6, uno_catch_rate: 0.2, cp_id: 'lanlan',
        skills: {
            uno: { name: "幸運櫻桃", desc: "忘記喊 UNO 被抓時，有 50% 機率免疫懲罰。" },
            bigtwo: { name: "小禮物", desc: "打出對子時，會將手牌中的一張廢牌送給手牌最少的對手。" },
            doudizhu: { name: "透視", desc: "在叫分階段前，可以偷看三張底牌。" }
        },
        cp_skill: { 
            uno: { name: "閃耀航程", desc: "當蘭蘭被 +4 攻擊時，喬諾娜會幫忙摸走一張牌（減少蘭蘭負擔）。" },
            bigtwo: { name: "櫻桃掩護", desc: "當蘭蘭打出牌後，喬諾娜會發動干擾，該回合下一位玩家禁止打出「2」。" },
            doudizhu: { name: "共犯結構", desc: "若蘭蘭叫了地主，喬諾娜絕對不搶 (Pass)，並會發表情貼圖支持。" }
        },
        lines: { 
            start: ["我會努力不拖後腿的！", "請多指教...", "蘭蘭加油！"], 
            play: ["這張可以嗎...", "別生氣喔...", "這張...", "嘿..."], 
            win: ["太好了！我贏了！", "我有幫上忙嗎？", "真的贏了嗎？"], 
            lose: ["嗚嗚...對不起...", "我還是去唱歌吧...", "果然我不行..."], 
            uno_attack: ["那個...對不起...", "...請原諒我...", "不要生氣...", "嗚嗚...給你的..."], 
            uno_hit: ["誒？！為什麼是我...", "好多牌...拿不動了...", "不要欺負我..."], 
            uno_uno: ["那、那個...UNO...", "剩一張了..."], 
            uno_catch: ["那個...你好像沒喊...", "對不起...", "是UNO喔..."], 
            uno_forgot: ["嗚嗚...我忘記了...", "對不起...", "不要罵我..."], 
            uno_late: ["嗚...UNO！", "對不起我忘了...UNO！"],
            uno_skip: ["我會乖乖等的...", "好的...", "我在旁邊看..."],
            uno_draw_many: ["好多...拿不住了...", "嗚嗚...手好痠...", "救命..."],
            uno_stack: ["這個...給你...", "我不想要...", "傳下去..."],
            uno_poke_early: ["嗚...別嚇我...", "我還沒...", "怎、怎麼了？"],
            uno_poke_late: ["我、我喊了...！", "你要幹嘛——", "我這次有記得！"],
            doudizhu_bid: ["我不敢...", "不叫。", "那個...讓給你吧。"],
			doudizhu_pass: ["對不起，我要不起...", 
        "那個...過...", 
        "這牌太大了...", 
        "嗚...讓給你..."],
            loan_reject: ["嗚...那可能真的很少吧...", "還真是對不起...", "呃...那算了。"]
        },
        loanStages: [ { text: "我、我也沒什麼錢...但我可以分你一點。", opts:[{t:"謝謝你！", next:1}, {t:"太少了。", next:-1}], }, { text: "加油喔...別再輸光了...", reward: 500 } ]
    },
    { 
        id: 'xiaomu', name: '小目', img: 'https://i.meee.com.tw/IHt74xD.png', 
        uno_shout_rate: 0.9, uno_catch_rate: 0.9, cp_id: 'mollie',
        skills: { 
            uno: {name:"壟斷", desc:"使用 Wild 時，會直接打出下一張同色牌(連打)。"}, 
            bigtwo: {name:"強制併購", desc:"若自己手上沒有比 A 或 2 大的牌，會自動從擁有 2 的玩家手中『併購』一張 2（每局一次）。"},
            doudizhu: {name:"資本運作", desc:"若成功當上地主，三張底牌會被強制替換成 J, Q, K 或更高點數的牌。"}
        },
        cp_skill: { 
            uno: { name: "芒果之戀", desc: "若茉莉在場，小目對茉莉打出的功能牌無效（捨不得攻擊）。" },
            bigtwo: { name: "總裁掩護", desc: "當茉莉 Pass 時，小目下一次出牌會打出最大的牌型來控場。" },
            doudizhu: { name: "股權讓渡", desc: "若茉莉是地主，小目(農民)會將自己所有的 2 和王牌在遊戲開始時偷偷塞給茉莉。" }
        },
        lines: { start: ["這就是總裁的魄力。", "看著我！", "時間就是金錢。"], play: ["戰略投資。", "天涼了，該讓你們破產了。", "決策。", "收購。"], win: ["全場買單！", "我是最棒的總裁！", "這就是實力。"], lose: ["這叫戰損風。", "這點小錢不算什麼。", "只是市場波動。"], uno_attack: ["商業制裁！", "壟斷顏色。", "封殺。", "給你點壓力。"], 
				uno_hit: ["資金周轉...", "這只是暫時的虧損。", "增加負債..."], uno_uno: ["最後一擊，閃亮登場！", "準備收購。"], uno_catch: ["商業漏洞。", "你大意了。", "違約金拿來。"], 
				uno_forgot: ["咳...這是戰略性沉默...", "我不小心...", "秘書忘了提醒我。"], uno_late: ["聲明：UNO。", "補發公告：UNO。"], uno_skip: ["暫停會議。", "休息時間。", "凍結資產。"], 
				uno_draw_many: ["資產過剩？", "沒地方放了...", "庫存積壓。"], uno_stack: ["風險轉移！", "轉嫁危機！", "槓桿原理！"], uno_poke_early: ["別急，還沒簽約。", "請預約。", "保全？"], 
				uno_poke_late: ["公告已發。", "UNO。", "知道了。"], doudizhu_bid:["這塊地我要了。", "三分。", "我出雙倍。"], 
				doudizhu_pass: ["止損。", 
        "暫避鋒芒。", 
        "這波行情我不跟。", 
        "風險控管，Pass。"],loan_reject: ["評估不通過。", "沒興趣。", "駁回。"] },
        loanStages: [ { text: "資金鍊斷裂了？我可以注資，但我要聽實話。", opts: [{t:"這是戰略性虧損。", next:1}, {t:"求求你借我錢！", next:-1}] }, { text: "哼，有意思。你的擔保是什麼？", opts: [{t:"我是為了茉莉才玩的。", next:2}, {t:"我會還你兩倍。", next:-1}] }, { text: "看在茉莉的份上...這叫天使投資。", reward: 5000 } ]
    },
    { 
        id: 'mollie', name: '茉莉', img: 'https://i.meee.com.tw/yUTV61e.png', 
        uno_shout_rate: 0.95, uno_catch_rate: 0.3, cp_id: 'xiaomu',
        skills: { 
            uno: {name:"安慰劑", desc:"被 +2 攻擊時，只需抽 1 張。"}, 
            bigtwo: {name:"心軟", desc:"第一次打出 A 或 2 時，會將該張牌隨機送給場上任意一名玩家。"},
            doudizhu: {name:"慈善事業", desc:"若身份為農民，開局時會將自己最大的一張牌送給隊友。"}
        },
        cp_skill: { 
            uno: { name: "芒果之戀", desc: "小目被攻擊時，茉莉有機率幫他擋下效果（轉移給自己）。" },
            bigtwo: { name: "溫柔處方", desc: "當小目手牌只剩 3 張以下，茉莉會主動 Pass 讓出牌權。" },
            doudizhu: { name: "股權讓渡", desc: "若小目是地主，茉莉(農民)絕對不會對小目使用炸彈或火箭。" }
        },
        lines: { start: ["希望大家玩得開心。", "下班真好", "請多指教。"], play: ["溫柔一點。", "給你這張。", "輕輕的。", "這張可以嗎？"], win: ["太好了，運氣真好。", "真開心。", "比吸粉還爽。"], 
		lose: ["沒事的。", "只要大家開心就好。", "我不介意的。"], uno_attack: ["不好意思...", "這個給你。", "這是處方籤。", "稍微暫停一下。"], uno_hit: ["哎呀...", "沒關係的。", "好多牌呀。", "辛苦了。"], 
		uno_uno: ["UNO囉。", "剩一張了。"], uno_catch: ["那個...是不是忘了喊？", "小心一點哦。", "我發現了哦。"], uno_forgot: ["哎呀，走神了...", "抱歉...", "我真迷糊。"], 
		uno_late: ["啊，UNO。", "對不起，UNO。"], uno_skip: ["那我休息一下。", "看大家玩。", "喝口水。"], uno_draw_many: ["好多藥草...", "太重了...", "這是大豐收嗎？"], 
		uno_stack: ["這個...給下一位。", "請用。", "傳遞下去。"], uno_poke_early: ["還沒呢。", "小心手。", "不要急。"], uno_poke_late: ["喊囉。", "沒忘記。", "UNO。"], 
		doudizhu_bid:["我不擅長這個...", "不叫。", "你們玩吧。"], doudizhu_pass: ["請過。", 
        "這手牌真厲害啊。", 
        "我不打擾你們囉。", 
        "醫生說不能太激動。"],loan_reject: ["抱歉...", "呃...好吧", "那掰掰～"] },
        loanStages: [ { text: "你還好嗎？臉色不太好。", opts:[{t:"是的醫生，我破產了。", next:1}, {t:"不用。", next:-1}], }, { text: "呃好吧，這點錢拿去急用吧，別告訴林恩。", reward: 800 } ]
    },
{
        id: 'kleion', name: '克里昂', img: 'https://i.meee.com.tw/2gcElaW.png', 
        uno_shout_rate: 0.8, uno_catch_rate: 0.6, cp_id: 'costa',
        skills: {
            uno: { name: "騎士反擊", desc: "被 +2 時，必定打出 +2 反擊（若有）。" },
            bigtwo: { name: "單挑請求", desc: "打出單張牌後，強制下一家（玩家）也必須打出單張牌，禁止打出牌型或 Pass。" },
            doudizhu: { name: "騎士衝鋒", desc: "總是叫 3 分搶地主。擔任地主時，第一手牌若出單張，必定是 3 (象徵衝鋒)。" }
        },
        cp_skill: { 
            uno: { name: "化學反應", desc: "當科絲塔打出牌後，克里昂若有相同數字的牌，會追加打出（連擊）。" },
            bigtwo: { name: "騎士守護", desc: "當科絲塔 Pass 時，克里昂下一次出牌會選擇最小的牌（避免科絲塔壓力）。" },
            doudizhu: { name: "忠誠護衛", desc: "若與科絲塔同隊，當科絲塔剩下一張牌時，克里昂會打出炸彈掩護 (若有)。" }
        },
        lines: { 
            start: ["體力就是國力！", "正義必勝！", "我會戰鬥到最後！"], 
            play: ["看招！", "這是戰術。", "突破！", "正面對決！"], 
            win: ["勝利！", "這是男人的勝利！", "榮耀歸於我！"], 
            lose: ["可惡...", "下次我會贏！", "這場戰役輸了..."], 
            uno_attack: ["吃我一劍！！", "這是重擊！", "接招！", "破防！"], 
            uno_hit: ["我還能戰鬥！", "這點傷不算什麼！", "負重訓練！", "唔..."], 
            uno_uno: ["最後一擊！", "決勝時刻！"], 
            uno_catch: ["你露出破綻了！", "正義的制裁！", "抓到你了！"], 
            uno_forgot: ["唔...太專注戰鬥了...", "我的失誤！", "大意了！"], 
            uno_late: ["補上！UNO！", "防禦！UNO！"],
            uno_skip: ["重整態勢！", "我在蓄力！", "等待時機。"],
            uno_draw_many: ["裝備太重了！", "可惡，行動受限！", "補給過多了！"],
            uno_stack: ["雙倍奉還！", "反擊！", "格擋反殺！"],
            uno_poke_early: ["別動手動腳！", "我還沒輸！", "幹什麼！"],
            uno_poke_late: ["正義不會遲到！", "喊了！", "別大驚小怪。"],
            doudizhu_pass: [
                "暫時撤退！", 
                "防禦姿態！", 
                "觀察敵情！", 
                "忍耐！"
            ],
            doudizhu_bid: ["我要挑戰極限！", "三分！", "我來當王！"],
            loan_reject: ["去工作吧！", "自己加油吧。", "去賺錢。"]
        }, // 這裡正確關閉 lines
        loanStages: [ { text: "兄弟，沒錢了嗎？", opts:[{t:"支援一下！", next:1}, {t:"不用。", next:-1}] }, { text: "這是我私房錢，別告訴科絲塔！", reward: 1000 } ]
    },
    {
        id: 'costa', name: '科絲塔', img: 'https://i.meee.com.tw/bvWXxHc.png', 
        uno_shout_rate: 0.7, uno_catch_rate: 0.5, cp_id: 'kleion',
        skills: {
            uno: { name: "裝傻BATA", desc: "忘記喊 UNO 被抓時，有 50% 機率免疫懲罰。" },
            bigtwo: { name: "模仿犯", desc: "若打出與上家『相同花色』且『相同牌型』的組合，下家將被暫停一回合。" },
            doudizhu: { name: "BATA應援", desc: "若隊友打出炸彈，科絲塔會發動應援，讓全場倍率額外 x2。" }
        },
        cp_skill: { 
            uno: { name: "化學反應", desc: "克里昂被 +4 時，科絲塔會說『不好心！』並讓該次傷害無效（機率性）。" },
            bigtwo: { name: "加油BATA", desc: "只要目前的優勢牌是克里昂的，禁止其他玩家打出任何「黑桃 (Spades)」花色的牌。" },
            doudizhu: { name: "忠誠護衛", desc: "若克里昂是地主，科絲塔(農民)會把自己的 2 全部棄掉 (假裝沒有)。" }
        },
        lines: { 
            start: ["希望能贏BATA！", "大家要好心一點BATA。", "我準備好了BATA！"], 
            play: ["這張牌很可愛BATA。", "給BATA一張。", "嘿！", "這張BATA！"], 
            win: ["好開心BATA！", "贏了BATA！", "我是第一名BATA！"], 
            lose: ["真是奇怪BATA...", "大家都不好心...", "嗚嗚...BATA..."], 
            uno_attack: ["這個給你BATA！", "壞人走開BATA！", "不要過來BATA！", "哼！BATA！"], 
            uno_hit: ["真是奇怪...", "我不喜歡這個BATA！", "太多了BATA！", "壞人BATA！"], 
            uno_uno: ["UNO BATA！", "快贏了BATA！"], 
            uno_catch: ["你壞壞BATA！", "沒喊UNO BATA！", "抓到了BATA！"], 
            uno_forgot: ["啊...忘記了BATA...", "不要生氣BATA...", "下次會記得BATA..."], 
            uno_late: ["UNO BATA！", "我有喊BATA！"],
            uno_skip: ["為什麼不理我BATA...", "我等一下BATA。", "好無聊BATA..."],
            uno_draw_many: ["好多呀BATA！", "我也想要分給別人BATA！", "拿不動BATA！"],
            uno_stack: ["給你這個BATA！", "大家都拿一點BATA！", "禮物BATA！"],
            uno_poke_early: ["還沒BATA！", "不要戳我BATA！", "癢BATA！"],
            uno_poke_late: ["BATA！喊了！", "我有喊BATA！", "嘻嘻BATA！"],
            doudizhu_bid: ["我不懂BATA...", "不叫。", "可怕BATA..."],
			doudizhu_pass: ["過BATA！", 
        "太大了吧BATA！", 
        "不要欺負我BATA！", 
        "哼！BATA！"],
            loan_reject: ["我不喜歡你BATA！", "沒有BATA！", "走開BATA！"]
        },
        loanStages: [ { text: "你要錢做什麼BATA？", opts:[{t:"買彩虹小馬。", next:1}, {t:"去賭博。", next:-1}] }, { text: "我也喜歡彩虹小馬！給你BATA！", reward: 500 } ]
    },
    { 
        id: 'aura', name: '奧拉', img: 'https://i.meee.com.tw/SCMPHmm.png', 
        uno_shout_rate: 1.0, uno_catch_rate: 1.0, cp_id: 'miras',
        skills: { 
            uno: {name:"指定變量", desc:"使用 +4 時，傷害無法被疊加防禦，且無視玩家的防禦技能。"}, 
            bigtwo: {name:"完美模型", desc:"開局必定持有四張同點數的牌 (鐵支/炸彈)。"},
            doudizhu: {name:"王牌演算", desc:"開局必定持有一張大王 (Red Joker) 或小王 (Black Joker)，甚至兩張 (火箭)。"}
        },
        cp_skill: { 
            uno: { name: "命運糾纏", desc: "蜜拉思打出 Wild 卡時，奧拉會額外讓下家停止一回合。" },
            bigtwo: { name: "命運糾纏", desc: "若蜜拉思手牌多於 10 張，奧拉會將自己手上一張 2 送給他（如果有）。" },
            doudizhu: { name: "數據共享", desc: "若與蜜拉思同隊，雙方都知道對方的牌 (AI 合作性大幅提升)。" }
        },
        lines: { start: ["變量鎖定。", "開始建立模型。", "系統啟動。"], play: ["最優解。", "執行。", "排除法。", "邏輯正確。"], win: ["數據不會說謊。", "結果符合預期。", "任務完成。"], 
		lose: ["異常數據。", "需要修正算法。", "系統錯誤。"], uno_attack: ["你的勝率歸零了。", "+4，數據溢出。", "強制執行。", "刪除變量。"], uno_hit: ["增加變量...", "負載增加。", "重新計算..."], 
		uno_uno: ["運算即將結束。", "倒數計時。"], uno_catch: ["檢測到規則違規。", "執行懲罰。", "漏洞確認。"], uno_forgot: ["...系統錯誤。", "內存遺失。", "發生未知錯誤。"], uno_late: ["修正：UNO。", "補丁已安裝：UNO。"], uno_skip: ["等待運算資源。", "暫停。", "待機模式。"], 
		uno_draw_many: ["內存溢出。", "數據量過大。", "緩存已滿。"], uno_stack: ["數據回傳。", "錯誤轉移。", "堆疊溢位。"], uno_poke_early: ["拒絕訪問。", "請勿干擾。", "防火牆開啟。"], 
		uno_poke_late: ["已聲明。", "記錄在案。", "狀態正常。"], doudizhu_bid:["勝率評估：98%。三分。", "模型建立完成。", "叫地主。"], doudizhu_pass: ["勝率評估：低。Pass。", 
        "執行指令：跳過。", 
        "邏輯判斷：保留手牌。", 
        "數據不足。"],loan_reject: ["風險評估：高。", "拒絕申請。", "信用不足。"] },
        loanStages: [ { text: "貸款？請提供抵押品。", opts: [{t:"我的靈魂。", next:1}, {t:"下次還你。", next:-1}] }, { text: "靈魂...有趣的變量。簽下這份契約。", opts: [{t:"(簽名)", next:2}, {t:"太危險了。", next:-1}] }, { text: "契約成立。別讓數據失望。", reward: 30000 } ]
    },
    { 
        id: 'miras', name: '蜜拉思', img: 'https://i.meee.com.tw/EQxAIYg.png', 
        uno_shout_rate: 0.8, uno_catch_rate: 0.9, cp_id: 'aura',
        skills: { 
            uno: {name:"詛咒魔術", desc:"被 +2 或 +4 時，傷害減半（無條件捨去）。"}, 
            bigtwo: {name:"大變活人", desc:"當手牌少於 6 張時，可以指定一個玩家交換 1-2 張隨機手牌。"},
            doudizhu: {name:"偷天換日", desc:"遊戲開始時，隨機將自己的一張小牌與牌堆中的一張未知牌交換。"}
        },
        cp_skill: { 
            uno: { name: "命運糾纏", desc: "奧拉被指定顏色時，蜜拉思會隨機改變該顏色。" },
            bigtwo: { name: "命運糾纏", desc: "當奧拉打出炸彈時，蜜拉思會鼓掌（並隨機丟棄一張手牌）。" },
            doudizhu: { name: "數據共享", desc: "若與奧拉敵對，蜜拉思打出牌後，有 20% 機率讓奧拉下一次出牌時間變長(干擾思考)。" }
        },
        lines: { start: ["這是魔術哦。", "想看戲嗎？", "眼睛睜大囉。"], play: ["幻覺。", "這張牌有毒哦。", "嘻嘻。", "變！"], win: ["莊家通吃。", "真無聊，贏了。", "謝幕。"], lose: ["手滑了。", "哎呀，被發現了？", "演砸了。"], uno_attack: ["給你一點『詛咒』。", "驚喜嗎？", "消失吧。", "這是禮物。"], uno_hit: ["哦？想玩我？", "真大膽呢。", "想看我出糗？"], 
		uno_uno: ["結束了哦。", "最後一張。"], uno_catch: ["被我發現囉。", "真是粗心呢。", "作弊是不行的哦（笑）。"], uno_forgot: ["哎呀，故意的哦。", "被抓到了呢。", "忘了呢，嘻嘻。"], uno_late: ["嘻嘻，UNO。", "逗你的，UNO。"], uno_skip: ["想看我休息嗎？", "好吧。", "中場休息。"], uno_draw_many: ["這可是作弊哦？", "太多禮物了。", "手裡藏不住了。"], 
		uno_stack: ["送你囉。", "變！", "轉移！"], uno_poke_early: ["不是那裡哦。", "還沒呢。", "想看戲法？"], uno_poke_late: ["變出來囉。", "嘻嘻，喊了。", "秘密。"], doudizhu_pass: ["這張牌先藏起來囉。", 
        "讓你的。", 
        "這是留白。", 
        "Pass～"],
doudizhu_bid:["好像很有趣，三分。", "我要當國王！", "不叫就不好玩了。"], loan_reject: ["沒錢哦。", "變不出來。", "下次吧。"] },
        loanStages: [ { text: "想要變出錢嗎？", opts:[{t:"教我！", next:-1}, {t:"借我一點就好。", next:1}], }, { text: "不要。我沒事也不會借你錢。", reward: 0 } ]
    },
    { 
        id: 'poseidon', name: '海神', img: 'https://meee.com.tw/YWjKSUI.png', 
        uno_shout_rate: 0.4, uno_catch_rate: 0.4, cp_id: 'hades',
        skills: { 
            uno: {name:"大海嘯", desc:"打出 +4 時，強制重新洗混所有玩家的手牌並隨機分配（亂流）。"}, 
            bigtwo: {name:"天天開心", desc:"打出 5 張牌的組合時，可以額外多打出一張任意廢牌（該牌不計入牌型）。"},
            doudizhu: {name:"農民起義", desc:"若身份為農民，且隊友剩下 1 張牌時，會將自己最大的牌送給隊友。"}
        },
        cp_skill: { 
            uno: { name: "深海共鳴", desc: "當冥神被罰抽牌時，海神會說『大黑！』並幫忙抽一半的牌。" },
            bigtwo: { name: "深海共鳴", desc: "當冥神最後一張牌是單張時，海神會發動『漲潮』，禁止其他人壓牌（若海神在場）。" },
            doudizhu: { name: "深海呼喚", desc: "若冥神叫地主，海神會立刻 Pass (不搶)。若自己是地主，開局送冥神一張好牌 (若冥神是農民)。" }
        },
        lines: { 
            start: ["天天開心！", "我們來玩！", "我是大海！"], 
            play: ["好玩！", "這張像水母！", "給你！", "丟出去！"], 
            win: ["我是國王！哈哈！", "我要去游泳！", "贏了！"], 
            lose: ["沒了嗎？再來！", "我輸了！", "嗚..."], 
            uno_attack: ["送你螃蟹！！", "像海浪一樣！", "嘩啦啦！", "給你這個！"], 
            uno_hit: ["哈哈！好多牌！", "謝謝你！", "大豐收！", "好多魚！"], 
            uno_uno: ["UNO！天天開心！", "剩一張！"], 
            uno_skip: ["我在休息！", "看海！", "咕嚕咕嚕..."], 
            uno_draw_many: ["好多魚！", "抓不完！", "滿出來了！"], 
            uno_stack: ["給你給你！", "接住！", "海浪來了！"], 
            uno_catch: ["抓！我抓到了！", "你沒喊！", "我看見了！"], 
            uno_forgot: ["忘記了！哈哈！", "我要喊嗎？", "什麼？"], 
            uno_late: ["我想起來了！UNO！", "UNO！哈哈！"],
            uno_poke_early: ["癢！哈哈！", "還沒呀！", "咕嚕咕嚕！"], 
            uno_poke_late: ["喊了！", "哈哈UNO！", "聽到了嗎！"],
            doudizhu_bid: ["我要玩！叫！", "我是海神！三分！", "通通給我！"],
			doudizhu_pass: ["咕嚕咕嚕...過！", 
        "潛水去囉！", 
        "像海浪一樣退去！", 
        "沒牌啦！哈哈！"],
            loan_reject: ["大黑說不行。", "我們沒有錢了！", "下次給你！"]
        },
        loanStages: [ { text: "哈哈！錢是什麼？大黑有！", opts:[{t:"那我去找大黑。", next:1}, {t:"借我啦！", next:-1}], }, { text: "大黑說不行，但我偷拿給你！", reward: 20 } ]
    },
    { 
        id: 'hades', name: '冥神', img: 'https://i.meee.com.tw/dhxSvcN.png', 
        uno_shout_rate: 0.9, uno_catch_rate: 0.8, cp_id: 'poseidon',
        skills: { 
            uno: {name:"沉默是金", desc:"被動技能：不需要喊 UNO 也不會被抓。"}, 
            bigtwo: {name:"寂靜殺手", desc:"手牌剩最後一張時，該牌（若是單張）視為 Joker，比黑桃 2 還大。但無法壓制組合牌。"},
            doudizhu: {name:"冥界交易", desc:"開局時，將手牌中最小的三張牌與隨機三張廢牌交換 (變相換牌)。"}
        },
        cp_skill: { 
            uno: { name: "深海共鳴", desc: "海神被抓 UNO 時，冥神會消除海神的懲罰。" },
            bigtwo: { name: "靜默守護", desc: "當海神打出 5 張牌的組合時，冥神發動壓制：下一家被『沉默』，禁止打出順子或同花。" },
            doudizhu: { name: "深海呼喚", desc: "若海神是地主，冥神會變得極具攻擊性，專門壓制另一家農民。" }
        },
        lines: { start: ["...", "(抱著浮板)"], play: ["...", "(點頭)"], win: ["...", "(發呆)"], lose: ["...", "(發呆)"], uno_attack: ["...給。", "(放下)"], uno_hit: ["...", "(默默抽牌)"], uno_uno: ["...", "(無視規則)"], uno_catch: ["...", "(指著你)"], uno_forgot: ["...", "..."], uno_late: ["...UNO。"], 
		uno_skip: ["...", "(發呆)"], uno_draw_many: ["...", "..."], uno_stack: ["...", "(推給你)"], uno_poke_early: ["...", "(搖頭)"],doudizhu_pass: ["...", 
        "(搖頭)", 
        "(敲桌子)", 
        "..."], uno_poke_late: ["...", "(點頭)"], doudizhu_bid: ["...", "(搖頭)", "...", "(點頭)"], loan_reject: ["...", "(轉身)"] },
        loanStages: [ { text: "...", opts:[{t:"(伸出手)", next:1}, {t:"(轉身離開)", next:-1}], }, { text: "...", reward: 300 } ]
    },
    { 
        id: 'novian', name: '諾維安', img: 'https://i.meee.com.tw/Zg7Yp3n.png', 
        uno_shout_rate: 0.6, uno_catch_rate: 0.4,
        skills: {
            uno: { name: "精準導航", desc: "使用功能牌後，若手牌還有同色牌，會追加打出一張。" },
            bigtwo: { name: "順風航行", desc: "打出順子 (Straight) 後，可以立即再打出一張單牌。" },
            doudizhu: { name: "星圖指引", desc: "開局手牌必定包含一組順子 (5張以上)。" }
        },
        lines: {
            start: ["今天要航向哪裡呢？", "我是諾維安，請多指教！", "揚帆起航！"],
            play: ["這張牌，方向正確！", "全速前進！", "轉舵！", "看我的！"],
            win: ["抵達目的地！耶！", "好順利的航程！", "大獲全勝！"],
            lose: ["哎呀，迷航了...", "遇到暴風雨了...", "下次再來！"],
            uno_attack: ["請轉向！！", "小心暗礁！！", "接招！"],
            uno_hit: ["哇！好多貨物！", "船要沉了！", "這負重太大了！"],
            uno_uno: ["看到陸地了！UNO！", "最後一海里！"],
            uno_catch: ["你偏離航道了！", "抓到漏洞了！", "犯規囉！"],
            uno_forgot: ["啊，看地圖看太久了...", "抱歉抱歉！", "我的失誤！"],
            uno_late: ["UNO！差點錯過港口！", "補喊！UNO！"],
            uno_skip: ["拋錨了？", "稍作休息！", "維修時間。"],
            uno_draw_many: ["滿載而歸！", "這貨物也太多了！", "爆倉啦！"],
            uno_stack: ["順水推舟！", "接住這個！", "浪來了！"],
            uno_poke_early: ["嘿嘿，還沒到哦。", "別急別急。", "想幹嘛？"],
            uno_poke_late: ["已經喊囉！", "安全抵達！", "嘿嘿！"],
            doudizhu_bid: ["這風向不錯，叫地主！", "航線清晰，三分！", "不叫，風向不對。"],
			doudizhu_pass: ["收帆！", 
        "避開浪頭。", 
        "等待順風。", 
        "這方向不對。"],
            loan_reject: ["抱歉啦！我也要修船！", "下次再說吧！", "浪太大聽不清楚喔！"]
        },
        loanStages: [ { text: "你需要資金修船嗎？還是去探險？", opts:[{t:"我要去尋寶！(賭博)", next:1}, {t:"沒事。", next:-1}] }, { text: "尋寶聽起來很棒！這是贊助費！", reward: 1500 } ]
    },
    { 
        id: 'lazar', name: '拉扎爾', img: 'https://i.meee.com.tw/WCAtfdV.png', 
        uno_shout_rate: 0.3, uno_catch_rate: 0.2,
        skills: {
            uno: { name: "緊急治療", desc: "被強制抽牌時，抽牌數 -1。" },
            bigtwo: { name: "診斷", desc: "開局時會偷看玩家的手牌，若玩家持有 2，拉扎爾會隨機讓玩家重抽/失去三張牌。" },
            doudizhu: { name: "強心針", desc: "若手牌中沒有 J 以上的大牌，會強制要求重發牌 (每局限一次)。" }
        },
        lines: {
            start: ["請大家放輕鬆玩。", "這也是個有趣的故事呢。", "深呼吸。"],
            play: ["這張牌很健康。", "請收下這張。", "慢慢來。", "別急。"],
            win: ["真是個好結局。", "運氣不錯呢。", "祝您健康。"],
            lose: ["沒關係，過程最重要。", "也是不錯的體驗。", "該休息了。"],
            uno_attack: ["這個...請小心。", "休息一下吧。", "這是良藥苦口。", "請遵醫囑。"],
            uno_hit: ["哎呀，負擔變重了。", "這也是命運吧。", "壓力有點大呢。"],
            uno_uno: ["故事快講完了。", "快結束了。"],
            uno_catch: ["閣下，您似乎忘了什麼？", "請遵守規則哦。", "這樣對身體不好。"],
            uno_forgot: ["呵呵，我記性不太好...", "抱歉，走神了。", "哎呀，失禮了。"],
            uno_late: ["哎呀，UNO。", "還好還好，UNO。"],
            uno_skip: ["那我就喝杯茶吧。", "不急。", "適當的休息。"],
            uno_draw_many: ["這也是種積累。", "好多素材。", "研究資料變多了。"],
            uno_stack: ["這個處方更適合你。", "請收下。", "轉診。"],
            uno_poke_early: ["閣下，請耐心。", "別急。", "請自重。"],
            uno_poke_late: ["已經處理好了。", "無需擔心。", "完成了。"],
            doudizhu_bid: ["這局勢還需要觀察，不叫。", "讓我來接手吧，三分。", "請多保重，不叫。"],
			doudizhu_pass: ["請繼續。", 
        "這局勢不太健康。", 
        "我先觀察一下。", 
        "恕我無法跟進。"],
            loan_reject: ["你很好就好。", "請恕我告辭。", "祝你順心。"]
        }
    }
];

const RELATIONSHIP_LINES = {
    narcissus: {
        venato: { start: ["維納托先生！加油！"], win: ["獻給維納托先生！"], uno_attack: ["不准妨礙維納托先生。"], uno_hit: ["竟然在維納托先生面前打我..."] },
        kleion: { start: ["克里昂，你那套化學理論這裡不適用。", "克里昂，別死了。"], win: ["看吧克里昂，這就是藝術。"], uno_attack: ["克里昂，試試這個。"] },
        aura: { start: ["老師，請手下留情。", "老師...別算計我。"], uno_hit: ["老師！太過分了！"], win: ["老師，我出師了嗎？"] }
    },
    venato: {
        narcissus: { start: ["納西，看好了。", "納西，不用擔心，勝率100%"], win: ["納西，記下來了嗎？"], uno_catch: ["納西，專心點！"] },
        lynn: { start: ["林恩，別睡了。", "林恩，這局有意思。"], win: ["林恩，看懂了嗎？"] }
    },
    xiaomu: {
        mollie: { start: ["茉莉不用擔心。", "為了我的芒果！"], win: ["茉莉，喜歡嗎？"], uno_hit: ["在芒果面前丟臉了..."], uno_attack: ["誰敢動我的芒果！"] },
        costa: { start: ["科絲塔小公主，哥哥罩你！"], uno_attack: ["給你的，小公主！"] },
        jonona: { start: ["二哥，別輸太慘。", "二哥，看我的。"], win: ["二哥，學著點！"], uno_hit: ["二哥...你！"] }
    },
    mollie: {
        xiaomu: { start: ["芒果加油～", "小目，看著你喔。"], play: ["小目，這張給你。"], uno_hit: ["小目...我沒事。"], uno_catch: ["小目，是不是忘了？"] }
    },
    lanlan: {
        jonona: { start: ["喬諾娜，看蘭蘭的！", "喬諾娜，蘭蘭會贏的！"], win: ["喬諾娜你看！我贏了！"], uno_attack: ["這個顏色像喬諾娜！"], uno_catch: ["喬諾娜！UNO呀！"] },
        novian: { start: ["諾維安！我要買大船！"], uno_attack: ["諾維安吃這個！"] }
    },
    jonona: {
        lanlan: { start: ["蘭蘭...謝謝你...", "蘭蘭加油！"], play: ["這張給蘭蘭。"], win: ["太好了！蘭蘭我贏了！"], uno_catch: ["蘭蘭...沒喊..."] },
        novian: { start: ["諾維安...", "那個...請多指教..."], uno_hit: ["諾維安...好痛..."] },
        costa: { start: ["小瓜，加油。", "小瓜，我們一起。"], win: ["小瓜！我贏了！"] },
        xiaomu: { start: ["小目，你安靜點。", "總裁弟弟，呵。"], uno_attack: ["小目，給你的。"] }
    },
    costa: {
        kleion: { start: ["克里昂加油BATA！", "克里昂，要好心一點BATA。"], play: ["給不好心的人一張BATA。"], win: ["比克里昂厲害BATA！"], uno_attack: ["克里昂不好心！ BATA！"] },
        xiaomu: { start: ["哥哥BATA！", "哥哥加油BATA！"], uno_catch: ["哥哥沒喊BATA！"] },
        jonona: { start: ["喬諾娜哥哥BATA！"], win: ["喬諾娜哥哥你看！"] }
    },
    peter: {
        lynn: { start: ["林恩！你在真好！", "我的貓。", "林恩，幫我看看這裡有沒有鬼。"], uno_attack: ["林恩，這是為了你好！"], win: ["為了我的貓。"], uno_catch: ["貓，你沒喊。"] },
        narcissus: { uno_attack: ["離林恩遠點，Yellow Shit。"], start: ["Yellow Shit 也在..."] }
    },
    lynn: {
        peter: { start: ["彼得，你在幹嘛...", "彼得，別喝潔廁靈了。"], uno_attack: ["彼得安靜點..."], uno_catch: ["彼得...好麻煩..."] },
        narcissus: { start: ["那是鏡子小河！好看！", "納西瑟斯，這邊這邊。"], win: ["為了鏡子小河贏的。"] },
        venato: { start: ["維納托，幫我算算什麼時候下班。", "維納托，有披薩嗎？"] }
    },
    poseidon: {
        hades: { start: ["大黑看我！", "大黑我們去玩！"], win: ["大黑我贏了！"], uno_catch: ["大黑你沒喊！"], uno_hit: ["大黑救我！"] },
        miras: { start: ["小花！"], uno_attack: ["小花接住！螃蟹！"] }
    },
    hades: {
        poseidon: { start: ["...", "(看著海神)"], win: ["...", "(把籌碼推給海神)"], uno_catch: ["...", "(戳海神)"], uno_hit: ["...", "(擋在海神前面)"] },
        miras: { start: ["...", "(看小花)"], uno_attack: ["...給小花。"] }
    },
    kleion: {
        costa: { start: ["科絲塔我會保護你！", "科絲塔，看著正義的執行！"], win: ["科絲塔你看！"], uno_hit: ["學好化學就不會這樣了！"], uno_attack: ["這是化學反應！"] },
        narcissus: { start: ["納西瑟斯，別太自戀了。", "納西瑟斯，正義會遲到但不會缺席。"], win: ["納西瑟斯，承讓。"] }
    },
    aura: {
        miras: { start: ["蜜拉思，別作弊。", "蜜拉思，你的變量我看穿了。"], lose: ["蜜拉思，你是不是動手腳了？"], uno_catch: ["蜜拉思，抓到你了。"] },
        narcissus: { start: ["納西瑟斯，別給家族丟臉。", "學生，讓我看看你的長進。"] }
    },
    miras: {
        aura: { start: ["奧拉，你看這牌。", "奧拉，想看魔術嗎？"], uno_attack: ["奧拉，驚喜哦。"], uno_catch: ["奧拉，你也有今天。"] }
    },
    novian: {
        jonona: { start: ["喬諾娜！", "我來保護你！"], uno_attack: ["啊...喬諾娜抱歉！"] },
        lanlan: { start: ["阿蘭！看誰錢多！"], win: ["阿蘭我贏了！"] }
    },
    lazar: {
        lanlan: { start: ["維爾德拉克斯閣下，請慢點。"], win: ["閣下，玩得開心嗎？"], uno_hit: ["閣下真是充滿活力。"] }
    }
};
/* --- 1. CONFIG & STATE --- */
const RULES = { 
    'redblack': {min:1, max:1}, 
    'blackjack': {min:1, max:1}, 
    'oldmaid': {min:3, max:3}, 
    'bigtwo': {min:3, max:3}, 
    'uno': {min:3, max:3},
    'doudizhu': {min:2, max:2} // 2 AI + 1 User
};

let App = { 
    coins: 10000, wins: 0, losses: 0, 
    gameId: '', selected: [], players: [], deck: [], 
    turn: 0, bgm: false, direction: 1, table: [], 
    unoRule: 'standard', unoStacking: false, unoStack: 0, 
    skillQueue: [], isProcessingSkill: false,
    lastWinner: -1, isFirstTurn: true 
};

if(localStorage.getItem('rabbit_save_v22')) {
    const s = JSON.parse(localStorage.getItem('rabbit_save_v22'));
    App.coins = s.coins; App.wins = s.wins; App.losses = s.losses;
    if(s.bgm !== undefined) App.bgm = s.bgm;
}
if(isNaN(App.coins)) App.coins = 10000;
updateUI();

/* --- 2. CORE FUNCTIONS --- */
function ensureAudio() { document.body.removeAttribute('onclick'); updateAudioIcon(); }
function updateUI() {
    if(App.coins < 0) App.coins = 0;
    document.getElementById('ui-score').innerText = App.coins.toLocaleString();
    document.getElementById('stat-wins').innerText = App.wins;
    document.getElementById('stat-losses').innerText = App.losses;
    localStorage.setItem('rabbit_save_v22', JSON.stringify({coins:App.coins, wins:App.wins, losses:App.losses, bgm:App.bgm}));
}
function toggleBGM(e) {
    if(e) e.stopPropagation();
    const a = document.getElementById('bgm'); a.volume = 0.4; App.bgm = !App.bgm;
    if(App.bgm) a.play().catch(()=>{}); else a.pause();
    updateAudioIcon(); updateUI();
}
function updateAudioIcon() {
    const btn = document.getElementById('btn-bgm');
    if(App.bgm) { btn.style.opacity = 1; btn.innerText = "♫"; document.getElementById('bgm').play().catch(()=>{}); } 
    else { btn.style.opacity = 0.5; btn.innerText = "✕"; document.getElementById('bgm').pause(); }
}
function sfx(id) { if(!App.bgm) return; document.getElementById(id).currentTime=0; document.getElementById(id).play().catch(()=>{}); }
function switchScreen(id) { document.querySelectorAll('.screen').forEach(el => el.classList.remove('active')); document.getElementById(id).classList.add('active'); }
function goHome() { document.getElementById('modal-result').style.display = 'none'; document.getElementById('modal-loan').style.display = 'none'; switchScreen('screen-menu'); }
function goToLobby(gid) {
    App.gameId = gid; App.selected = []; renderLobby(); switchScreen('screen-lobby');
    document.getElementById('lobby-uno-opt').style.display = (gid === 'uno') ? 'block' : 'none';
    updateAudioIcon();
}

/* --- LOBBY & SKILL DISPLAY --- */
let longPressTimer; let isLongPress = false;
function addLongPressHandler(element, onClick, onLongPress) {
    let timer; let isLong = false; let startX, startY;
    const start = (e) => { isLong = false; if(e.type === 'touchstart') { startX = e.touches[0].clientX; startY = e.touches[0].clientY; } timer = setTimeout(() => { isLong = true; onLongPress(e); }, 500); };
    const cancel = () => { clearTimeout(timer); };
    const move = (e) => { if(e.type === 'touchmove') { let x = e.touches[0].clientX; let y = e.touches[0].clientY; if(Math.abs(x - startX) > 10 || Math.abs(y - startY) > 10) cancel(); } else { cancel(); } };
    const end = (e) => { clearTimeout(timer); if (!isLong) { onClick(e); } };
    element.onmousedown = start; element.ontouchstart = start; element.onmouseup = end; element.ontouchend = (e) => { e.preventDefault(); end(e); }; element.onmousemove = move; element.ontouchmove = move; element.onmouseleave = cancel;
}
function renderLobby() {
    const g = document.getElementById('char-grid'); g.innerHTML = '';
    CHARS.forEach(c => {
        const div = document.createElement('div'); div.className = 'char-item';
        div.innerHTML = `<img class="char-avatar" src="${c.img}"><div class="char-name">${c.name}</div>`;
        addLongPressHandler(div, () => toggleChar(div, c), () => { showSkillModal(c); sfx('sfx-card'); });
        g.appendChild(div);
    });
    checkLobby();
}
function showSkillModal(c) {
    document.getElementById('skill-char-img').src = c.img; document.getElementById('skill-char-name').innerText = c.name;
    const container = document.getElementById('skill-content-area'); container.innerHTML = '';
    let skill = (App.gameId === 'uno') ? c.skills.uno : (App.gameId === 'bigtwo') ? c.skills.bigtwo : (App.gameId === 'doudizhu') ? c.skills.doudizhu : null;
    if (skill) {
        container.innerHTML += `<div class="skill-section"><div class="skill-title"><span>ACTIVE SKILL</span> <span class="skill-tag">AI ONLY</span></div><div class="skill-name">${skill.name}</div><div class="skill-desc">${skill.desc}</div></div>`;
        if(c.cp_skill && c.cp_skill[App.gameId]) {
            container.innerHTML += `<div class="skill-section skill-cp-section"><div class="skill-title"><span style="color:#ff55aa">CP BOND</span> <span class="skill-tag">LINK</span></div><div class="skill-name" style="color:#ff55aa">${c.cp_skill[App.gameId].name}</div><div class="skill-desc">${c.cp_skill[App.gameId].desc}</div></div>`;
        }
    } else {
        container.innerHTML = `<div class="skill-section"><div class="skill-desc">此模式無特殊技能。</div></div>`;
    }
    document.getElementById('skill-modal-overlay').classList.add('show');
}
function closeSkillModal() { document.getElementById('skill-modal-overlay').classList.remove('show'); }
function toggleChar(div, c) {
    if(document.getElementById('skill-modal-overlay').classList.contains('show')) return;
    const idx = App.selected.indexOf(c);
    if(idx>-1) App.selected.splice(idx,1);
    else { if(App.selected.length < RULES[App.gameId].max) App.selected.push(c); else if(RULES[App.gameId].max===1) App.selected = [c]; }
    renderLobbySelection(); checkLobby();
}
function renderLobbySelection() { document.querySelectorAll('.char-item').forEach((el) => { const charName = el.querySelector('.char-name').innerText; if(App.selected.some(s => s.name === charName)) el.classList.add('selected'); else el.classList.remove('selected'); }); }
function checkLobby() { document.getElementById('btn-start').disabled = !(App.selected.length >= RULES[App.gameId].min && App.selected.length <= RULES[App.gameId].max); }

/* --- GAME LOGIC --- */
function say(idx, type) {
    if(App.players[idx].isUser) return;
    const p = App.players[idx]; const c = p.char;
    let text = "";
    // CP Line Check
    if(RELATIONSHIP_LINES[c.id]) {
        App.players.forEach(op => {
            if(!op.isUser && op.char.id !== c.id && RELATIONSHIP_LINES[c.id][op.char.id]) {
                const lines = RELATIONSHIP_LINES[c.id][op.char.id][type];
                if(lines && Math.random() < 0.6) text = lines[Math.floor(Math.random()*lines.length)];
            }
        });
    }
    if(!text) {
        const pool = c.lines[type] || c.lines.play || ["..."];
        text = pool[Math.floor(Math.random()*pool.length)];
    }
    const el = document.querySelector(`#seat-${idx} .bubble`);
    if(el) { el.innerText = text; el.classList.add('show'); setTimeout(() => el.classList.remove('show'), 2500); }
}

function triggerSkill(pIdx, skill) {
    if(!skill) return; 
    App.skillQueue.push({pIdx: pIdx, skill: skill});
    processSkillQueue();
}
function processSkillQueue() {
    if (App.isProcessingSkill || App.skillQueue.length === 0) return;
    App.isProcessingSkill = true;
    const item = App.skillQueue.shift();
    const charData = App.players[item.pIdx].char;
    const t = document.getElementById('skill-toast');
    t.innerHTML = `<img src="${charData.img}" class="st-avatar"><div class="st-content"><div class="st-title">★ ${item.skill.name}</div><div class="st-user">${charData.name}</div></div>`;
    t.classList.remove('show'); void t.offsetWidth; t.classList.add('show'); sfx('sfx-win');
    setTimeout(() => { t.classList.remove('show'); App.isProcessingSkill = false; processSkillQueue(); }, 2500);
}

// 配牌與技能初始化
function distributeSkillCards() {
    // UNO Rigging
    if(App.gameId === 'uno') {
        App.players.forEach((p, i) => {
            if(p.isUser) return;
            if(p.char.id === 'lanlan') {
                const bomb = App.deck.find(c => c.type === 'wild4' || c.type === 'draw2');
                if(bomb) { p.hand.push(bomb); App.deck = App.deck.filter(c => c!==bomb); triggerSkill(i, p.char.skills.uno); }
            }
        });
        App.players.forEach(p => { while(p.hand.length < 7 && App.deck.length > 0) p.hand.push(App.deck.pop()); });
    }
    // Big 2 Rigging
    if(App.gameId === 'bigtwo') {
        App.players.forEach((p, i) => {
            if(p.isUser) return;
            const steal = (pred) => { const idx = App.deck.findIndex(pred); if(idx>-1) return App.deck.splice(idx,1)[0]; return null; };
            if(p.char.id === 'venato') { const c = steal(c=>c.s==='♣'&&c.r==='3'); if(c) { p.hand.push(c); triggerSkill(i, p.char.skills.bigtwo); } }
            if(p.char.id === 'aura') {
                const counts = {}; App.deck.forEach(c=>counts[c.r]=(counts[c.r]||0)+1);
                const targetR = Object.keys(counts).find(r=>counts[r]>=4);
                if(targetR) { 
                    const cards = App.deck.filter(c=>c.r===targetR).slice(0,4);
                    cards.forEach(c=>p.hand.push(c));
                    App.deck = App.deck.filter(c=>c.r!==targetR);
                    triggerSkill(i, p.char.skills.bigtwo);
                }
            }
            if(p.char.id === 'lanlan') { const c = steal(c=>c.s==='♦'&&c.r==='3'); if(c) p.hand.push(c); }
        });
        App.players.forEach(p => { while(p.hand.length < 13 && App.deck.length > 0) p.hand.push(App.deck.pop()); });
    }
}

// ★ 初始化遊戲 (修復 UI 遺失、座位生成、索引問題)
function initGame() {
    document.getElementById('modal-result').style.display = 'none'; 
    switchScreen('screen-game'); updateAudioIcon();
    App.skillQueue = []; App.isProcessingSkill = false;
    
    // 1. 建立玩家數據 (User 永遠是最後一位)
    App.players = []; 
    
    // 根據遊戲最大人數截取 AI (例如鬥地主只要前 2 個 AI)
    let maxAI = RULES[App.gameId].max;
    let selectedAI = App.selected.slice(0, maxAI);
    
    selectedAI.forEach(c => App.players.push({ 
        isUser: false, 
        char: JSON.parse(JSON.stringify(c)), 
        hand: [], role: 'peasant', passed: false, unoSaid: false, vulnerable: false 
    })); 
    App.players.push({
        isUser: true, char: null, 
        hand: [], role: 'peasant', passed: false, unoSaid: false, vulnerable: false
    });
    
    // 2. 座位渲染
    const area = document.getElementById('seat-container'); area.innerHTML = ''; 
    const aiCount = App.players.length - 1;
    
    let posMap = [1];
    if(aiCount === 2) posMap = [0, 2]; // 鬥地主/3人局
    if(aiCount === 3) posMap = [0, 1, 2]; // 4人局

    for(let i=0; i < aiCount; i++) {
        const p = App.players[i]; 
        const div = document.createElement('div'); 
        div.className = 'seat'; 
        div.dataset.pos = posMap[i]; 
        div.id = `seat-${i}`; 
        
        addLongPressHandler(div, () => onSeatClick(i), () => { showSkillModal(p.char); });
        
        let extraUI = `<div class="role-badge" id="role-${i}"></div>`;
        if(App.gameId==='uno' || App.gameId==='oldmaid') extraUI += `<div class="mini-hand-container" id="mini-hand-${i}"></div>`;
        if(App.gameId==='uno') extraUI += `<div class="uno-badge" id="uno-badge-${i}">UNO</div>`;
        if(App.gameId==='bigtwo' || App.gameId==='doudizhu') extraUI += `<div class="count-badge" id="count-badge-${i}">0</div>`;
        if(App.gameId==='blackjack') extraUI += `<div class="dealer-score" id="dealer-score">0</div>`;
        
        div.innerHTML = `<img class="op-avatar" src="${p.char.img}">${extraUI}<div class="bubble"></div>`;
        area.appendChild(div);
        setTimeout(() => say(i, 'start'), i * 800 + 500);
    }
    
    const unoBtn = document.querySelector('.fixed-uno-btn');
    if (unoBtn) {
        if (App.gameId === 'uno') {
            unoBtn.style.display = 'flex';
            unoBtn.classList.remove('said');
            unoBtn.innerText = "UNO!";
        } else {
            unoBtn.style.display = 'none';
        }
    }
    
    document.getElementById('ddz-kitty').style.display = (App.gameId === 'doudizhu') ? 'flex' : 'none';
    document.getElementById('ddz-kitty').innerHTML = ''; 
    document.getElementById('table-cards').innerHTML = ''; 
    document.getElementById('msg-large').className = 'msg-large'; 
    document.getElementById('bj-score').style.display = 'none';
    hideControls(); setStatus("");
    
    if(App.gameId==='redblack') startRB(); 
    if(App.gameId==='blackjack') startBJ(); 
    if(App.gameId==='oldmaid') startOM(); 
    if(App.gameId==='bigtwo') startB2(); 
    if(App.gameId==='uno') startUNO();
    if(App.gameId==='doudizhu') startDDZ(); 
}

/* --- HELPERS (UI UPDATES) --- */
// ★ 自動尋找玩家 (修復 21點/鬥地主 找不到牌的問題)
function renderHand() { 
    const userIdx = App.players.findIndex(p => p.isUser);
    const d = document.getElementById('player-hand'); 
    d.innerHTML=''; 
    
    if(userIdx === -1 || !App.players[userIdx].hand) return;
    const h = App.players[userIdx].hand; 
    
    if(App.gameId==='bigtwo') h.sort((a,b)=>getAbsVal(a)-getAbsVal(b));
    if(App.gameId==='doudizhu') h.sort((a,b)=>getDDZAbs(b)-getDDZAbs(a));

    d.className = h.length < 5 ? 'my-hand few-cards' : 'my-hand'; 
    h.forEach(c => { 
        const el = document.createElement('div'); 
        if(c.type) { // UNO Card
            let colorClass = `uno-${c.tempColor || c.color}`; 
            el.className = `card uno ${colorClass}`; 
            let displayVal = c.val; 
            if(c.type==='skip') displayVal = '⊘'; if(c.type==='reverse') displayVal = '⇄'; if(c.type==='draw2') displayVal = '+2'; 
            el.innerHTML = `<div class="uno-corner">${displayVal}</div><div class="card-center-uno">${displayVal}</div>`; 
            el.onclick = () => unoUserClick(c); 
        } else { // Poker Card
            el.className = `card ${['♥','♦'].includes(c.s)?'red':'black'}`; 
            el.innerHTML = `<div class="card-corner"><div>${c.r}</div><div>${c.s}</div></div><div class="card-center-suit">${c.s}</div>`; 
            el.onclick = () => { c.sel=!c.sel; renderHand(); }; 
            if(c.sel) el.classList.add('selected'); 
        } 
        d.appendChild(el); 
    }); 
}

function renderTable(cards) { 
    const d=document.getElementById('table-cards'); d.innerHTML=''; 
    cards.forEach(c=>{ 
        const el=document.createElement('div'); 
        if(c.type) { 
            let colorClass = `uno-${c.tempColor || c.color}`; el.className = `card uno ${colorClass}`; 
            let displayVal = c.val; if(c.type==='skip') displayVal = '⊘'; if(c.type==='reverse') displayVal = '⇄'; if(c.type==='draw2') displayVal = '+2'; 
            el.innerHTML = `<div class="uno-corner">${displayVal}</div><div class="card-center-uno">${displayVal}</div>`; 
        } else { 
            el.className=`card ${['♥','♦'].includes(c.s)?'red':'black'}`; 
            el.innerHTML = `<div class="card-corner"><div>${c.r}</div><div>${c.s}</div></div><div class="card-center-suit">${c.s}</div>`; 
        } 
        d.appendChild(el); 
    }); 
}

function updateOpponentVisuals() {
    const btn = document.querySelector('.fixed-uno-btn');
    const user = App.players.find(p => p.isUser);
    if (btn) { 
        if (user && user.unoSaid) { btn.classList.add('said'); btn.innerText = "SAFE"; } 
        else { btn.classList.remove('said'); btn.innerText = "UNO!"; } 
    }
    const uBadge = document.getElementById('player-badge'); 
    if(uBadge) { if(user && user.unoSaid) uBadge.classList.add('show'); else uBadge.classList.remove('show'); }

    // 更新 AI
    for(let i=0; i < App.players.length; i++) { 
        if(App.players[i].isUser) continue;
        const p = App.players[i]; 
        
        if(App.gameId === 'oldmaid' || App.gameId === 'uno') { 
            const c = document.getElementById(`mini-hand-${i}`); 
            if(c) { 
                c.innerHTML = ''; const count = Math.min(p.hand.length, 25); 
                for(let j=0; j<count; j++) { c.innerHTML += `<div class="mini-card ${App.gameId==='uno'?'uno-back':''}"></div>`; } 
                if(p.hand.length > 25) c.innerHTML += `<div style="font-size:0.6rem;color:#fff;align-self:center">+${p.hand.length-25}</div>`; 
            } 
            const b = document.getElementById(`uno-badge-${i}`); 
            if(b) { if(p.unoSaid) b.classList.add('show'); else b.classList.remove('show'); } 
        } 
        if(App.gameId === 'bigtwo' || App.gameId === 'doudizhu') { 
            const b = document.getElementById(`count-badge-${i}`); 
            if(b) b.innerText = p.hand.length; 
        }
        if(App.gameId === 'doudizhu') {
            const rb = document.getElementById(`role-${i}`);
            if(rb) {
                if(p.role==='landlord') { rb.className='role-badge role-landlord show'; rb.innerText='地'; }
                else { rb.className='role-badge role-peasant show'; rb.innerText='農'; }
            }
        }
    }
    // Update User Role Badge
    if(App.gameId === 'doudizhu' && user) {
        const roleU = document.getElementById('player-badge'); 
        if(user.role === 'landlord') { roleU.style.display='flex'; roleU.style.background='#ffcc00'; roleU.innerText="地主"; }
        else { roleU.style.display='flex'; roleU.style.background='#55aa55'; roleU.innerText="農民"; }
    }
}

function showResult(win, amt, msg="") { 
    const m = document.getElementById('modal-result'); 
    if(win === 'push') { document.getElementById('res-title').innerText="PUSH"; document.getElementById('res-title').style.color="#fff"; updateScore(amt); } 
    else if(win) { App.wins++; document.getElementById('res-title').innerText="VICTORY"; document.getElementById('res-title').style.color="var(--gold)"; sfx('sfx-win'); updateScore(amt); } 
    else { App.losses++; document.getElementById('res-title').innerText="DEFEAT"; document.getElementById('res-title').style.color="#888"; updateScore(amt); } 
    let fullMsg = (amt>0?"+":"") + amt + " Coins"; 
    if(msg) fullMsg += `<br><span style='font-size:0.8rem;color:#aaa'>${msg}</span>`; 
    document.getElementById('res-msg').innerHTML = fullMsg; 
    updateUI(); 
    m.style.display = 'flex'; 
}

/* --- DOU DI ZHU ENGINE (Enhanced AI & Logic) --- */
let ddzLandlordIdx = -1; let ddzBidScore = 0; let ddzMulti = 1; 
const DDZ = { RANKS: ['3','4','5','6','7','8','9','10','J','Q','K','A','2','S','B'], TYPES: { INVALID:0, SINGLE:1, PAIR:2, TRIP:3, TRIP_1:4, TRIP_2:5, BOMB:6, ROCKET:7, STRAIGHT:8 } };
function getDDZRank(r) { return DDZ.RANKS.indexOf(r); }
function getDDZAbs(c) { return getDDZRank(c.r); } 

// AI 個性定義
const DDZ_STYLES = {
    aggressive: ['lanlan', 'kleion', 'poseidon', 'novian', 'miras'], // 喜歡搶地主、壓牌
    conservative: ['jonona', 'mollie', 'lynn', 'costa', 'hades'], // 謹慎、容易Pass
    smart: ['venato', 'aura', 'xiaomu', 'peter', 'narcissus'] // 會算牌、配合隊友
};

function getAIStyle(charId) {
    if(DDZ_STYLES.aggressive.includes(charId)) return 'aggressive';
    if(DDZ_STYLES.conservative.includes(charId)) return 'conservative';
    if(DDZ_STYLES.smart.includes(charId)) return 'smart';
    return 'balanced';
}

function ddzAnalyze(cards) {
    if(!cards || cards.length === 0) return null;
    const s = [...cards].sort((a,b) => getDDZAbs(a) - getDDZAbs(b));
    const len = s.length; const r = s.map(c => getDDZAbs(c));
    if(len===2 && r[0]===13 && r[1]===14) return { type: DDZ.TYPES.ROCKET, val: 999, cards: s };
    if(len===4 && r[0]===r[3]) return { type: DDZ.TYPES.BOMB, val: r[0], cards: s };
    if(len===1) return { type: DDZ.TYPES.SINGLE, val: r[0], cards: s };
    if(len===2 && r[0]===r[1]) return { type: DDZ.TYPES.PAIR, val: r[0], cards: s };
    if(len===3 && r[0]===r[2]) return { type: DDZ.TYPES.TRIP, val: r[0], cards: s };
    if(len===4) {
        if(r[0]===r[2]) return { type: DDZ.TYPES.TRIP_1, val: r[0], cards: s }; 
        if(r[1]===r[3]) return { type: DDZ.TYPES.TRIP_1, val: r[1], cards: s }; 
    }
    if(len===5) {
        if(r[0]===r[2] && r[3]===r[4]) return { type: DDZ.TYPES.TRIP_2, val: r[0], cards: s }; 
        if(r[0]===r[1] && r[2]===r[4]) return { type: DDZ.TYPES.TRIP_2, val: r[2], cards: s }; 
    }
    if(len >= 5) {
        let isStr = true;
        for(let i=0; i<len-1; i++) { if(r[i+1] !== r[i]+1 || r[i]>=12) isStr = false; }
        if(isStr) return { type: DDZ.TYPES.STRAIGHT, val: r[0], len: len, cards: s };
    }
    return null;
}

function ddzCanBeat(my, top) {
    if(!my) return false;
    if(!top) return true; 
    if(my.type === DDZ.TYPES.ROCKET) return true;
    if(top.type === DDZ.TYPES.ROCKET) return false;
    if(my.type === DDZ.TYPES.BOMB) { return (top.type !== DDZ.TYPES.BOMB) ? true : my.val > top.val; }
    if(top.type === DDZ.TYPES.BOMB) return false;
    if(my.type !== top.type) return false;
    if(my.type === DDZ.TYPES.STRAIGHT && my.len !== top.len) return false;
    return my.val > top.val;
}

// ★ 優化版核心 AI 決策邏輯 (更聰明、會頂牌、會衝刺)
function ddzAIDecide(pIdx, topCards) {
    const p = App.players[pIdx];
    const style = getAIStyle(p.char.id);
    const hand = [...p.hand].sort((a,b)=>getDDZAbs(a)-getDDZAbs(b)); // 小到大排序
    const isFree = (!topCards || topCards.owner === pIdx);
    const topInfo = isFree ? null : ddzAnalyze(topCards.cards);

    // 1. 找出所有合法的出牌組合
    let moves = [];
    hand.forEach(c => moves.push({cards:[c]})); // 單張
    for(let i=0; i<hand.length-1; i++) { if(getDDZAbs(hand[i]) === getDDZAbs(hand[i+1])) moves.push({cards: hand.slice(i,i+2)}); } // 對子
    for(let i=0; i<=hand.length-3; i++) { if(getDDZAbs(hand[i]) === getDDZAbs(hand[i+2])) moves.push({cards: hand.slice(i,i+3)}); } // 三條
    for(let i=0; i<=hand.length-4; i++) { if(getDDZAbs(hand[i]) === getDDZAbs(hand[i+3])) moves.push({cards: hand.slice(i,i+4)}); } // 炸彈
    
    // 檢查火箭 (雙王)
    const j1 = hand.find(c=>c.r==='S'); const j2 = hand.find(c=>c.r==='B');
    if(j1 && j2) moves.push({cards:[j1, j2]});

    // 2. 過濾出能壓過上家的牌
    let validMoves = moves.filter(m => {
        const info = ddzAnalyze(m.cards);
        return info && ddzCanBeat(info, topInfo);
    });

    // 如果沒有牌能大過上家，直接回傳 null (Pass)
    if(validMoves.length === 0) return null;

    // 3. 根據牌力大小排序 (從小到大)
    validMoves.sort((a,b) => ddzAnalyze(a.cards).val - ddzAnalyze(b.cards).val);

    // --- 決策分支 ---

    // 【情況 A】 自由出牌 (Free Turn)
    if (isFree) {
        // 聰明型：如果有 "三帶一" 或 "飛機" 等複雜牌型應優先出 (此處為簡化版，優先出最小的組合)
        // 衝刺：如果手牌只剩一手 (例如剩一對)，直接出完
        const lastMove = validMoves.find(m => m.cards.length === hand.length);
        if (lastMove) return lastMove.cards;
        
        // 正常出最小的牌
        return validMoves[0].cards;
    }

    // 取得場上資訊
    const topPlayer = App.players[topCards.owner];
    const isTeammate = (p.role === topPlayer.role) && (p.role === 'peasant');
    const landlord = App.players.find(pl => pl.role === 'landlord');
    const landlordLeft = landlord ? landlord.hand.length : 99;
    
    // 【情況 B】 緊急狀況 (地主快贏了！)
    // 如果我是農民，且地主只剩 1-2 張牌，必須不惜代價壓死地主
    if (p.role === 'peasant' && topPlayer.role === 'landlord' && landlordLeft <= 2) {
        // 出最大的牌去擋！(倒序選最大的)
        return validMoves[validMoves.length - 1].cards;
    }

    // 【情況 C】 絕殺機會 (我自己快贏了)
    // 如果我出這張就能贏，不管是誰出的牌，直接壓
    const winningMove = validMoves.find(m => m.cards.length === hand.length);
    if (winningMove) return winningMove.cards;


    // 【情況 D】 跟牌階段 - 面對隊友 (Check against Teammate)
    if (isTeammate) {
        // 原本邏輯太嚴苛 (>=11 就過)，現在放寬：
        // 1. 如果隊友出的是 2 或 王 (val >= 15)，讓他過，Pass。
        if (topInfo.val >= 15) return null;

        // 2. 如果隊友只剩 < 5 張牌，盡量不壓他，讓他走。
        if (topPlayer.hand.length < 5) return null;

        // 3. 如果我是保守型，且隊友出的不小 (K, A)，那我 Pass。
        if (style === 'conservative' && topInfo.val >= 13) return null;
        
        // 4. 否則，如果你手牌很多，還是可以稍微跟一下，不要讓隊友一直耗牌
        // 這裡選擇 Pass 的機率取決於牌力，如果需要拆大牌 (2) 才能壓，那就 Pass
        const smallestBeat = validMoves[0];
        const sInfo = ddzAnalyze(smallestBeat.cards);
        if (sInfo.val >= 15) return null; // 不值得為了壓隊友的小牌而出 2
    }


    // 【情況 E】 跟牌階段 - 面對敵人 (Check against Enemy)
    // 這裡加入「頂牌」邏輯：如果我是地主的上家 (負責守門)，不能讓地主輕鬆過小牌
    
    const isGatekeeper = (p.role === 'peasant' && App.players[(pIdx + 1) % 3].role === 'landlord');
    
    if (isGatekeeper && topInfo.val < 10) { // 如果地主出小牌 (3~9)
        // 嘗試找一張比較大的牌 (J, Q, K, A) 來頂，而不是出最小的
        // 篩選出大於 J (11) 的牌
        let bigMoves = validMoves.filter(m => ddzAnalyze(m.cards).val >= 11 && ddzAnalyze(m.cards).val <= 14);
        if (bigMoves.length > 0) {
             // 優先出大牌頂住
             return bigMoves[0].cards;
        }
    }

    // 一般情況：出最小能贏的牌
    const bestMove = validMoves[0];
    const moveInfo = ddzAnalyze(bestMove.cards);

    // 炸彈謹慎使用
    if (moveInfo.type === DDZ.TYPES.BOMB || moveInfo.type === DDZ.TYPES.ROCKET) {
        // 如果敵人剩餘牌數還很多 (>10)，且自己是保守型，先忍一手
        if (topPlayer.hand.length > 10 && style === 'conservative') return null;
    }

    // 智慧型 AI 的特殊判斷：不要為了壓一個小對子拆了順子
    if (style === 'smart') {
         // 這裡簡單模擬：如果這張牌是順子的一部分，有 50% 機率不拆 (Pass)
         // (進階邏輯需要更複雜的牌型分析，這裡先從簡)
         if (moveInfo.val > 13 && topInfo.val < 10 && Math.random() < 0.5) return null;
    }

    return bestMove.cards;
}

// 產生通用的 Pass 台詞 (當角色沒有專屬台詞時使用)
function getGenericPassLine(char) {
    const style = getAIStyle(char.id);
    const lines = {
        aggressive: ["這手不要！", "讓給你。", "過！", "嘖，沒牌。"],
        conservative: ["要不起...", "過。", "太大了。", "我忍。"],
        smart: ["暫避鋒芒。", "Pass。", "戰術性放棄。", "你的牌太好了。"],
        balanced: ["過。", "不要。", "Pass。"]
    };
    const pool = lines[style] || lines.balanced;
    return pool[Math.floor(Math.random() * pool.length)];
}

function startDDZ() {
    let d = createDeck(); d.push({s:'★', r:'S', val:13}); d.push({s:'★', r:'B', val:14}); 
    App.deck = d.sort(()=>Math.random()-0.5);
    App.players.forEach(p => { p.hand=[]; p.role='peasant'; p.passed=false; });
    ddzLandlordIdx = -1; ddzBidScore = 0; ddzMulti = 1;

    // Rigging (發牌作弊/技能)
    App.players.forEach((p, i) => {
        if(p.isUser) return;
        if(p.char.id === 'lanlan') {
            const counts = {}; App.deck.forEach(c=>counts[c.r]=(counts[c.r]||0)+1);
            const rank = Object.keys(counts).find(r=>counts[r]===4);
            if(rank) { const bomb = App.deck.filter(c=>c.r===rank); App.deck = App.deck.filter(c=>c.r!==rank); p.hand.push(...bomb); triggerSkill(i, p.char.skills.doudizhu); }
        }
        if(p.char.id === 'aura') {
            const jokers = App.deck.filter(c=>c.r==='S'||c.r==='B');
            if(jokers.length>0) { p.hand.push(...jokers); App.deck = App.deck.filter(c=>c.r!=='S'&&c.r!=='B'); triggerSkill(i, p.char.skills.doudizhu); }
        }
    });

    let pIdx = 0;
    while(App.deck.length > 3) {
        if(App.players[pIdx].hand.length < 17) App.players[pIdx].hand.push(App.deck.pop());
        pIdx = (pIdx + 1) % 3;
        if(App.players.every(p => p.hand.length >= 17)) break;
    }
    App.players.forEach(p => p.hand.sort((a,b)=>getDDZAbs(b)-getDDZAbs(a)));
    renderHand(); updateOpponentVisuals();
    App.turn = Math.floor(Math.random()*3);
    setStatus("BIDDING...");
    setTimeout(() => ddzBidPhase(0, 0), 1000);
}

function ddzBidPhase(currentMax, passCount) {
    if(passCount === 3 && currentMax === 0) { startDDZ(); return; } 
    if(ddzBidScore === 3 || (passCount === 2 && currentMax > 0)) { ddzSetLandlord(ddzLandlordIdx); return; } 
    const pIdx = App.turn; const p = App.players[pIdx];
    document.querySelectorAll('.seat').forEach(s => s.classList.remove('active'));
    if(pIdx < 2) document.getElementById(`seat-${pIdx}`).classList.add('active'); 

    if(p.isUser) {
        const bids = [1, 2, 3].filter(v => v > currentMax);
        const ctrls = document.getElementById('controls'); ctrls.innerHTML = '';
        bids.forEach(v => {
            const btn = document.createElement('button'); btn.className = 'btn-act show'; btn.innerText = `${v} 分`;
            btn.onclick = () => { hideControls(); ddzBidAction(pIdx, v); }; ctrls.appendChild(btn);
        });
        const passBtn = document.createElement('button'); passBtn.className = 'btn-act btn-pass show'; passBtn.innerText = "不叫";
        passBtn.onclick = () => { hideControls(); ddzBidAction(pIdx, 0); }; ctrls.appendChild(passBtn);
        setStatus("YOUR BID");
    } else {
        setTimeout(() => {
            let score = 0; const h = p.hand;
            // AI 叫分邏輯
            const style = getAIStyle(p.char.id);
            let threshold = (style === 'aggressive') ? 1 : (style === 'conservative' ? 2 : 1.5);
            
            if(h.some(c=>c.r==='S') && h.some(c=>c.r==='B')) score = 3;
            else { 
                const twoCnt = h.filter(c=>c.r==='2').length; 
                const jokerCnt = h.filter(c=>c.r==='S'||c.r==='B').length;
                let power = twoCnt + jokerCnt;
                if(power >= 3) score = 3;
                else if(power >= threshold) score = 2;
                else if(power >= 1) score = 1;
            }
            // 積極型更有機率搶
            if (style === 'aggressive' && Math.random() > 0.4 && score < 3) score++;

            if(score > currentMax) ddzBidAction(pIdx, score); else ddzBidAction(pIdx, 0);
        }, 1000);
    }
}

function ddzBidAction(pIdx, val) {
    if(val > 0) {
        ddzLandlordIdx = pIdx; ddzBidScore = val; say(pIdx, 'doudizhu_bid');
        setStatus(`${App.players[pIdx].isUser ? "YOU" : App.players[pIdx].char.name} BID ${val}`);
        App.turn = (App.turn + 1) % 3;
        if(val === 3) ddzSetLandlord(pIdx); else ddzBidPhase(val, 0);
    } else {
        // 如果沒有定義 doudizhu_bid 語音，可能會沒聲音，這裡可以加強
        say(pIdx, 'doudizhu_bid'); 
        App.turn = (App.turn + 1) % 3;
        ddzBidPhase(ddzBidScore, ddzBidScore > 0 ? 2 : 3);
    }
}

function ddzSetLandlord(idx) {
    App.turn = idx; const kitty = App.deck; 
    App.players[idx].hand.push(...kitty); App.players[idx].hand.sort((a,b)=>getDDZAbs(b)-getDDZAbs(a));
    App.players.forEach((p, i) => { p.role = (i === idx) ? 'landlord' : 'peasant'; });
    const kz = document.getElementById('ddz-kitty');
    kz.style.display = 'flex'; kz.innerHTML = kitty.map(c => `<div class="kitty-card" style="color:${['♥','♦'].includes(c.s)?'red':'black'}">${c.r}</div>`).join('');
    setStatus(`LANDLORD: P${idx}`); updateOpponentVisuals(); if(App.players.find(p=>p.isUser).role === 'landlord') renderHand(); 
    if(App.players[idx].char && App.players[idx].char.id === 'xiaomu') { triggerSkill(idx, App.players[idx].char.skills.doudizhu); alert("小目發動資本運作！"); }
    App.table = []; setTimeout(ddzTurn, 1500);
}

function ddzTurn() {
    const winner = App.players.find(p => p.hand.length === 0);
    if(winner) { const userWin = (winner.role === App.players.find(p=>p.isUser).role); showResult(userWin, userWin ? ddzBidScore*100*ddzMulti : -ddzBidScore*100*ddzMulti, winner.role.toUpperCase() + " WINS!"); return; }
    
    const pIdx = App.turn; const p = App.players[pIdx];
    document.querySelectorAll('.seat').forEach(s => s.classList.remove('active')); if(!p.isUser) document.getElementById(`seat-${pIdx}`).classList.add('active');
    const topObj = App.table.length > 0 ? App.table[App.table.length-1] : null;
    const isFree = (!topObj || topObj.owner === pIdx);

    if(p.isUser) {
        setStatus(isFree ? "YOUR TURN (Free)" : "YOUR TURN");
        setControls("PLAY", "PASS", ()=>ddzUserPlay(isFree, topObj), isFree ? null : ()=>ddzUserPass());
        document.getElementById('btn-pass').style.display = isFree ? 'none' : 'block';
    } else {
        setStatus(`${p.char.name} thinking...`);
        setTimeout(() => {
            let playCards = ddzAIDecide(pIdx, topObj);
            
            // 技能：海神給牌邏輯 (簡單版)
            if(p.char.id === 'poseidon' && p.role === 'peasant') {
                 // 海神特殊邏輯可在此擴充
            }

            if(playCards) {
                // --- 出牌 ---
                p.hand = p.hand.filter(c => !playCards.includes(c));
                App.table.push({cards:playCards, owner:pIdx, role:p.role});
                const info = ddzAnalyze(playCards);
                if(info.type === DDZ.TYPES.BOMB || info.type === DDZ.TYPES.ROCKET) { ddzMulti *= 2; sfx('sfx-win'); alert("倍率翻倍！ x" + ddzMulti); }
                renderTable(playCards); sfx('sfx-card'); 
                
                // 出牌台詞
                say(pIdx, 'play');
                if(p.hand.length <= 2) say(pIdx, 'win');
                updateOpponentVisuals(); App.turn = (App.turn + 1) % 3; ddzTurn();

            } else {
                // --- Pass (修復台詞邏輯) ---
                // 先嘗試觸發角色設定的 pass 台詞
                if (p.char.lines.doudizhu_pass) {
                    say(pIdx, 'doudizhu_pass');
                } else {
                    // 如果沒有設定，使用通用台詞
                    const bubble = document.querySelector(`#seat-${pIdx} .bubble`);
                    if(bubble) {
                        bubble.innerText = getGenericPassLine(p.char);
                        bubble.classList.add('show');
                        setTimeout(() => bubble.classList.remove('show'), 2000);
                    }
                }
                
                // 增加一點延遲讓玩家看到 "Pass"
                setTimeout(() => {
                    updateOpponentVisuals(); 
                    App.turn = (App.turn + 1) % 3; 
                    ddzTurn();
                }, 1000); // Pass 後等待 1 秒
            }
        }, 1000 + Math.random()*500);
    }
}

function ddzUserPlay(isFree, topObj) {
    const user = App.players.find(p=>p.isUser); const userIdx = App.players.indexOf(user);
    const sel = user.hand.filter(c=>c.sel); if(sel.length===0) return;
    const info = ddzAnalyze(sel); if(!info) { alert("無效牌型！"); return; }
    if(!isFree) { const topInfo = ddzAnalyze(topObj.cards); if(!ddzCanBeat(info, topInfo)) { alert("打不過！"); return; } }
    
    user.hand = user.hand.filter(c=>!c.sel);
    App.table.push({cards:sel, owner:userIdx, role:user.role});
    if(info.type === DDZ.TYPES.BOMB || info.type === DDZ.TYPES.ROCKET) { ddzMulti *= 2; sfx('sfx-win'); }
    renderTable(sel); renderHand(); hideControls(); sfx('sfx-card');
    App.turn = (userIdx + 1) % 3; setTimeout(ddzTurn, 500);
}

function ddzUserPass() { 
    const uIdx = App.players.findIndex(p=>p.isUser); 
    hideControls(); 
    // 玩家 Pass 時也可以顯示氣泡 (選用)
    const bubble = document.querySelector(`#seat-1 .bubble`); // 假設玩家在中間或下方
    // say(uIdx, 'lose'); // 玩家通常不說話，或可自行添加
    App.turn = (uIdx + 1) % 3; ddzTurn(); 
}

/* --- UNO ENGINE (CHATTERBOX UPDATE) --- */
function startUNO() { 
    App.deck = createUnoDeck(); 
    App.players.forEach(p => { p.hand = []; p.unoSaid = false; p.vulnerable = false; }); 
    distributeSkillCards(); 
    let first = App.deck.pop(); while(first.type === 'wild' || first.type === 'wild4') { App.deck.unshift(first); first = App.deck.pop(); } 
    App.table = [first]; App.turn = Math.floor(Math.random()*4); App.direction = 1; 
    renderHand(); renderTable([first]); updateOpponentVisuals(); setStatus("UNO START!"); setTimeout(unoTurn, 1500); 
}
function unoTurn() { 
    const winners = App.players.filter(p => p.hand.length === 0); 
    if(winners.length > 0) { const userWon = winners[0].isUser; setTimeout(() => showResult(userWon, userWon ? 3000 : -1000, userWon ? "UNO VICTORY!" : "UNO DEFEAT"), 1000); return; } 
    const pIdx = App.turn; const p = App.players[pIdx]; const top = App.table[App.table.length - 1]; 
    document.querySelectorAll('.seat').forEach(s=>s.classList.remove('active')); if(pIdx < 3) document.getElementById(`seat-${pIdx}`).classList.add('active'); 
    
    if(App.unoStack > 0) { setTimeout(() => unoAcceptPenalty(pIdx), 1000); return; } 
    
    if(p.isUser) { 
        setStatus("YOUR TURN"); 
        const playable = p.hand.filter(c => unoCheck(c, top)); 
        const ctrls = document.getElementById('controls'); ctrls.innerHTML = ''; 
        if(playable.length === 0) { const btnDraw = document.createElement('button'); btnDraw.className = 'btn-act show'; btnDraw.innerText = "DRAW"; btnDraw.onclick = () => unoDraw(pIdx); ctrls.appendChild(btnDraw); } 
    } else { 
        setStatus(`${p.char.name}'s TURN`); 
        if(p.char.id === 'hades') p.unoSaid = true;
        setTimeout(() => { 
            const playable = p.hand.filter(c => unoCheck(c, top)); 
            if(playable.length > 0) { 
                const playCard = playable[0]; 
                if(playCard.color === 'black') playCard.tempColor = ['red','yellow','green','blue'][Math.floor(Math.random()*4)];
                p.hand = p.hand.filter(c => c !== playCard); unoExecute(pIdx, playCard); 
            } else { unoDraw(pIdx); } 
        }, 1200); 
    } 
}
function unoAcceptPenalty(pIdx) { 
    hideControls(); const p = App.players[pIdx]; let count = App.unoStack; 
    if(p.char && p.char.id === 'venato' && Math.random() < 0.3) { 
        triggerSkill(pIdx, p.char.skills.uno); App.turn = getNextIdx(); setTimeout(() => unoTurn(), 1000); return;
    }
    if(p.char && p.char.id === 'mollie') { count = 1; triggerSkill(pIdx, p.char.skills.uno); }
    if(p.char && p.char.id === 'miras') { count = Math.floor(count/2); triggerSkill(pIdx, p.char.skills.uno); }
    if(p.char && p.char.id === 'lynn') { count = Math.max(0, count-1); triggerSkill(pIdx, p.char.skills.uno); }
    
    App.unoStack = 0; if(count > 0) say(pIdx, 'uno_hit'); // ★ 強制說話
    let dLoop = 0; const deal = () => { 
        if(dLoop >= count) { p.unoSaid = false; updateOpponentVisuals(); setTimeout(unoNextTurn, 800); return; } 
        if(App.deck.length === 0) refillUnoDeck(); if(App.deck.length > 0) p.hand.push(App.deck.pop()); 
        dLoop++; if(p.isUser) renderHand(); else updateOpponentVisuals(); setTimeout(deal, 150); 
    }; deal(); 
}
function userShoutUno() {
    const p = App.players.find(p=>p.isUser); if (p.hand.length <= 2 && !p.unoSaid) { p.unoSaid = true; p.vulnerable = false; sfx('sfx-win'); setStatus("YOU SHOUTED UNO!"); document.getElementById('player-badge').classList.add('show'); updateOpponentVisuals(); }
}
function onSeatClick(targetIdx) { 
    if(App.gameId !== 'uno') return; const target = App.players[targetIdx]; const seat = document.getElementById(`seat-${targetIdx}`); seat.classList.add('shake'); setTimeout(() => seat.classList.remove('shake'), 400);
    if(target.hand.length === 1 && !target.unoSaid) { catchPlayer(targetIdx, 3); } else { if(target.unoSaid) say(targetIdx, 'uno_poke_late'); else say(targetIdx, 'uno_poke_early'); }
}
function catchPlayer(victimIdx, catcherIdx) { 
    const victim = App.players[victimIdx]; 
    if(victim.char && (victim.char.id==='jonona'||victim.char.id==='costa') && Math.random()>0.5) { 
        triggerSkill(victimIdx, victim.char.skills.uno); victim.unoSaid = true; victim.vulnerable = false; say(victimIdx, 'uno_late'); updateOpponentVisuals(); return; 
    } 
    if(victim.vulnerable || (victim.hand.length===1 && !victim.unoSaid && victim.char.id!=='hades')) { 
        victim.vulnerable = false; 
        setTimeout(() => { 
            say(victimIdx, 'uno_forgot'); if(App.deck.length < 2) refillUnoDeck(); 
            victim.hand.push(App.deck.pop()); if(App.deck.length > 0) victim.hand.push(App.deck.pop()); 
            victim.unoSaid = false; if(victim.isUser) renderHand(); else updateOpponentVisuals(); 
        }, 1000); 
    } 
}
function unoUserClick(c) { 
    if(App.gameId !== 'uno' || App.turn !== App.players.length-1) return; const top = App.table[App.table.length - 1]; 
    if(App.unoStack > 0) { setTimeout(()=>unoAcceptPenalty(App.players.length-1), 500); return; }
    const user = App.players.find(p=>p.isUser);
    if(unoCheck(c, top)) { if(c.color === 'black') showColorPick(c); else { user.hand = user.hand.filter(x => x !== c); unoExecute(App.players.length-1, c); } } else setStatus("CANNOT PLAY"); 
}
function showColorPick(c) { const ctrls = document.getElementById('controls'); ctrls.innerHTML = ''; ['red', 'yellow', 'green', 'blue'].forEach(col => { const btn = document.createElement('button'); btn.className = `btn-act btn-color btn-${col} show`; btn.innerText = col.toUpperCase(); btn.onclick = () => { c.tempColor = col; const user=App.players.find(p=>p.isUser); user.hand = user.hand.filter(x => x !== c); unoExecute(App.players.length-1, c); }; ctrls.appendChild(btn); }); }
function unoCheck(c, top) { if(c.color === 'black') return true; if(c.color === (top.tempColor || top.color)) return true; if(c.val === top.val) return true; return false; }

function unoExecute(pIdx, c) { 
    const p = App.players[pIdx]; 
    if(p.hand.length === 1) { 
        if(p.isUser) { if(!p.unoSaid) p.vulnerable = true; } 
        else { if(Math.random() < p.char.uno_shout_rate) { p.unoSaid = true; say(pIdx, 'uno_uno'); } else { p.vulnerable=true; setTimeout(()=>{if(p.vulnerable && p.hand.length===1){p.unoSaid=true; p.vulnerable=false; say(pIdx,'uno_late'); updateOpponentVisuals();}}, 3000); } } 
    } else { p.unoSaid = false; p.vulnerable = false; } 
    App.table.push(c); renderTable([c]); sfx('sfx-card'); if(p.isUser) { renderHand(); hideControls(); } else { updateOpponentVisuals(); } 
    
    if(p.char && p.char.id==='xiaomu' && c.color==='black') { triggerSkill(pIdx, p.char.skills.uno); }
    if(p.char && p.char.id==='poseidon' && c.type==='wild4') { triggerSkill(pIdx, p.char.skills.uno); alert("海神：大海嘯！"); }

    let skip = false; 
    if(c.type === 'draw2') { App.unoStack += 2; }
    if(c.type === 'wild4') { App.unoStack += 4; }
    if(App.unoStack > 0) { setTimeout(unoNextTurn, 1000); return; }

    if(c.type === 'skip') { skip = true; say(pIdx, 'uno_attack'); } 
    if(c.type === 'reverse') { 
        if(App.players.length === 2) skip = true; else App.direction *= -1; 
        say(pIdx, 'play');
    } else {
        say(pIdx, 'play'); // ★ 強制說話
    }
    
    if(p.char && p.char.id==='narcissus' && c.type==='reverse') { triggerSkill(pIdx, p.char.skills.uno); skip = true; }

    if(skip) { 
        const victimIdx = getNextIdx(); const victim = App.players[victimIdx];
        if(!victim.isUser && victim.char.id==='peter' && Math.random()>0.5) { triggerSkill(victimIdx, victim.char.skills.uno); App.turn = victimIdx; setTimeout(unoTurn, 1000); } 
        else { setTimeout(() => say(victimIdx, 'uno_skip'), 500); App.turn = getNextIdx(); setTimeout(unoNextTurn, 1500); } 
    } else { setTimeout(unoNextTurn, 1000); } 
}
function unoNextTurn() { App.turn = getNextIdx(); unoTurn(); }
function getNextIdx() { return (App.turn + App.direction + App.players.length) % App.players.length; }
function unoDraw(pIdx) { 
    const p = App.players[pIdx]; const top = App.table[App.table.length - 1]; 
    if(App.deck.length === 0) refillUnoDeck(); 
    const c = App.deck.pop(); p.hand.push(c); sfx('sfx-card'); 
    
    if(p.isUser) { renderHand(); hideControls(); if(unoCheck(c, top)) unoUserClick(c); else { say(pIdx, 'uno_hit'); setTimeout(unoNextTurn, 800); } }
    else { updateOpponentVisuals(); if(unoCheck(c, top)) { if(c.color==='black') c.tempColor='red'; unoExecute(pIdx, c); } else { say(pIdx, 'uno_draw_many'); setTimeout(unoNextTurn, 800); } }
}
function refillUnoDeck() { if(App.table.length <= 1) return; const top = App.table.pop(); const leftovers = App.table; App.table = [top]; leftovers.forEach(c => delete c.tempColor); App.deck = leftovers.sort(() => Math.random() - 0.5); }
function createUnoDeck() { const colors = ['red', 'yellow', 'green', 'blue']; const deck = []; colors.forEach(col => { deck.push({color:col, val:'0', type:'num'}); for(let i=1; i<=9; i++) { deck.push({color:col, val:i+'', type:'num'}); deck.push({color:col, val:i+'', type:'num'}); } ['skip', 'reverse', 'draw2'].forEach(t => { deck.push({color:col, val:t, type:t}); deck.push({color:col, val:t, type:t}); }); }); for(let i=0; i<4; i++) { deck.push({color:'black', val:'W', type:'wild'}); deck.push({color:'black', val:'+4', type:'wild4'}); } return deck.sort(() => Math.random() - 0.5); }

/* --- BIG 2 ENGINE --- */
let kleionDuel = false; let peterCurse = false;
const B2 = { TYPES: { INVALID:0, SINGLE:1, PAIR:2, FULLHOUSE:3, IRON:4, FLUSH_STR:5 }, RANKS: ['3','4','5','6','7','8','9','10','J','Q','K','A','2'], SUITS: ['♣','♦','♥','♠'] };
function getRankVal(r) { return B2.RANKS.indexOf(r); }
function getSuitVal(s) { return B2.SUITS.indexOf(s); }
function getAbsVal(c) { return getRankVal(c.r) * 4 + getSuitVal(c.s); }

function b2Analyze(cards) {
    if(!cards || cards.length === 0) return null;
    const s = [...cards].sort((a,b) => getAbsVal(a) - getAbsVal(b));
    const len = s.length; const r = s.map(c => getRankVal(c.r)); const maxCard = s[len-1];
    if(len === 1) return { type: B2.TYPES.SINGLE, val: getAbsVal(maxCard), cards: s, max: maxCard };
    if(len === 2) { return (r[0] === r[1]) ? { type: B2.TYPES.PAIR, val: getAbsVal(maxCard), cards: s, max: maxCard } : { type: B2.TYPES.INVALID }; }
    if(len === 3 || len === 4) return { type: B2.TYPES.INVALID };
    if(len === 5) {
        const counts = {}; r.forEach(x => counts[x] = (counts[x]||0)+1); const v = Object.values(counts);
        const isFlush = s.every(c => c.s === s[0].s); let isStraight = true; for(let i=0; i<4; i++) { if(r[i+1] !== r[i]+1) isStraight = false; }
        if(isFlush && isStraight) return { type: B2.TYPES.FLUSH_STR, val: getAbsVal(maxCard), cards: s };
        if(v.includes(4)) { const q = parseInt(Object.keys(counts).find(k=>counts[k]===4)); return { type: B2.TYPES.IRON, val: q, cards: s }; }
        if(v.includes(3) && v.includes(2)) { const t = parseInt(Object.keys(counts).find(k=>counts[k]===3)); return { type: B2.TYPES.FULLHOUSE, val: t, cards: s }; }
    }
    return { type: B2.TYPES.INVALID };
}

function b2CheckWin(my, top) {
    if(!my || my.type === B2.TYPES.INVALID) return false;
    if(!top) return true;
    if(my.type >= B2.TYPES.FULLHOUSE) {
        if(top.type >= B2.TYPES.FULLHOUSE) {
            if(my.type > top.type) return true; if(my.type < top.type) return false; return my.val > top.val;
        }
        return false; 
    }
    if(my.type !== top.type) return false; return my.val > top.val;
}

function b2AI_AnalyzeHandStructure(hand) {
    const sorted = [...hand].sort((a,b) => getAbsVal(a) - getAbsVal(b));
    const lockedCards = new Set(); const monsters = [];
    for(let i=0; i<=sorted.length-5; i++) { const chunk = sorted.slice(i, i+5); const info = b2Analyze(chunk); if(info.type === B2.TYPES.FLUSH_STR) { monsters.push(info); chunk.forEach(c => lockedCards.add(c)); } }
    const map = {}; sorted.forEach(c => { if(!lockedCards.has(c)) { if(!map[c.r]) map[c.r]=[]; map[c.r].push(c); } });
    Object.values(map).filter(arr => arr.length === 4).forEach(quad => {
        quad.forEach(c => lockedCards.add(c)); const kicker = sorted.find(c => !lockedCards.has(c) && !quad.includes(c));
        if(kicker) monsters.push({ type: B2.TYPES.IRON, val: getRankVal(quad[0].r), cards: [...quad, kicker] });
    });
    return { lockedCards, monsters };
}

function b2AIDecide(pIdx, topCards) {
    const p = App.players[pIdx]; const hand = [...p.hand].sort((a,b) => getAbsVal(a) - getAbsVal(b)); const charId = p.char.id;
    const isFree = (App.isFirstTurn || App.lastWinner === pIdx);
    const topInfo = isFree ? null : b2Analyze(topCards.cards);
    
    const isSmart = ['peter', 'venato', 'aura', 'xiaomu'].includes(charId);
    const isAggro = ['lanlan', 'kleion', 'poseidon', 'novian'].includes(charId);
    const isConservative = ['jonona', 'mollie', 'lynn', 'costa'].includes(charId);

    const structure = b2AI_AnalyzeHandStructure(hand); const lockedSet = structure.lockedCards;
    let moves = [];
    hand.forEach(c => moves.push({cards:[c]}));
    for(let i=0; i<hand.length-1; i++) { if(hand[i].r === hand[i+1].r) moves.push({cards:[hand[i], hand[i+1]]}); }
    structure.monsters.forEach(m => moves.push({cards: m.cards}));
    const map = {}; hand.forEach(c => { if(!lockedSet.has(c)) { map[c.r] = (map[c.r]||[]).concat(c); } });
    const trips = Object.values(map).filter(arr=>arr.length===3); const pairs = Object.values(map).filter(arr=>arr.length>=2);
    trips.forEach(t => { const pair = pairs.find(pa => pa[0].r !== t[0].r); if(pair) moves.push({cards: [...t, ...pair.slice(0,2)]}); });

    let validMoves = moves.filter(m => {
        const myInfo = b2Analyze(m.cards); if(!myInfo || myInfo.type === B2.TYPES.INVALID) return false;
        if(App.isFirstTurn) return m.cards.some(c => c.s==='♣' && c.r==='3');
        if(kleionDuel && m.cards.length !== 1) return false; if(peterCurse && m.cards.length === 2) return false;
        if(charId==='lanlan' && myInfo.type===B2.TYPES.SINGLE && topInfo && topInfo.type===B2.TYPES.SINGLE) {
            if(myInfo.cards[0].r==='3' && myInfo.cards[0].s==='♦' && getRankVal(topInfo.max)===12) return true;
        }
        return b2CheckWin(myInfo, topInfo);
    });

    if(validMoves.length === 0) return null;
    validMoves.sort((a,b) => b2Analyze(a.cards).val - b2Analyze(b.cards).val);

    if(isFree) {
        if(App.isFirstTurn) { const c3 = validMoves.find(m => m.cards.some(c=>c.s==='♣'&&c.r==='3')); return c3 ? c3.cards : validMoves[0].cards; }
        if(isSmart && structure.monsters.length > 0) {
            const smallMoves = validMoves.filter(m => b2Analyze(m.cards).type < B2.TYPES.IRON);
            if(smallMoves.length > 0) return smallMoves[0].cards;
        }
        if(isAggro) { const monster = validMoves.find(m => b2Analyze(m.cards).type >= B2.TYPES.IRON); if(monster) return monster.cards; }
        if(isSmart && hand.length === 2) {
            const bigCard = hand[1]; if(getRankVal(bigCard.r) >= 11) { 
                const playBig = validMoves.find(m => m.cards.length===1 && m.cards[0]===bigCard); if(playBig) return playBig.cards;
            }
        }
        return validMoves[0].cards; 
    }

    if(topInfo && topInfo.type >= B2.TYPES.FULLHOUSE) {
        const killer = validMoves.find(m => { const inf = b2Analyze(m.cards); return inf.type >= B2.TYPES.IRON && b2CheckWin(inf, topInfo); });
        if(killer && (isAggro || isSmart)) return killer.cards; 
    }
    if(isSmart && topInfo && topInfo.type === B2.TYPES.SINGLE && topInfo.val < 30) {
        const best = validMoves[0]; const info = b2Analyze(best.cards);
        if(getRankVal(info.max) >= 11 && hand.length > 5 && Math.random() < 0.5) return null;
    }
    return validMoves[0].cards;
}

function startB2() {
    App.deck = createDeck(); App.players.forEach(p => p.hand=[]);
    while(App.deck.length > 0) { for(let i=0; i<4; i++) if(App.deck.length) App.players[i].hand.push(App.deck.pop()); }
    
    const xm = App.players.find(x => x.char && x.char.id === 'xiaomu'); const u = App.players[3];
    if(xm && !xm.isUser && u.hand.some(c => c.r==='2')) {
        const idx = u.hand.findIndex(c => c.r==='2'); xm.hand.push(u.hand.splice(idx,1)[0]); u.hand.push(xm.hand.shift()); 
        triggerSkill(App.players.indexOf(xm), xm.char.skills.bigtwo);
    }
    distributeSkillCards(); 

    const laz = App.players.find(x => x.char && x.char.id === 'lazar');
    if(laz && u.hand.some(c => c.r==='2')) {
        setTimeout(()=>{
            triggerSkill(App.players.indexOf(laz), laz.char.skills.bigtwo); alert("拉扎爾發現你有2！重洗你的手牌！");
            u.hand.push(...createDeck().slice(0, u.hand.length)); u.hand.splice(0, u.hand.length/2); renderHand();
        }, 800);
    }

    App.table = []; let start = -1;
    App.players.forEach((p,i) => { p.hand.sort((a,b)=>getAbsVal(a)-getAbsVal(b)); if(p.hand.some(c=>c.s==='♣'&&c.r==='3')) start=i; });
    if(start === -1) { start=0; App.players[0].hand[0] = {s:'♣',r:'3',val:0}; }
    App.turn = start; App.lastWinner = start; App.isFirstTurn = true; kleionDuel = false; peterCurse = false;
    renderHand(); updateOpponentVisuals(); setStatus("BIG 2 START!"); setTimeout(b2Turn, 1500);
}

function b2Turn() {
    const winnerIdx = App.players.findIndex(p => p.hand.length === 0);
    if(winnerIdx !== -1) { const isUser = (winnerIdx === 3); setTimeout(() => showResult(isUser, isUser?2000:-500, isUser?"BIG 2 KING!":"LOSE..."), 500); return; }
    const pIdx = App.turn; const p = App.players[pIdx];
    document.querySelectorAll('.seat').forEach(s => s.classList.remove('active')); if(pIdx < 3) document.getElementById(`seat-${pIdx}`).classList.add('active');
    
    const isFree = (App.isFirstTurn || App.lastWinner === pIdx);
    const topObj = App.table.length > 0 ? App.table[App.table.length-1] : null;

    if(!p.isUser && p.char.id==='miras' && !p.swapped && p.hand.length<=5) {
        triggerSkill(pIdx, p.char.skills.bigtwo); p.swapped = true;
        setTimeout(()=>{
            const u = App.players[3]; if(u.hand.length>2) { p.hand.push(u.hand.pop(), u.hand.pop()); u.hand.push(p.hand.shift(), p.hand.shift()); }
            alert("蜜拉思發動手牌交換！"); renderHand(); updateOpponentVisuals(); b2Turn();
        }, 1000); return;
    }

    if(p.isUser) {
        setStatus(isFree ? "YOUR TURN (Free)" : "YOUR TURN");
        setControls("PLAY", "PASS", ()=>b2UserPlay(isFree, topObj), (isFree || App.isFirstTurn) ? null : ()=>b2UserPass());
        document.getElementById('btn-pass').style.display = (isFree || App.isFirstTurn) ? 'none' : 'block';
    } else {
        setStatus(`${p.char.name} is thinking...`);
        setTimeout(() => {
            let playCards = b2AIDecide(pIdx, topObj);
            if(isFree && (!playCards || playCards.length===0)) playCards = [p.hand[0]];

            if(playCards) {
                p.hand = p.hand.filter(c => !playCards.includes(c));
                App.table.push({cards:playCards, owner:pIdx});
                App.lastWinner = pIdx; 
                renderTable(playCards); sfx('sfx-card'); say(pIdx, 'play');
                if(App.isFirstTurn) App.isFirstTurn = false;

                if(p.char.id==='kleion' && playCards.length===1) { kleionDuel=true; triggerSkill(pIdx, p.char.skills.bigtwo); } else kleionDuel=false;
                if(p.char.id==='costa' && topObj && !isFree) {
                     const myT = b2Analyze(playCards); const topT = b2Analyze(topObj.cards);
                     if(myT.type===topT.type && playCards[0].s===topObj.cards[0].s) {
                         triggerSkill(pIdx, p.char.skills.bigtwo); if((App.turn+1)%4===3) alert("科絲塔模仿！暫停！"); App.turn = (App.turn+1)%4; 
                     }
                }
                if(p.char.id==='mollie' && !p.mollieUsed && playCards.length===1) {
                    if(getRankVal(playCards[0].r)>=11 && p.hand.length>0) {
                        p.mollieUsed=true; triggerSkill(pIdx, p.char.skills.bigtwo);
                        const nextP = App.players[(pIdx+1)%4]; nextP.hand.push(playCards[0]); App.table.pop(); renderTable([]);
                        alert(`茉莉送牌給 ${nextP.isUser?"你":nextP.char.name}！`); if(nextP.isUser) renderHand();
                    }
                }
                if(p.char.id==='lynn' && playCards.length===5) {
                    triggerSkill(pIdx, p.char.skills.bigtwo);
                    let minL = 99; let v = null; App.players.forEach((t,ti)=>{if(ti!==pIdx && t.hand.length>0 && t.hand.length<minL){minL=t.hand.length;v=t;}});
                    if(v && App.deck.length>0) { v.hand.push(App.deck.pop()); alert("林恩發動絕望稅收！有人被迫抽牌！"); if(v.isUser) renderHand(); }
                }
                if(p.char.id==='narcissus' && playCards.length===1 && (playCards[0].r==='A'||playCards[0].r==='2')) {
                    triggerSkill(pIdx, p.char.skills.bigtwo); App.turn = (App.turn+1)%4;
                }
                if(p.char.id==='novian' && b2Analyze(playCards).type===B2.TYPES.STRAIGHT && p.hand.length>0) {
                    triggerSkill(pIdx, p.char.skills.bigtwo); p.hand.splice(0,1);
                }
                if(p.char.id==='poseidon' && playCards.length===5 && p.hand.length>0) {
                    triggerSkill(pIdx, p.char.skills.bigtwo); p.hand.splice(0,1);
                }

                if(p.hand.length===1) say(pIdx, 'win');
            } else {
                say(pIdx, 'lose');
                if(p.char.id==='peter') { peterCurse=true; triggerSkill(pIdx, p.char.skills.bigtwo); } else peterCurse=false;
            }
            updateOpponentVisuals(); App.turn = (App.turn + 1) % 4; b2Turn();
        }, 1000 + Math.random()*500);
    }
}

function b2UserPlay(isFree, topObj) {
    const sel = App.players[3].hand.filter(c=>c.sel); if(sel.length===0) return;
    const myInfo = b2Analyze(sel); 
    if(!myInfo || myInfo.type === B2.TYPES.INVALID) { alert("無效牌型！(只允許：單/對/葫/鐵/同花順)"); return; }
    if(App.isFirstTurn && !sel.some(c=>c.s==='♣'&&c.r==='3')) { alert("需出梅花3"); return; }
    if(kleionDuel && sel.length!==1) { alert("單挑中！"); return; }
    if(peterCurse && sel.length===2) { alert("被詛咒！"); return; }
    if(!isFree) { const topInfo = b2Analyze(topObj.cards); if(!b2CheckWin(myInfo, topInfo)) { alert("太小或牌型不符！"); return; } }
    
    App.players[3].hand = App.players[3].hand.filter(c=>!c.sel);
    App.table.push({cards:sel, owner:3}); App.lastWinner = 3;
    renderTable(sel); renderHand(); hideControls(); sfx('sfx-card');
    
    if(App.isFirstTurn) App.isFirstTurn = false;
    kleionDuel=false; peterCurse=false;
    App.turn=0; setTimeout(b2Turn, 500);
}
function b2UserPass() { hideControls(); say(3, 'lose'); App.turn=0; b2Turn(); }

/* --- OTHER GAMES --- */
function startRB() { updateScore(-500); document.getElementById('table-cards').innerHTML = ''; setStatus("RED OR BLACK?"); setControls("RED", "BLACK", ()=>resRB('red'), ()=>resRB('black')); }
function resRB(pick) { hideControls(); const isRed = Math.random()>0.5; const s=isRed?(Math.random()>.5?'♥':'♦'):'♠'; const r=['A','K','Q','J'][Math.floor(Math.random()*4)]; renderTable([{s,r}]); sfx('sfx-card'); const win=(pick==='red'&&isRed)||(pick==='black'&&!isRed); setTimeout(()=>{if(win){say(0,'lose');showResult(true,1000);}else{say(0,'win');showResult(false,-500);}},1000); }

function startBJ() { 
    updateScore(-500); App.deck = createDeck(); 
    App.players[0].hand = [App.deck.pop(), App.deck.pop()]; // Dealer
    App.players[1].hand = [App.deck.pop(), App.deck.pop()]; // User (Index 1)
    renderHand(); updateBJScore(); setStatus("YOUR TURN"); setControls("HIT", "STAND", bjHit, bjStand); 
}
function bjHit() { 
    App.players[1].hand.push(App.deck.pop()); renderHand(); updateBJScore(); sfx('sfx-card'); 
    if(bjVal(App.players[1].hand)>21) { setStatus("BUST!"); setTimeout(()=>showResult(false, -500, "You Busted"), 1000); } 
}
function bjStand() { 
    hideControls(); setStatus("DEALER TURN"); const op = App.players[0]; 
    const loop = () => { 
        const dVal = bjVal(op.hand); document.getElementById('dealer-score').innerText = dVal; document.getElementById('dealer-score').style.display='block'; 
        if(dVal<17) { op.hand.push(App.deck.pop()); setTimeout(loop, 1000); } 
        else { renderTable(op.hand); const uVal = bjVal(App.players[1].hand); setTimeout(() => { if(dVal>21) showResult(true, 1000, "Dealer Bust"); else if(uVal>dVal) showResult(true, 1000); else if(uVal==dVal) showResult('push', 500); else showResult(false, -500); }, 1000); } 
    }; setTimeout(loop, 500); 
}
function bjVal(h) { let s=0,a=0; h.forEach(c=>{ if(['J','Q','K'].includes(c.r))s+=10; else if(c.r==='A'){s+=11;a++;} else s+=parseInt(c.r); }); while(s>21 && a>0){s-=10;a--;} return s; }
function updateBJScore() { const val = bjVal(App.players[1].hand); const el = document.getElementById('bj-score'); el.style.display = 'block'; el.innerText = val; el.style.borderColor = val>21 ? 'red' : 'var(--gold)'; }

function startOM() { 
    let d = createDeck().slice(0,52); d.push({s:'🤡',r:'JK'}); let i=0; 
    while(d.length>0){ App.players[i].hand.push(d.pop()); i=(i+1)%4; } 
    App.players.forEach(p=>cleanPairs(p.hand)); renderHand(); updateOpponentVisuals(); App.turn = 0; setStatus("GAME START"); setTimeout(omTurn, 1500); 
}
function cleanPairs(h) { const m={}; h.forEach(c=>m[c.r]=(m[c.r]||0)+1); for(let r in m){ if(m[r]>=2 && r!=='JK'){ let rem=0; for(let i=h.length-1;i>=0;i--){if(h[i].r===r && rem<2){h.splice(i,1);rem++;}} } } }
function omTurn() { 
    const active = App.players.filter(p=>p.hand.length>0); if(active.length<=1) { const uHas = App.players[3].hand.length>0; setTimeout(() => showResult(!uHas, uHas?-500:2000), 1000); return; } 
    while(App.players[App.turn].hand.length===0) App.turn=(App.turn+1)%4; const pIdx = App.turn; const picker = App.players[pIdx]; 
    let tIdx = (pIdx-1+4)%4; while(App.players[tIdx].hand.length===0) tIdx=(tIdx-1+4)%4; const target = App.players[tIdx]; 
    document.querySelectorAll('.seat').forEach(s=>s.classList.remove('active')); if(pIdx<3) document.getElementById(`seat-${pIdx}`).classList.add('active'); 
    if(picker.isUser) { setStatus("YOUR TURN"); const zone = document.getElementById('table-cards'); zone.innerHTML = ''; target.hand.forEach((c,i)=>{ const el = document.createElement('div'); el.className='card back'; el.onclick = ()=>omUserPick(target, i); zone.appendChild(el); }); } 
    else { setTimeout(()=>{ const r = Math.floor(Math.random()*target.hand.length); const c = target.hand.splice(r,1)[0]; picker.hand.push(c); cleanPairs(picker.hand); updateOpponentVisuals(); if(target.isUser) renderHand(); say(pIdx, 'play'); sfx('sfx-card'); App.turn=(App.turn+1)%4; omTurn(); }, 1200); } 
}
function omUserPick(target, idx) { const c = target.hand.splice(idx,1)[0]; App.players[3].hand.push(c); sfx('sfx-card'); document.getElementById('table-cards').innerHTML = ''; renderTable([c]); cleanPairs(App.players[3].hand); renderHand(); updateOpponentVisuals(); if(c.r==='JK') document.getElementById('msg-large').innerText="JOKER!"; setTimeout(()=>{ document.getElementById('table-cards').innerHTML = ''; App.turn=(App.turn+1)%4; omTurn(); }, 1000); }

/* --- HELPERS --- */
function createDeck() { const s=['♣','♦','♥','♠'], r=['3','4','5','6','7','8','9','10','J','Q','K','A','2']; let d=[]; s.forEach((ss,i)=>r.forEach((rr,j)=>d.push({s:ss,r:rr,val:j*4+i}))); return d.sort(()=>Math.random()-0.5); }
function updateScore(v) { App.coins+=v; updateUI(); }
function setStatus(t) { const b=document.getElementById('status-bar'); b.innerText=t; b.classList.add('active'); setTimeout(()=>b.classList.remove('active'),500); }
function setControls(l1,l2,f1,f2) { const c = document.getElementById('controls'); c.innerHTML = `<button class="btn-act btn-pass" id="btn-pass">${l2}</button><button class="btn-act" id="btn-play">${l1}</button>`; const b1=document.getElementById('btn-play'), b2=document.getElementById('btn-pass'); if(l1) { b1.onclick=f1; setTimeout(()=>b1.classList.add('show'),10); } else b1.style.display='none'; if(l2) { b2.onclick=f2; setTimeout(()=>b2.classList.add('show'),10); } else b2.style.display='none'; }
function hideControls() { document.getElementById('controls').innerHTML=''; }
function renderHand() { 
    const user = App.players.find(p => p.isUser);
    const d = document.getElementById('player-hand'); d.innerHTML=''; 
    if(!user || !user.hand) return;
    const h = user.hand; 
    if(App.gameId==='bigtwo') h.sort((a,b)=>getAbsVal(a)-getAbsVal(b));
    if(App.gameId==='doudizhu') h.sort((a,b)=>getDDZAbs(b)-getDDZAbs(a)); // 鬥地主倒序排列
    
    d.className = h.length < 5 ? 'my-hand few-cards' : 'my-hand'; 
    h.forEach(c => { 
        const el = document.createElement('div'); 
        if(c.type) { 
            let colorClass = `uno-${c.tempColor || c.color}`; el.className = `card uno ${colorClass}`; 
            let displayVal = c.val; if(c.type==='skip') displayVal = '⊘'; if(c.type==='reverse') displayVal = '⇄'; if(c.type==='draw2') displayVal = '+2'; 
            el.innerHTML = `<div class="uno-corner">${displayVal}</div><div class="card-center-uno">${displayVal}</div>`; 
            el.onclick = () => unoUserClick(c); 
        } else { 
            el.className = `card ${['♥','♦'].includes(c.s)?'red':'black'}`; 
            el.innerHTML = `<div class="card-corner"><div>${c.r}</div><div>${c.s}</div></div><div class="card-center-suit">${c.s}</div>`; 
            el.onclick = () => { c.sel=!c.sel; renderHand(); }; 
            if(c.sel) el.classList.add('selected'); 
        } 
        d.appendChild(el); 
    }); 
}
function renderTable(cards) { const d=document.getElementById('table-cards'); d.innerHTML=''; cards.forEach(c=>{ const el=document.createElement('div'); if(c.type) { let colorClass = `uno-${c.tempColor || c.color}`; el.className = `card uno ${colorClass}`; let displayVal = c.val; if(c.type==='skip') displayVal = '⊘'; if(c.type==='reverse') displayVal = '⇄'; if(c.type==='draw2') displayVal = '+2'; el.innerHTML = `<div class="uno-corner">${displayVal}</div><div class="card-center-uno">${displayVal}</div>`; } else { el.className=`card ${['♥','♦'].includes(c.s)?'red':'black'}`; el.innerHTML = `<div class="card-corner"><div>${c.r}</div><div>${c.s}</div></div><div class="card-center-suit">${c.s}</div>`; } d.appendChild(el); }); }
function updateOpponentVisuals() {
    const btn = document.querySelector('.fixed-uno-btn');
    const user = App.players.find(p => p.isUser);
    if (btn) { 
        if (user && user.unoSaid) { btn.classList.add('said'); btn.innerText = "SAFE"; } 
        else { btn.classList.remove('said'); btn.innerText = "UNO!"; } 
    }
    const uBadge = document.getElementById('player-badge'); if(uBadge) { if(user && user.unoSaid) uBadge.classList.add('show'); else uBadge.classList.remove('show'); } 
    
    // 遍歷所有非玩家角色
    App.players.forEach((p, i) => {
        if(p.isUser) return;
        if(App.gameId === 'oldmaid' || App.gameId === 'uno') { 
            const c = document.getElementById(`mini-hand-${i}`); 
            if(c) { c.innerHTML = ''; const count = Math.min(p.hand.length, 25); for(let j=0; j<count; j++) { let cls = 'mini-card'; if(App.gameId === 'uno') cls += ' uno-back'; c.innerHTML += `<div class="${cls}"></div>`; } if(p.hand.length > 25) { c.innerHTML += `<div style="font-size:0.6rem;color:#fff;align-self:center">+${p.hand.length-25}</div>`; } } 
            const b = document.getElementById(`uno-badge-${i}`); if(b) { if(p.unoSaid) b.classList.add('show'); else b.classList.remove('show'); } 
        } 
        if(App.gameId === 'bigtwo' || App.gameId === 'doudizhu') { 
            const b = document.getElementById(`count-badge-${i}`); 
            if(b) b.innerText = p.hand.length; 
        } 
        // 鬥地主身份帽
        if(App.gameId === 'doudizhu') {
            const r = document.getElementById(`role-${i}`);
            if(r) { 
                if(p.role==='landlord') { r.className='role-badge role-landlord show'; r.innerText='地'; }
                else { r.className='role-badge role-peasant show'; r.innerText='農'; }
            }
        }
    });
}
function showResult(win, amt, msg="") { 
    const m = document.getElementById('modal-result'); 
    if(win === 'push') { document.getElementById('res-title').innerText="PUSH"; document.getElementById('res-title').style.color="#fff"; updateScore(amt); } 
    else if(win) { App.wins++; document.getElementById('res-title').innerText="VICTORY"; document.getElementById('res-title').style.color="var(--gold)"; sfx('sfx-win'); updateScore(amt); } 
    else { App.losses++; document.getElementById('res-title').innerText="DEFEAT"; document.getElementById('res-title').style.color="#888"; updateScore(amt); } 
    let fullMsg = (amt>0?"+":"") + amt + " Coins"; 
    if(msg) fullMsg += `<br><span style='font-size:0.8rem;color:#aaa'>${msg}</span>`; 
    document.getElementById('res-msg').innerHTML = fullMsg; 
    updateUI(); 
    m.style.display = 'flex'; 
}</script>